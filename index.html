<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>勤務実績表自動作成システム</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .drag-over {
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.1);
        }
        .calculation-box {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 12px;
            padding: 16px;
            color: white;
            margin: 16px 0;
        }
        .summary-card {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        .part-time-card {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        .editable-time {
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.2s ease;
            display: inline-block;
            min-width: 90px;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 2px solid #42a5f5;
            position: relative;
            font-weight: 700;
            color: #0d47a1;
            font-size: 15px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(66, 165, 245, 0.3);
        }
        .editable-time:hover {
            background: linear-gradient(135deg, #bbdefb 0%, #90caf9 100%);
            border-color: #1976d2;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(66, 165, 245, 0.4);
        }
        .editable-time:before {
            content: '📝';
            position: absolute;
            right: 4px;
            top: 2px;
            font-size: 12px;
            opacity: 0.7;
        }
        .editable-time:hover:before {
            opacity: 1;
        }
        .editable-time-unset {
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.2s ease;
            display: inline-block;
            min-width: 90px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid #d6d8db;
            position: relative;
            font-weight: 400;
            color: #6c757d;
            font-size: 14px;
            text-align: center;
            box-shadow: none;
        }
        .editable-time-unset:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            border-color: #adb5bd;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .editable-time-unset:before {
            content: '✏️';
            position: absolute;
            right: 4px;
            top: 2px;
            font-size: 10px;
            opacity: 0.5;
        }
        .editable-time-unset:hover:before {
            opacity: 0.8;
        }
        .time-input {
            border: 3px solid #1976d2;
            border-radius: 8px;
            padding: 10px 16px;
            font-size: 15px;
            font-family: inherit;
            width: 120px;
            text-align: center;
            background: linear-gradient(135deg, #fff 0%, #f3f8ff 100%);
            box-shadow: 0 4px 16px rgba(25, 118, 210, 0.4);
            font-weight: 700;
            color: #0d47a1;
            outline: none;
        }
        .time-input:focus {
            border-color: #0d47a1;
            box-shadow: 0 6px 20px rgba(25, 118, 210, 0.5);
            transform: scale(1.05);
        }
         {
            body { margin: 0; }
            .no-print { display: none; }
        }
        .export-buttons {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 24px;
            margin: 24px 0;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .export-button {
            min-width: 200px;
            padding: 16px 24px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(0);
        }
        .export-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        .export-button:active {
            transform: translateY(0);
        }
        .settings-import-export {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
        }
        .period-setting {
            background: linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 100%);
            border: 2px solid #8b5cf6;
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
        }
        .holiday-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            transform: scale(1.2);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl shadow-lg mb-8">
            <div class="p-8 text-center">
                <h1 class="text-4xl font-bold mb-4">
                    <i class="fas fa-calculator mr-3"></i>勤務実績表自動作成システム
                </h1>
                <p class="text-xl opacity-90">タイムカードのCSVファイルから自動で勤務実績表を作成します</p>
            </div>
        </div>

        <!-- File Upload Section -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div id="uploadArea" class="border-3 border-dashed border-gray-300 rounded-lg p-12 text-center cursor-pointer transition-all hover:border-blue-400 hover:bg-blue-50">
                <i class="fas fa-file-upload text-6xl text-gray-400 mb-4"></i>
                <p class="text-xl text-gray-600 mb-4">CSVファイルをドラッグ&ドロップするか、クリックして選択してください</p>
                <input type="file" id="fileInput" accept=".csv" class="hidden">
                <div class="flex justify-center gap-4">
                    <button onclick="document.getElementById('fileInput').click()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-folder-open mr-2"></i>ファイルを選択
                    </button>
                    <button onclick="clearFileSelection()" class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition-colors">
                        <i class="fas fa-times mr-2"></i>クリア
                    </button>
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Basic Settings -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-user-cog mr-3 text-blue-600"></i>基本設定
                </h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">氏名</label>
                        <input type="text" id="employeeName" placeholder="山田太郎" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">対象年月</label>
                        <input type="month" id="targetMonth" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <!-- Period Setting -->
                    <div class="period-setting">
                        <h4 class="text-lg font-semibold text-purple-800 mb-3 flex items-center">
                            <i class="fas fa-calendar-alt mr-2"></i>対象期間設定
                        </h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-medium text-purple-700 mb-1">開始日</label>
                                <input type="date" id="periodStartDate" onchange="generatePeriodAndMergeData()" class="w-full px-3 py-2 border border-purple-300 rounded focus:ring-2 focus:ring-purple-500 text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-purple-700 mb-1">終了日</label>
                                <input type="date" id="periodEndDate" onchange="generatePeriodAndMergeData()" class="w-full px-3 py-2 border border-purple-300 rounded focus:ring-2 focus:ring-purple-500 text-sm">
                            </div>
                        </div>
                        <p class="text-xs text-purple-600 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>期間を設定すると、該当期間のすべての日付を表示し、CSVデータを自動入力します
                        </p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">勤務形態</label>
                        <select id="employmentType" onchange="toggleHourlyWage()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="fulltime">常勤</option>
                            <option value="parttime">パート</option>
                        </select>
                    </div>
                    <div id="hourlyWageContainer" class="hidden">
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <label class="block text-sm font-medium text-yellow-800 mb-2">
                                <i class="fas fa-yen-sign mr-2"></i>時給 (円/時)
                            </label>
                            <input type="number" id="hourlyWage" value="1000" min="0" placeholder="1000" onchange="recalculateIfNeeded()" class="w-full px-4 py-2 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bulk Settings -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-cogs mr-3 text-blue-600"></i>一括設定
                </h3>
                
                <!-- Settings Import/Export -->
                <div class="settings-import-export mb-4">
                    <h4 class="text-lg font-semibold text-amber-800 mb-3 flex items-center">
                        <i class="fas fa-download mr-2"></i>設定の保存・読み込み
                    </h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <button onclick="exportSettings()" class="bg-amber-600 text-white py-2 px-4 rounded-lg hover:bg-amber-700 transition-colors text-sm">
                            <i class="fas fa-file-export mr-2"></i>設定エクスポート
                        </button>
                        <div class="relative">
                            <input type="file" id="settingsFileInput" accept=".json" onchange="importSettings()" class="hidden">
                            <button onclick="document.getElementById('settingsFileInput').click()" class="w-full bg-amber-600 text-white py-2 px-4 rounded-lg hover:bg-amber-700 transition-colors text-sm">
                                <i class="fas fa-file-import mr-2"></i>設定インポート
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Common Settings -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                    <h4 class="text-lg font-semibold text-blue-800 mb-4">全曜日共通設定</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-blue-700 mb-1">残業開始時間</label>
                            <input type="time" id="bulkOvertimeStart" value="18:00" class="w-full px-3 py-2 border border-blue-300 rounded focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-blue-700 mb-1">休憩時間(分)</label>
                            <input type="number" id="bulkBreakTime" value="60" min="0" class="w-full px-3 py-2 border border-blue-300 rounded focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="sm:col-span-2">
                            <label class="block text-sm font-medium text-blue-700 mb-1">残業単価(円/時)</label>
                            <input type="number" id="bulkOvertimeRate" value="1500" min="0" class="w-full px-3 py-2 border border-blue-300 rounded focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <button onclick="applyBulkSettings()" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-sync mr-2"></i>全曜日に適用
                    </button>
                </div>

                <!-- Attendance Correction -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <h4 class="text-lg font-semibold text-green-800 mb-2 flex items-center">
                        <i class="fas fa-clock mr-2"></i>時刻一括変更
                    </h4>
                    <p class="text-sm text-green-700 mb-3">基準時刻より早く/遅くに出勤/退勤した場合は、一括で指定した時刻に変更します。</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 mb-3">
                        <div>
                            <label class="block text-sm font-medium text-green-700 mb-1">対象時刻</label>
                            <select id="correctionTimeType" class="w-full px-3 py-2 border border-green-300 rounded focus:ring-2 focus:ring-green-500">
                                <option value="startTime">出勤時間</option>
                                <option value="endTime">退勤時間</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-green-700 mb-1">基準時刻</label>
                            <input type="time" id="correctionBaseTime" value="09:00" class="w-full px-3 py-2 border border-green-300 rounded focus:ring-2 focus:ring-green-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-green-700 mb-1">変更条件</label>
                            <select id="correctionCondition" class="w-full px-3 py-2 border border-green-300 rounded focus:ring-2 focus:ring-green-500">
                                <option value="later">より遅い場合</option>
                                <option value="earlier">より早い場合</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-green-700 mb-1">変更後時刻</label>
                            <input type="time" id="correctionNewTime" value="09:00" class="w-full px-3 py-2 border border-green-300 rounded focus:ring-2 focus:ring-green-500">
                        </div>
                    </div>
                    <div class="bg-green-100 border border-green-200 rounded p-2 mb-3">
                        <p class="text-xs text-green-700">
                            <i class="fas fa-info-circle mr-1"></i>
                            例: 「出勤時間」で基準時刻「09:00」より「遅い場合」を「08:30」に変更
                        </p>
                    </div>
                    <button onclick="applyCorrectionTime()" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                        <i class="fas fa-edit mr-2"></i>一括変更実行
                    </button>
                </div>
            </div>
        </div>

        <!-- Day Settings -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-calendar-week mr-3 text-blue-600"></i>曜日別詳細設定
            </h3>
            <div id="daySettings" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                <!-- Day cards will be generated here -->
            </div>
        </div>

        <!-- Results Section -->
        <div id="results" class="hidden">
            <!-- Summary Cards -->
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-chart-line mr-3 text-green-600"></i>勤務実績表
                </h2>
                <div id="summaryCards" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <!-- Summary cards will be generated here -->
                </div>
            </div>

            <!-- Calculation Formula -->
            <div id="calculationFormula" class="hidden mb-6">
                <!-- Calculation formula will be shown here -->
            </div>

            <!-- Data Table -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
                <div class="overflow-x-auto">
                    <table id="resultsTable" class="w-full">
                        <!-- Table will be generated here -->
                    </table>
                </div>
            </div>

            <!-- Export Buttons -->
            <div class="export-buttons no-print">
                <div class="text-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center justify-center">
                        <i class="fas fa-download mr-2"></i>ファイルエクスポート
                    </h3>
                    <p class="text-gray-600 text-sm mt-1">勤務実績表をファイル形式で保存できます</p>
                </div>
                <div class="flex flex-wrap justify-center gap-6">
                    <button onclick="exportToExcel()" class="export-button bg-green-600 text-white hover:bg-green-700 flex items-center justify-center">
                        <i class="fas fa-file-excel mr-3 text-xl"></i>
                        <span>Excelエクスポート</span>
                    </button>
                    <button onclick="exportToCSV()" class="export-button bg-green-600 text-white hover:bg-green-700 flex items-center justify-center">
                        <i class="fas fa-file-csv mr-3 text-xl"></i>
                        <span>CSVエクスポート</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Messages -->
        <div id="messageContainer"></div>
    </div>

    <script>
        // Global variables
        let csvData = [];
        let originalCsvData = [];
        let processedData = [];
        let allPeriodData = [];
        let summaryData = {
            workDays: 0,
            holidayWorkDays: 0,
            totalOvertimeMinutes: 0,
            totalOvertimeCost: 0,
            totalWorkMinutes: 0,
            totalSalary: 0
        };
        let daySettings = {
            '月': { overtimeStart: '18:00', breakTime: 60, overtimeRate: 1500 },
            '火': { overtimeStart: '18:00', breakTime: 60, overtimeRate: 1500 },
            '水': { overtimeStart: '18:00', breakTime: 60, overtimeRate: 1500 },
            '木': { overtimeStart: '18:00', breakTime: 60, overtimeRate: 1500 },
            '金': { overtimeStart: '18:00', breakTime: 60, overtimeRate: 1500 },
            '土': { overtimeStart: '18:00', breakTime: 60, overtimeRate: 1500 },
            '日': { overtimeStart: '18:00', breakTime: 60, overtimeRate: 1500 }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeDaySettings();
            setupEventListeners();
            setDefaultMonth();
            setDefaultPeriod();
        });

        function setDefaultMonth() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            document.getElementById('targetMonth').value = `${year}-${month}`;
        }

        function setDefaultPeriod() {
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            
            // Set to current month's first and last day
            const startDate = new Date(year, month, 1);
            const endDate = new Date(year, month + 1, 0);
            
            document.getElementById('periodStartDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('periodEndDate').value = endDate.toISOString().split('T')[0];
            
            // Generate initial period data
            generatePeriodAndMergeData();
        }

        function generatePeriodAndMergeData() {
            const startDate = document.getElementById('periodStartDate').value;
            const endDate = document.getElementById('periodEndDate').value;

            if (!startDate || !endDate) {
                return;
            }

            // Generate all dates in the period
            allPeriodData = [];
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            if (start > end) {
                showMessage('開始日は終了日より前の日付を選択してください', 'error');
                return;
            }
            
            let currentDate = new Date(start);
            while (currentDate <= end) {
                const dateString = currentDate.toISOString().split('T')[0];
                allPeriodData.push({
                    date: dateString,
                    workClass: '',
                    workType: '',
                    startTime: '',
                    endTime: '',
                    breakTime: '',
                    breakDuration: '', // 個別の休憩時間
                    overtime: '',
                    vacation: '',
                    isHolidayWork: false
                });
                currentDate.setDate(currentDate.getDate() + 1);
            }

            // Merge with CSV data if available
            if (originalCsvData.length > 0) {
                mergeCSVWithPeriodData();
            }

            // Process and display
            csvData = [...allPeriodData];
            processData();
            document.getElementById('results').classList.remove('hidden');
            
            showMessage(`期間 ${startDate} ～ ${endDate} の${allPeriodData.length}日間を表示しています`, 'success');
        }

        function mergeCSVWithPeriodData() {
            // Create a map of CSV data by date for quick lookup
            const csvDataMap = {};
            originalCsvData.forEach(row => {
                if (row.date) {
                    // Normalize date format - handle various formats
                    let normalizedDate = row.date;
                    
                    // Handle different date formats
                    if (normalizedDate.match(/^\d{4}\/\d{1,2}\/\d{1,2}$/)) {
                        // Convert YYYY/M/D to YYYY-MM-DD
                        const parts = normalizedDate.split('/');
                        normalizedDate = parts[0] + '-' + parts[1].padStart(2, '0') + '-' + parts[2].padStart(2, '0');
                    } else if (normalizedDate.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                        // Convert M/D/YYYY to YYYY-MM-DD
                        const parts = normalizedDate.split('/');
                        normalizedDate = parts[2] + '-' + parts[0].padStart(2, '0') + '-' + parts[1].padStart(2, '0');
                    } else if (normalizedDate.match(/^\d{4}-\d{1,2}-\d{1,2}$/)) {
                        // Convert YYYY-M-D to YYYY-MM-DD
                        const parts = normalizedDate.split('-');
                        normalizedDate = parts[0] + '-' + parts[1].padStart(2, '0') + '-' + parts[2].padStart(2, '0');
                    }
                    
                    csvDataMap[normalizedDate] = { ...row, date: normalizedDate };
                }
            });

            // Merge CSV data with period data
            allPeriodData.forEach(periodRow => {
                const csvRow = csvDataMap[periodRow.date];
                if (csvRow) {
                    // Merge CSV data into period data, preserving the period date format
                    Object.assign(periodRow, csvRow, { date: periodRow.date });
                }
            });
        }

        function initializeDaySettings() {
            const container = document.getElementById('daySettings');
            const days = ['月', '火', '水', '木', '金', '土', '日'];
            
            container.innerHTML = '';
            
            days.forEach(day => {
                const dayCard = document.createElement('div');
                dayCard.className = 'bg-gray-50 border border-gray-200 rounded-lg p-4';
                dayCard.innerHTML = `
                    <h4 class="font-semibold text-gray-800 mb-3 text-center">${day}曜日</h4>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">残業開始時間</label>
                            <input type="time" id="overtime-${day}" value="${daySettings[day].overtimeStart}" 
                                   onchange="updateDaySetting('${day}', 'overtimeStart', this.value)" 
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">休憩時間(分)</label>
                            <input type="number" id="break-${day}" value="${daySettings[day].breakTime}" min="0"
                                   onchange="updateDaySetting('${day}', 'breakTime', this.value)" 
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">残業単価(円/時)</label>
                            <input type="number" id="rate-${day}" value="${daySettings[day].overtimeRate}" min="0"
                                   onchange="updateDaySetting('${day}', 'overtimeRate', this.value)" 
                                   class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500">
                        </div>
                    </div>
                `;
                container.appendChild(dayCard);
            });
        }

        function setupEventListeners() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });

            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });

            uploadArea.addEventListener('click', (e) => {
                // Only trigger file input if clicking on upload area but not on buttons
                if (!e.target.closest('button')) {
                    fileInput.click();
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });
        }

        function clearFileSelection() {
            // Clear file input
            const fileInput = document.getElementById('fileInput');
            fileInput.value = '';
            
            // Reset data arrays
            csvData = [];
            originalCsvData = [];
            processedData = [];
            
            // Reset summary data
            summaryData = {
                workDays: 0,
                holidayWorkDays: 0,
                totalOvertimeMinutes: 0,
                totalOvertimeCost: 0,
                totalWorkMinutes: 0,
                totalSalary: 0
            };
            
            // Hide results section
            document.getElementById('results').classList.add('hidden');
            
            // Regenerate period data if period is set
            generatePeriodAndMergeData();
            
            // Show success message
            showMessage('ファイル選択をクリアしました', 'success');
        }

        // Settings Export/Import Functions
        function exportSettings() {
            const settings = {
                bulkSettings: {
                    overtimeStart: document.getElementById('bulkOvertimeStart').value,
                    breakTime: parseInt(document.getElementById('bulkBreakTime').value) || 60,
                    overtimeRate: parseInt(document.getElementById('bulkOvertimeRate').value) || 1500
                },
                daySettings: { ...daySettings },
                periodSettings: {
                    startDate: document.getElementById('periodStartDate').value,
                    endDate: document.getElementById('periodEndDate').value
                }
            };

            const settingsJson = JSON.stringify(settings, null, 2);
            const blob = new Blob([settingsJson], { type: 'application/json' });
            
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', '勤務実績表設定.json');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('設定をエクスポートしました', 'success');
        }

        function importSettings() {
            const fileInput = document.getElementById('settingsFileInput');
            const file = fileInput.files[0];
            
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.json')) {
                showMessage('JSONファイルを選択してください', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const settings = JSON.parse(e.target.result);
                    
                    // Validate settings structure
                    if (!settings.bulkSettings || !settings.daySettings) {
                        throw new Error('設定ファイルの形式が正しくありません');
                    }

                    // Apply bulk settings
                    if (settings.bulkSettings.overtimeStart) {
                        document.getElementById('bulkOvertimeStart').value = settings.bulkSettings.overtimeStart;
                    }
                    if (settings.bulkSettings.breakTime !== undefined) {
                        document.getElementById('bulkBreakTime').value = settings.bulkSettings.breakTime;
                    }
                    if (settings.bulkSettings.overtimeRate !== undefined) {
                        document.getElementById('bulkOvertimeRate').value = settings.bulkSettings.overtimeRate;
                    }

                    // Apply period settings
                    if (settings.periodSettings) {
                        if (settings.periodSettings.startDate) {
                            document.getElementById('periodStartDate').value = settings.periodSettings.startDate;
                        }
                        if (settings.periodSettings.endDate) {
                            document.getElementById('periodEndDate').value = settings.periodSettings.endDate;
                        }
                    }

                    // Apply day settings
                    const days = ['月', '火', '水', '木', '金', '土', '日'];
                    days.forEach(day => {
                        if (settings.daySettings[day]) {
                            daySettings[day] = { ...settings.daySettings[day] };
                            
                            // Update UI elements
                            const overtimeInput = document.getElementById(`overtime-${day}`);
                            const breakInput = document.getElementById(`break-${day}`);
                            const rateInput = document.getElementById(`rate-${day}`);
                            
                            if (overtimeInput) overtimeInput.value = daySettings[day].overtimeStart;
                            if (breakInput) breakInput.value = daySettings[day].breakTime;
                            if (rateInput) rateInput.value = daySettings[day].overtimeRate;
                        }
                    });

                    // Regenerate period and merge if needed
                    generatePeriodAndMergeData();

                    showMessage('設定をインポートしました', 'success');
                    
                } catch (error) {
                    showMessage('設定ファイルの読み込みに失敗しました: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(file, 'UTF-8');
            
            // Clear file input
            fileInput.value = '';
        }

        function toggleHourlyWage() {
            const employmentType = document.getElementById('employmentType').value;
            const container = document.getElementById('hourlyWageContainer');
            
            if (employmentType === 'parttime') {
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
            
            if (processedData.length > 0) {
                processData();
            }
        }

        function recalculateIfNeeded() {
            if (processedData.length > 0 && document.getElementById('employmentType').value === 'parttime') {
                processData();
            }
        }

        function updateDaySetting(day, setting, value) {
            daySettings[day][setting] = setting === 'breakTime' || setting === 'overtimeRate' ? 
                                      parseInt(value) || 0 : value;
            
            if (allPeriodData.length > 0) {
                processData();
            }
        }

        function applyBulkSettings() {
            const overtimeStart = document.getElementById('bulkOvertimeStart').value;
            const breakTime = parseInt(document.getElementById('bulkBreakTime').value) || 60;
            const overtimeRate = parseInt(document.getElementById('bulkOvertimeRate').value) || 1500;

            const days = ['月', '火', '水', '木', '金', '土', '日'];
            
            days.forEach(day => {
                daySettings[day].overtimeStart = overtimeStart;
                daySettings[day].breakTime = breakTime;
                daySettings[day].overtimeRate = overtimeRate;
                
                document.getElementById(`overtime-${day}`).value = overtimeStart;
                document.getElementById(`break-${day}`).value = breakTime;
                document.getElementById(`rate-${day}`).value = overtimeRate;
            });

            showMessage('全曜日の設定を更新しました', 'success');
            
            if (allPeriodData.length > 0) {
                processData();
            }
        }

        function applyCorrectionTime() {
            const timeType = document.getElementById('correctionTimeType').value;
            const baseTime = document.getElementById('correctionBaseTime').value;
            const newTime = document.getElementById('correctionNewTime').value;
            const condition = document.getElementById('correctionCondition').value;
            
            if (!baseTime) {
                showMessage('基準時刻を入力してください', 'error');
                return;
            }

            if (!newTime) {
                showMessage('変更後時刻を入力してください', 'error');
                return;
            }

            if (allPeriodData.length === 0) {
                showMessage('先に対象期間を設定してください', 'error');
                return;
            }

            const baseMinutes = timeToMinutes(baseTime);
            const newMinutes = timeToMinutes(newTime);
            
            if (baseMinutes === null) {
                showMessage('有効な基準時刻を入力してください', 'error');
                return;
            }

            if (newMinutes === null) {
                showMessage('有効な変更後時刻を入力してください', 'error');
                return;
            }

            let changedCount = 0;
            let eligibleRows = 0;

            // Apply correction to current period data
            allPeriodData.forEach((row, index) => {
                // Check the selected time type
                const targetTime = row[timeType];
                
                if (targetTime && targetTime.trim() !== '' && targetTime !== '---') {
                    eligibleRows++;
                    
                    const targetMinutes = timeToMinutes(targetTime);
                    if (targetMinutes !== null) {
                        let shouldChange = false;
                        
                        // Check condition: later (遅く) or earlier (早く)
                        if (condition === 'later' && targetMinutes > baseMinutes) {
                            shouldChange = true;
                        } else if (condition === 'earlier' && targetMinutes < baseMinutes) {
                            shouldChange = true;
                        }
                        
                        if (shouldChange) {
                            const oldTime = row[timeType];
                            row[timeType] = newTime;
                            changedCount++;
                            
                            console.log(`Changed row ${index} ${timeType}: ${oldTime} → ${newTime}`);
                            
                            // Also update original CSV data if it exists
                            const originalIndex = originalCsvData.findIndex(orig => 
                                normalizeDate(orig.date) === normalizeDate(row.date)
                            );
                            
                            if (originalIndex !== -1) {
                                originalCsvData[originalIndex][timeType] = newTime;
                            }
                        }
                    }
                }
            });

            console.log(`Eligible rows: ${eligibleRows}, Changed: ${changedCount}`);

            if (changedCount > 0) {
                // Update csvData to maintain consistency
                csvData = [...allPeriodData];
                
                // Trigger recalculation
                processData();
                
                const timeTypeName = timeType === 'startTime' ? '出勤時間' : '退勤時間';
                const conditionText = condition === 'later' ? 'より遅い' : 'より早い';
                showMessage(`${changedCount}件の${timeTypeName}を${newTime}に変更しました（基準時刻${baseTime}${conditionText}時刻）`, 'success');
            } else {
                if (eligibleRows === 0) {
                    const timeTypeName = timeType === 'startTime' ? '出勤時間' : '退勤時間';
                    showMessage(`${timeTypeName}が入力されているデータがありません`, 'error');
                } else {
                    const timeTypeName = timeType === 'startTime' ? '出勤時間' : '退勤時間';
                    const conditionText = condition === 'later' ? 'より遅い' : 'より早い';
                    showMessage(`基準時刻${baseTime}${conditionText}${timeTypeName}がありませんでした`, 'error');
                }
            }
        }

        function handleFile(file) {
            if (!file.name.toLowerCase().endsWith('.csv')) {
                showMessage('CSVファイルを選択してください', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    parseCSV(e.target.result);
                } catch (error) {
                    showMessage('ファイルの読み込みに失敗しました: ' + error.message, 'error');
                }
            };
            reader.readAsText(file, 'Shift_JIS');
        }

        function parseCSV(text) {
            const lines = text.split('\n').filter(line => line.trim());
            
            if (lines.length < 2) {
                showMessage('有効なデータが見つかりません', 'error');
                return;
            }

            originalCsvData = [];
            
            for (let i = 1; i < lines.length; i++) {
                const cells = lines[i].split(',').map(cell => cell.replace(/"/g, '').trim());
                
                if (cells.length >= 8) {
                    originalCsvData.push({
                        date: cells[0] || '',
                        workClass: cells[1] || '',
                        workType: cells[2] || '',
                        startTime: cells[3] || '',
                        endTime: cells[4] || '',
                        breakTime: cells[5] || '',
                        breakDuration: cells[5] || '', // CSVの休憩時間列から個別休憩時間を読み込み
                        overtime: cells[6] || '',
                        vacation: cells[7] || '',
                        isHolidayWork: false
                    });
                }
            }

            if (originalCsvData.length === 0) {
                showMessage('有効なデータが見つかりません', 'error');
                return;
            }

            showMessage(`${originalCsvData.length}件のデータを読み込みました`, 'success');
            
            // Merge with period data and process
            generatePeriodAndMergeData();
        }

        function processData() {
            if (!allPeriodData || allPeriodData.length === 0) {
                return;
            }

            // Update csvData from allPeriodData to ensure consistency
            csvData = [...allPeriodData];

            processedData = [];
            let workDays = 0;
            let holidayWorkDays = 0;
            let totalOvertimeMinutes = 0;
            let totalOvertimeCost = 0;
            let totalWorkMinutes = 0;
            let totalBasicSalary = 0;

            const isPartTime = document.getElementById('employmentType').value === 'parttime';
            const hourlyWage = parseInt(document.getElementById('hourlyWage').value) || 1000;

            allPeriodData.forEach((row, index) => {
                if (!row.date) return;

                const date = new Date(row.date);
                const dayOfWeek = ['日', '月', '火', '水', '木', '金', '土'][date.getDay()];
                
                let displayStartTime = row.startTime || '';
                let displayEndTime = row.endTime || '';
                
                let actualWorkTime = '';
                let overtimeHours = '';
                let overtimeCost = 0;
                let basicSalary = 0;

                // Only calculate if both start and end times exist
                if (displayStartTime && displayEndTime && displayStartTime !== '---' && displayEndTime !== '---' && 
                    displayStartTime !== '' && displayEndTime !== '') {
                    
                    // Fixed: Count holiday work and work days separately
                    if (row.isHolidayWork) {
                        holidayWorkDays++;
                    } else {
                        workDays++;  // Only count as regular work day if NOT holiday work
                    }

                    const startMinutes = timeToMinutes(displayStartTime);
                    const endMinutes = timeToMinutes(displayEndTime);
                    
                    if (startMinutes !== null && endMinutes !== null && endMinutes > startMinutes) {
                        // Get break time - prioritize individual row's breakDuration, fallback to day setting
                        let breakMinutes = 0;
                        if (row.breakDuration && row.breakDuration !== '' && row.breakDuration !== '---') {
                            // Convert break duration from various formats to minutes
                            breakMinutes = parseBreakDuration(row.breakDuration);
                        } else {
                            // Fallback to day setting
                            breakMinutes = parseInt(daySettings[dayOfWeek]?.breakTime) || 60;
                        }
                        
                        // Calculate actual work time (total time - break time)
                        const totalMinutes = endMinutes - startMinutes;
                        const actualWorkMinutes = Math.max(0, totalMinutes - breakMinutes);
                        
                        if (actualWorkMinutes > 0) {
                            actualWorkTime = minutesToTime(actualWorkMinutes);
                            totalWorkMinutes += actualWorkMinutes;

                            // Calculate basic salary for part-time workers
                            if (isPartTime) {
                                basicSalary = Math.round((actualWorkMinutes / 60) * hourlyWage);
                                totalBasicSalary += basicSalary;
                            }

                            // Calculate overtime
                            const overtimeStartMinutes = timeToMinutes(daySettings[dayOfWeek]?.overtimeStart || '18:00');
                            if (endMinutes > overtimeStartMinutes) {
                                const overtimeMinutes = Math.max(0, endMinutes - overtimeStartMinutes);
                                if (overtimeMinutes > 0) {
                                    overtimeHours = minutesToTime(overtimeMinutes);
                                    
                                    const overtimeRate = parseInt(daySettings[dayOfWeek]?.overtimeRate) || 1500;
                                    overtimeCost = Math.round((overtimeMinutes / 60) * overtimeRate);
                                    
                                    totalOvertimeMinutes += overtimeMinutes;
                                    totalOvertimeCost += overtimeCost;
                                }
                            }
                        }
                    }
                }

                processedData.push({
                    index: index,
                    date: row.date,
                    dayOfWeek: dayOfWeek,
                    startTime: displayStartTime,
                    endTime: displayEndTime,
                    breakDuration: row.breakDuration || '', // 個別休憩時間を追加
                    actualWorkTime: actualWorkTime,
                    overtimeHours: overtimeHours,
                    overtimeCost: overtimeCost,
                    basicSalary: basicSalary,
                    isHolidayWork: row.isHolidayWork || false
                });
            });

            summaryData = {
                workDays: workDays,
                holidayWorkDays: holidayWorkDays,
                totalOvertimeMinutes: totalOvertimeMinutes,
                totalOvertimeCost: totalOvertimeCost,
                totalWorkMinutes: totalWorkMinutes,
                totalBasicSalary: totalBasicSalary,
                totalSalary: totalBasicSalary + totalOvertimeCost
            };

            updateSummary();
            updateCalculationFormula();
            updateTable();
            document.getElementById('results').classList.remove('hidden');
        }

        function timeToMinutes(timeStr) {
            if (!timeStr || timeStr === '---' || timeStr === '') return null;
            
            const parts = timeStr.split(':');
            if (parts.length !== 2) return null;
            
            const hours = parseInt(parts[0]);
            const minutes = parseInt(parts[1]);
            
            if (isNaN(hours) || isNaN(minutes)) return null;
            
            return hours * 60 + minutes;
        }

        function minutesToTime(minutes) {
            if (minutes <= 0) return '';
            
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            
            return `${hours}時間${mins.toString().padStart(2, '0')}分`;
        }

        function updateSummary() {
            const container = document.getElementById('summaryCards');
            const isPartTime = document.getElementById('employmentType').value === 'parttime';
            
            let summaryHTML = `
                <div class="summary-card">
                    <h4 class="text-sm opacity-80 mb-2">出勤日数</h4>
                    <div class="text-2xl font-bold">${summaryData.workDays}日</div>
                </div>
                <div class="summary-card">
                    <h4 class="text-sm opacity-80 mb-2">休日出勤日数</h4>
                    <div class="text-2xl font-bold">${summaryData.holidayWorkDays}日</div>
                </div>
                <div class="summary-card">
                    <h4 class="text-sm opacity-80 mb-2">総残業時間</h4>
                    <div class="text-2xl font-bold">${minutesToTime(summaryData.totalOvertimeMinutes)}</div>
                </div>
                <div class="summary-card">
                    <h4 class="text-sm opacity-80 mb-2">総残業費用</h4>
                    <div class="text-2xl font-bold">¥${summaryData.totalOvertimeCost.toLocaleString()}</div>
                </div>
            `;

            if (isPartTime) {
                summaryHTML += `
                    <div class="summary-card">
                        <h4 class="text-sm opacity-80 mb-2">総実働時間</h4>
                        <div class="text-2xl font-bold">${minutesToTime(summaryData.totalWorkMinutes)}</div>
                    </div>
                    <div class="summary-card part-time-card">
                        <h4 class="text-sm opacity-80 mb-2">総支給額</h4>
                        <div class="text-2xl font-bold">¥${summaryData.totalSalary.toLocaleString()}</div>
                    </div>
                `;
            }

            container.innerHTML = summaryHTML;
        }

        function updateCalculationFormula() {
            const container = document.getElementById('calculationFormula');
            const isPartTime = document.getElementById('employmentType').value === 'parttime';
            
            if (isPartTime && summaryData.totalWorkMinutes > 0) {
                const hourlyWage = parseInt(document.getElementById('hourlyWage').value) || 1000;
                const totalHours = (summaryData.totalWorkMinutes / 60).toFixed(2);
                const overtimeHours = (summaryData.totalOvertimeMinutes / 60).toFixed(2);
                
                container.innerHTML = `
                    <div class="calculation-box">
                        <h4 class="text-xl font-bold mb-4 flex items-center">
                            <i class="fas fa-calculator mr-2"></i>総支給額計算式
                        </h4>
                        <div class="space-y-2 font-mono text-sm">
                            <div>基本給 = 総実働時間 × 時給</div>
                            <div>基本給 = ${totalHours}時間 × ${hourlyWage}円 = ¥${summaryData.totalBasicSalary.toLocaleString()}</div>
                            <div>残業代 = ${overtimeHours}時間 × 残業単価 = ¥${summaryData.totalOvertimeCost.toLocaleString()}</div>
                            <div class="border-t border-white/30 pt-2 font-bold text-lg">
                                総支給額 = ¥${summaryData.totalBasicSalary.toLocaleString()} + ¥${summaryData.totalOvertimeCost.toLocaleString()} = ¥${summaryData.totalSalary.toLocaleString()}
                            </div>
                        </div>
                    </div>
                `;
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        }

        function updateTable() {
            const table = document.getElementById('resultsTable');
            const isPartTime = document.getElementById('employmentType').value === 'parttime';
            
            let tableHTML = `
                <thead class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white">
                    <tr>
                        <th class="px-4 py-3 text-center">日付</th>
                        <th class="px-4 py-3 text-center">曜日</th>
                        <th class="px-4 py-3 text-center">休日出勤</th>
                        <th class="px-4 py-3 text-center">出勤時間</th>
                        <th class="px-4 py-3 text-center">退勤時間</th>
                        <th class="px-4 py-3 text-center">休憩時間</th>
                        <th class="px-4 py-3 text-center">実働時間</th>
                        <th class="px-4 py-3 text-center">残業時間</th>
                        <th class="px-4 py-3 text-center">残業費用</th>
            `;

            if (isPartTime) {
                tableHTML += '<th class="px-4 py-3 text-center">基本給</th>';
            }

            tableHTML += `
                    </tr>
                </thead>
                <tbody>
            `;

            processedData.forEach((row, index) => {
                const bgClass = index % 2 === 0 ? 'bg-gray-50' : 'bg-white';
                const startTimeDisplay = row.startTime || '';
                const endTimeDisplay = row.endTime || '';
                
                // Determine CSS class based on whether time is set or not
                const startTimeClass = startTimeDisplay ? 'editable-time' : 'editable-time-unset';
                const endTimeClass = endTimeDisplay ? 'editable-time' : 'editable-time-unset';
                const startTimeText = startTimeDisplay || '未設定';
                const endTimeText = endTimeDisplay || '未設定';
                
                tableHTML += `
                    <tr class="${bgClass} hover:bg-blue-50 transition-colors">
                        <td class="px-4 py-3 text-center">${row.date}</td>
                        <td class="px-4 py-3 text-center">${row.dayOfWeek}</td>
                        <td class="px-4 py-3 text-center">
                            <input type="checkbox" class="holiday-checkbox" data-row="${row.index}" onchange="updateHolidayWork(this)" ${row.isHolidayWork ? 'checked' : ''}>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <span class="${startTimeClass}" data-row="${row.index}" data-field="startTime" onclick="editTime(this)" title="クリックして時間を編集">${startTimeText}</span>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <span class="${endTimeClass}" data-row="${row.index}" data-field="endTime" onclick="editTime(this)" title="クリックして時間を編集">${endTimeText}</span>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <span class="${row.breakDuration ? 'editable-time' : 'editable-time-unset'}" data-row="${row.index}" data-field="breakDuration" onclick="editBreakDuration(this)" title="クリックして休憩時間を編集">${row.breakDuration || '未設定'}</span>
                        </td>
                        <td class="px-4 py-3 text-center">${row.actualWorkTime}</td>
                        <td class="px-4 py-3 text-center">${row.overtimeHours}</td>
                        <td class="px-4 py-3 text-center">${row.overtimeCost > 0 ? '¥' + row.overtimeCost.toLocaleString() : ''}</td>
                `;

                if (isPartTime) {
                    tableHTML += `<td class="px-4 py-3 text-center">${row.basicSalary > 0 ? '¥' + row.basicSalary.toLocaleString() : ''}</td>`;
                }

                tableHTML += '</tr>';
            });

            tableHTML += '</tbody>';
            table.innerHTML = tableHTML;
        }

        function updateHolidayWork(checkbox) {
            const rowIndex = parseInt(checkbox.dataset.row);
            
            if (rowIndex >= 0 && rowIndex < allPeriodData.length) {
                allPeriodData[rowIndex].isHolidayWork = checkbox.checked;
                
                // Update csvData to maintain consistency
                csvData = [...allPeriodData];
                
                // Trigger recalculation
                processData();
                
                const dateStr = allPeriodData[rowIndex].date;
                const status = checkbox.checked ? 'ON' : 'OFF';
                showMessage(`${dateStr} の休日出勤を${status}に設定しました`, 'success');
            }
        }

        // Enhanced manual editing functionality with proper calculation linking
        function editTime(element) {
            const currentValue = element.textContent.trim();
            const displayValue = currentValue === '未設定' ? '' : currentValue;
            
            // Create simple time input
            const input = document.createElement('input');
            input.type = 'time';
            input.value = displayValue;
            input.className = 'time-input';
            
            // Add event listeners for simple interaction
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveTimeEdit(element, this.value);
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelTimeEdit(element, currentValue);
                }
            });
            
            input.addEventListener('blur', function(e) {
                // Small delay to prevent conflicts
                setTimeout(() => {
                    if (document.contains(this)) {
                        saveTimeEdit(element, this.value);
                    }
                }, 100);
            });
            
            // Replace element content with input
            element.innerHTML = '';
            element.appendChild(input);
            
            // Focus and select
            input.focus();
            input.select();
        }

        function saveTimeEdit(element, newValue) {
            const rowIndex = parseInt(element.dataset.row);
            const field = element.dataset.field;
            
            // Validate row index
            if (rowIndex < 0 || rowIndex >= allPeriodData.length) {
                showMessage('データの更新に失敗しました: 無効な行インデックス', 'error');
                cancelTimeEdit(element, element.textContent || '未設定');
                return;
            }
            
            // Update data in allPeriodData (primary data source)
            if (allPeriodData[rowIndex] !== undefined) {
                const oldValue = allPeriodData[rowIndex][field];
                allPeriodData[rowIndex][field] = newValue;
                
                // Also update original CSV data if it exists
                const normalizeDate = (dateStr) => {
                    if (!dateStr) return '';
                    
                    if (dateStr.match(/^\d{4}\/\d{1,2}\/\d{1,2}$/)) {
                        const parts = dateStr.split('/');
                        return parts[0] + '-' + parts[1].padStart(2, '0') + '-' + parts[2].padStart(2, '0');
                    } else if (dateStr.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                        const parts = dateStr.split('/');
                        return parts[2] + '-' + parts[0].padStart(2, '0') + '-' + parts[1].padStart(2, '0');
                    } else if (dateStr.match(/^\d{4}-\d{1,2}-\d{1,2}$/)) {
                        const parts = dateStr.split('-');
                        return parts[0] + '-' + parts[1].padStart(2, '0') + '-' + parts[2].padStart(2, '0');
                    }
                    return dateStr;
                };
                
                const originalRow = originalCsvData.find(row => {
                    return normalizeDate(row.date) === normalizeDate(allPeriodData[rowIndex].date);
                });
                
                if (originalRow) {
                    originalRow[field] = newValue;
                }
                
                // Update csvData to maintain consistency
                csvData = [...allPeriodData];
                
                try {
                    // Trigger full recalculation
                    processData();
                    
                    // Show confirmation message
                    const fieldName = field === 'startTime' ? '出勤時間' : '退勤時間';
                    const timeDisplay = newValue || '未設定';
                    showMessage(`✅ ${allPeriodData[rowIndex].date} の${fieldName}を「${timeDisplay}」に更新しました`, 'success');
                    
                } catch (error) {
                    // Rollback on error
                    allPeriodData[rowIndex][field] = oldValue;
                    if (originalRow) {
                        originalRow[field] = oldValue;
                    }
                    csvData = [...allPeriodData];
                    processData();
                    
                    showMessage('計算中にエラーが発生しました: ' + error.message, 'error');
                }
                
            } else {
                showMessage('データの更新に失敗しました: データが見つかりません', 'error');
                cancelTimeEdit(element, element.textContent || '未設定');
            }
        }

        function cancelTimeEdit(element, originalValue) {
            element.innerHTML = originalValue;
        }

        function exportToExcel() {
            if (processedData.length === 0) {
                showMessage('エクスポートするデータがありません', 'error');
                return;
            }

            const employeeName = document.getElementById('employeeName').value || '従業員';
            const targetMonth = document.getElementById('targetMonth').value;
            const employmentType = document.getElementById('employmentType').value === 'parttime' ? 'パート' : '常勤';
            const hourlyWage = document.getElementById('hourlyWage').value;
            const startDate = document.getElementById('periodStartDate').value;
            const endDate = document.getElementById('periodEndDate').value;
            const fileName = `${employeeName}_${targetMonth.replace('-', '')}_勤務実績表.xlsx`;
            const isPartTime = document.getElementById('employmentType').value === 'parttime';

            const workbook = XLSX.utils.book_new();
            
            // Create worksheet data with summary
            const worksheetData = [
                ['勤務実績表'],
                [''],
                ['氏名', employeeName],
                ['対象月', targetMonth],
                ['対象期間', `${startDate} ～ ${endDate}`],
                ['勤務形態', employmentType]
            ];

            if (isPartTime) {
                worksheetData.push(['時給', hourlyWage + '円/時']);
            }

            worksheetData.push(
                [''],
                ['サマリー'],
                ['出勤日数', summaryData.workDays + '日'],
                ['休日出勤日数', summaryData.holidayWorkDays + '日'],
                ['総残業時間', minutesToTime(summaryData.totalOvertimeMinutes)],
                ['総残業費用', '¥' + summaryData.totalOvertimeCost.toLocaleString()]
            );

            if (isPartTime) {
                worksheetData.push(
                    ['総実働時間', minutesToTime(summaryData.totalWorkMinutes)],
                    ['総支給額', '¥' + summaryData.totalSalary.toLocaleString()]
                );
            }

            // Add headers
            const headerRow = ['日付', '曜日', '休日出勤', '出勤時間', '退勤時間', '休憩時間', '実働時間', '残業時間', '残業費用'];
            if (isPartTime) {
                headerRow.push('基本給');
            }

            worksheetData.push([''], ['詳細'], headerRow);

            // Add data rows
            processedData.forEach(row => {
                const dataRow = [
                    row.date,
                    row.dayOfWeek,
                    row.isHolidayWork ? '○' : '',
                    row.startTime,
                    row.endTime,
                    row.breakDuration || '',
                    row.actualWorkTime,
                    row.overtimeHours,
                    row.overtimeCost > 0 ? row.overtimeCost : ''
                ];

                if (isPartTime) {
                    dataRow.push(row.basicSalary > 0 ? row.basicSalary : '');
                }

                worksheetData.push(dataRow);
            });

            const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
            XLSX.utils.book_append_sheet(workbook, worksheet, '勤務実績表');
            XLSX.writeFile(workbook, fileName);
            
            showMessage('Excelファイルをエクスポートしました', 'success');
        }

        function exportToCSV() {
            if (processedData.length === 0) {
                showMessage('エクスポートするデータがありません', 'error');
                return;
            }

            const employeeName = document.getElementById('employeeName').value || '従業員';
            const targetMonth = document.getElementById('targetMonth').value;
            const employmentType = document.getElementById('employmentType').value === 'parttime' ? 'パート' : '常勤';
            const hourlyWage = document.getElementById('hourlyWage').value;
            const startDate = document.getElementById('periodStartDate').value;
            const endDate = document.getElementById('periodEndDate').value;
            const fileName = `${employeeName}_${targetMonth.replace('-', '')}_勤務実績表.csv`;
            const isPartTime = document.getElementById('employmentType').value === 'parttime';

            let csvContent = '\ufeff'; // BOM for UTF-8
            
            // Add summary information
            csvContent += '勤務実績表\n';
            csvContent += '\n';
            csvContent += `氏名,${employeeName}\n`;
            csvContent += `対象月,${targetMonth}\n`;
            csvContent += `対象期間,${startDate} ～ ${endDate}\n`;
            csvContent += `勤務形態,${employmentType}\n`;
            
            if (isPartTime) {
                csvContent += `時給,${hourlyWage}円/時\n`;
            }
            
            csvContent += '\n';
            csvContent += 'サマリー\n';
            csvContent += `出勤日数,${summaryData.workDays}日\n`;
            csvContent += `休日出勤日数,${summaryData.holidayWorkDays}日\n`;
            csvContent += `総残業時間,${minutesToTime(summaryData.totalOvertimeMinutes)}\n`;
            csvContent += `総残業費用,¥${summaryData.totalOvertimeCost.toLocaleString()}\n`;
            
            if (isPartTime) {
                csvContent += `総実働時間,${minutesToTime(summaryData.totalWorkMinutes)}\n`;
                csvContent += `総支給額,¥${summaryData.totalSalary.toLocaleString()}\n`;
            }
            
            csvContent += '\n';
            csvContent += '詳細\n';
            
            // Add headers
            let headerLine = '日付,曜日,休日出勤,出勤時間,退勤時間,休憩時間,実働時間,残業時間,残業費用';
            if (isPartTime) {
                headerLine += ',基本給';
            }
            csvContent += headerLine + '\n';

            // Add data
            processedData.forEach(row => {
                let dataLine = [
                    row.date,
                    row.dayOfWeek,
                    row.isHolidayWork ? '○' : '',
                    row.startTime,
                    row.endTime,
                    row.breakDuration || '',
                    row.actualWorkTime,
                    row.overtimeHours,
                    row.overtimeCost > 0 ? row.overtimeCost : ''
                ];

                if (isPartTime) {
                    dataLine.push(row.basicSalary > 0 ? row.basicSalary : '');
                }

                csvContent += dataLine.join(',') + '\n';
            });

            // Download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', fileName);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('CSVファイルをエクスポートしました', 'success');
        }

        // 休憩時間の編集機能
        function editBreakDuration(element) {
            const currentValue = element.textContent.trim();
            const displayValue = currentValue === '未設定' ? '' : currentValue;
            
            // Create input for break duration
            const input = document.createElement('input');
            input.type = 'text';
            input.value = displayValue;
            input.className = 'time-input';
            input.placeholder = '例: 60分, 1時間30分';
            
            // Add event listeners
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveBreakDurationEdit(element, this.value);
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelBreakDurationEdit(element, currentValue);
                }
            });
            
            input.addEventListener('blur', function(e) {
                setTimeout(() => {
                    if (document.contains(this)) {
                        saveBreakDurationEdit(element, this.value);
                    }
                }, 100);
            });
            
            // Replace element content with input
            element.innerHTML = '';
            element.appendChild(input);
            
            // Focus and select
            input.focus();
            input.select();
        }

        function saveBreakDurationEdit(element, newValue) {
            const rowIndex = parseInt(element.dataset.row);
            const field = element.dataset.field;
            
            // Validate row index
            if (rowIndex < 0 || rowIndex >= allPeriodData.length) {
                showMessage('データの更新に失敗しました: 無効な行インデックス', 'error');
                cancelBreakDurationEdit(element, element.textContent || '未設定');
                return;
            }
            
            // Update data
            if (allPeriodData[rowIndex] !== undefined) {
                const oldValue = allPeriodData[rowIndex][field];
                allPeriodData[rowIndex][field] = newValue;
                
                // Also update original CSV data if it exists
                const originalRow = originalCsvData.find(row => 
                    normalizeDate(row.date) === normalizeDate(allPeriodData[rowIndex].date)
                );
                
                if (originalRow) {
                    originalRow.breakDuration = newValue;
                    originalRow.breakTime = newValue; // Keep both for compatibility
                }
                
                // Update csvData to maintain consistency
                csvData = [...allPeriodData];
                
                try {
                    // Trigger full recalculation
                    processData();
                    
                    // Show confirmation message
                    const timeDisplay = newValue || '未設定';
                    showMessage(`✅ ${allPeriodData[rowIndex].date} の休憩時間を「${timeDisplay}」に更新しました`, 'success');
                    
                } catch (error) {
                    // Rollback on error
                    allPeriodData[rowIndex][field] = oldValue;
                    if (originalRow) {
                        originalRow.breakDuration = oldValue;
                        originalRow.breakTime = oldValue;
                    }
                    csvData = [...allPeriodData];
                    processData();
                    
                    showMessage('計算中にエラーが発生しました: ' + error.message, 'error');
                }
                
            } else {
                showMessage('データの更新に失敗しました: データが見つかりません', 'error');
                cancelBreakDurationEdit(element, element.textContent || '未設定');
            }
        }

        function cancelBreakDurationEdit(element, originalValue) {
            element.innerHTML = originalValue;
        }

        // 日付正規化のヘルパー関数
        function normalizeDate(dateStr) {
            if (!dateStr) return '';
            
            if (dateStr.match(/^\d{4}\/\d{1,2}\/\d{1,2}$/)) {
                const parts = dateStr.split('/');
                return parts[0] + '-' + parts[1].padStart(2, '0') + '-' + parts[2].padStart(2, '0');
            } else if (dateStr.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                const parts = dateStr.split('/');
                return parts[2] + '-' + parts[0].padStart(2, '0') + '-' + parts[1].padStart(2, '0');
            } else if (dateStr.match(/^\d{4}-\d{1,2}-\d{1,2}$/)) {
                const parts = dateStr.split('-');
                return parts[0] + '-' + parts[1].padStart(2, '0') + '-' + parts[2].padStart(2, '0');
            }
            return dateStr;
        }

        // 休憩時間を分に変換する関数
        function parseBreakDuration(breakStr) {
            if (!breakStr || breakStr === '' || breakStr === '---') return 0;
            
            breakStr = breakStr.toString().toLowerCase();
            let totalMinutes = 0;
            
            // Handle various formats
            // 例: "60分", "1時間30分", "90", "1.5時間"
            
            // 時間と分が含まれている場合 (例: "1時間30分")
            const hoursAndMinutesMatch = breakStr.match(/(\d+(?:\.\d+)?)\s*時間\s*(\d+)\s*分/);
            if (hoursAndMinutesMatch) {
                const hours = parseFloat(hoursAndMinutesMatch[1]);
                const minutes = parseInt(hoursAndMinutesMatch[2]);
                return Math.round(hours * 60 + minutes);
            }
            
            // 時間のみ (例: "1時間", "1.5時間")
            const hoursOnlyMatch = breakStr.match(/(\d+(?:\.\d+)?)\s*時間/);
            if (hoursOnlyMatch) {
                const hours = parseFloat(hoursOnlyMatch[1]);
                return Math.round(hours * 60);
            }
            
            // 分のみ (例: "60分")
            const minutesOnlyMatch = breakStr.match(/(\d+)\s*分/);
            if (minutesOnlyMatch) {
                return parseInt(minutesOnlyMatch[1]);
            }
            
            // 数字のみ（分として扱う）
            const numberMatch = breakStr.match(/^(\d+(?:\.\d+)?)$/);
            if (numberMatch) {
                return Math.round(parseFloat(numberMatch[1]));
            }
            
            return 0;
        }

        function showMessage(message, type) {
            const container = document.getElementById('messageContainer');
            
            // Remove existing messages
            const existingMessage = container.querySelector('.message');
            if (existingMessage) {
                existingMessage.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-all duration-300 ${
                type === 'error' ? 'bg-red-100 border border-red-400 text-red-700' : 'bg-green-100 border border-green-400 text-green-700'
            }`;
            
            messageDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle'} mr-2"></i>
                    <span>${message}</span>
                </div>
            `;

            container.appendChild(messageDiv);

            // Auto remove after 5 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>
