<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹¤å‹™å®Ÿç¸¾è¡¨è‡ªå‹•ä½œæˆã‚·ã‚¹ãƒ†ãƒ </title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .drag-over {
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.1);
        }
        .calculation-box {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 12px;
            padding: 16px;
            color: white;
            margin: 16px 0;
        }
        .summary-card {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }
        .part-time-card {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        .editable-time {
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.2s ease;
            display: inline-block;
            min-width: 90px;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 2px solid #42a5f5;
            position: relative;
            font-weight: 700;
            color: #0d47a1;
            font-size: 15px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(66, 165, 245, 0.3);
        }
        .editable-time:hover {
            background: linear-gradient(135deg, #bbdefb 0%, #90caf9 100%);
            border-color: #1976d2;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(66, 165, 245, 0.4);
        }
        .editable-time:before {
            content: 'ğŸ“';
            position: absolute;
            right: 4px;
            top: 2px;
            font-size: 12px;
            opacity: 0.7;
        }
        .editable-time:hover:before {
            opacity: 1;
        }
        .editable-time-unset {
            cursor: pointer;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.2s ease;
            display: inline-block;
            min-width: 90px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 1px solid #d6d8db;
            position: relative;
            font-weight: 400;
            color: #6c757d;
            font-size: 14px;
            text-align: center;
            box-shadow: none;
        }
        .editable-time-unset:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            border-color: #adb5bd;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .editable-time-unset:before {
            content: 'âœï¸';
            position: absolute;
            right: 4px;
            top: 2px;
            font-size: 10px;
            opacity: 0.5;
        }
        .editable-time-unset:hover:before {
            opacity: 0.8;
        }
        .editable-amount {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);
            position: relative;
            display: inline-block;
            min-width: 80px;
            text-align: center;
        }
        .editable-amount:hover {
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4);
            transform: translateY(-1px);
        }
        .editable-amount:before {
            content: 'Â¥';
            position: absolute;
            left: 8px;
            opacity: 0.7;
        }
        .editable-amount:hover:before {
            opacity: 0.9;
        }
        .editable-amount-unset {
            background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
            color: #6b7280;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            position: relative;
            display: inline-block;
            min-width: 80px;
            text-align: center;
        }
        .editable-amount-unset:hover {
            background: linear-gradient(135deg, #d1d5db 0%, #9ca3af 100%);
            color: #374151;
            transform: translateY(-1px);
        }
        .editable-amount-unset:before {
            content: 'ğŸ’°';
            position: absolute;
            right: 4px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.5;
            font-size: 12px;
        }
        .editable-amount-unset:hover:before {
            opacity: 0.8;
        }
        .time-input {
            border: 3px solid #1976d2;
            border-radius: 8px;
            padding: 10px 16px;
            font-size: 15px;
            font-family: inherit;
            width: 120px;
            text-align: center;
            background: linear-gradient(135deg, #fff 0%, #f3f8ff 100%);
            box-shadow: 0 4px 16px rgba(25, 118, 210, 0.4);
            font-weight: 700;
            color: #0d47a1;
            outline: none;
        }
        .time-input:focus {
            border-color: #0d47a1;
            box-shadow: 0 6px 20px rgba(25, 118, 210, 0.5);
            transform: scale(1.05);
        }
         {
            body { margin: 0; }
            .no-print { display: none; }
        }
        .export-buttons {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 24px;
            margin: 24px 0;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .export-button {
            min-width: 200px;
            padding: 16px 24px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(0);
        }
        .export-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        .export-button:active {
            transform: translateY(0);
        }
        .settings-import-export {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
        }
        .period-setting {
            background: linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 100%);
            border: 2px solid #8b5cf6;
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
        }
        .holiday-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            transform: scale(1.2);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl shadow-lg mb-8 relative">
            <!-- ãƒ˜ãƒ«ãƒ—ãƒœã‚¿ãƒ³ -->
            <div class="absolute top-4 right-4">
                <a href="./help.html" class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-full text-sm font-semibold transition-all duration-300 hover:scale-105 flex items-center" title="æ©Ÿèƒ½èª¬æ˜ãƒ»ä½¿ã„æ–¹ã‚’è¦‹ã‚‹">
                    <i class="fas fa-question-circle mr-2"></i>
                    <span class="hidden sm:inline">ä½¿ã„æ–¹ãƒ»æ©Ÿèƒ½èª¬æ˜</span>
                    <span class="sm:hidden">ãƒ˜ãƒ«ãƒ—</span>
                </a>
            </div>
            <div class="p-8 text-center">
                <h1 class="text-4xl font-bold mb-4">
                    <i class="fas fa-calculator mr-3"></i>å‹¤å‹™å®Ÿç¸¾è¡¨è‡ªå‹•ä½œæˆã‚·ã‚¹ãƒ†ãƒ 
                </h1>
                <p class="text-xl opacity-90 mb-3">ã‚¿ã‚¤ãƒ ã‚«ãƒ¼ãƒ‰ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰è‡ªå‹•ã§å‹¤å‹™å®Ÿç¸¾è¡¨ã‚’ä½œæˆã—ã¾ã™</p>
                <div class="flex justify-center items-center space-x-4 text-sm opacity-80">
                    <span class="flex items-center">
                        <i class="fas fa-clock mr-1"></i>å‡ºé€€å‹¤æ™‚åˆ»ã‚’è‡ªå‹•å…¥åŠ›
                    </span>
                    <span class="flex items-center">
                        <i class="fas fa-calculator mr-1"></i>çµ¦ä¸ãƒ»æ®‹æ¥­ä»£è‡ªå‹•è¨ˆç®—
                    </span>
                    <span class="flex items-center">
                        <i class="fas fa-magic mr-1"></i>è¨­å®šã®è‡ªå‹•å¼•ãç¶™ã
                    </span>
                    <span class="flex items-center">
                        <i class="fas fa-layer-group mr-1"></i>éå»ãƒ‡ãƒ¼ã‚¿çµ±åˆç®¡ç†
                    </span>
                </div>
            </div>
        </div>

        <!-- File Upload Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Timecard CSV Upload -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-file-csv mr-3 text-blue-600"></i>ã‚¿ã‚¤ãƒ ã‚«ãƒ¼ãƒ‰ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                </h3>
                <div id="uploadArea" class="border-3 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer transition-all hover:border-blue-400 hover:bg-blue-50">
                    <i class="fas fa-file-upload text-4xl text-gray-400 mb-3"></i>
                    <p class="text-lg text-gray-600 mb-3">Excel/CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</p>
                    <input type="file" id="fileInput" accept=".csv,.xlsx" class="hidden">
                    <div class="flex justify-center gap-3">
                        <button onclick="document.getElementById('fileInput').click()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm">
                            <i class="fas fa-folder-open mr-2"></i>ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
                        </button>
                        <button onclick="clearFileSelection()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors text-sm">
                            <i class="fas fa-times mr-2"></i>ã‚¯ãƒªã‚¢
                        </button>
                    </div>
                </div>
            </div>

            <!-- Work Report Import -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-2 flex items-center flex-wrap">
                    <i class="fas fa-file-import mr-3 text-indigo-600"></i>
                    <span>éå»ã®å‹¤å‹™å®Ÿç¸¾è¡¨ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</span>
                    <span class="text-sm text-gray-500 font-normal ml-2">ï¼ˆå¾“æ¥­å“¡åŸºæœ¬è¨­å®šã€æ›œæ—¥åˆ¥è©³ç´°è¨­å®šã®ãƒ‡ãƒ¼ã‚¿ãŒè‡ªå‹•åæ˜ ã•ã‚Œã¾ã™ï¼‰</span>
                </h3>
                <div id="workReportUploadArea" class="border-3 border-dashed border-indigo-300 rounded-lg p-8 text-center cursor-pointer transition-all hover:border-indigo-400 hover:bg-indigo-50">
                    <i class="fas fa-file-excel text-4xl text-indigo-400 mb-3"></i>
                    <p class="text-lg text-gray-600 mb-3">Excel/CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</p>
                    <input type="file" id="workReportFileInput" accept=".csv,.xlsx" class="hidden">
                    <div class="flex justify-center gap-3">
                        <button onclick="document.getElementById('workReportFileInput').click()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors text-sm">
                            <i class="fas fa-folder-open mr-2"></i>ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
                        </button>
                        <button onclick="clearWorkReportSelection()" class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors text-sm">
                            <i class="fas fa-times mr-2"></i>ã‚¯ãƒªã‚¢
                        </button>
                    </div>
                </div>
                <div id="workReportStatus" class="mt-3 text-sm text-gray-600 hidden">
                    <i class="fas fa-check-circle text-green-600 mr-1"></i>å‹¤å‹™å®Ÿç¸¾è¡¨ãŒæ­£å¸¸ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã€è¨­å®šæƒ…å ±ãŒå¾©å…ƒã•ã‚Œã¾ã—ãŸ
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Basic Settings -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-user-cog mr-3 text-blue-600"></i>å¾“æ¥­å“¡åŸºæœ¬è¨­å®š
                </h3>
                <div class="space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ°å</label>
                            <input type="text" id="employeeName" placeholder="å±±ç”°å¤ªéƒ" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">å¯¾è±¡å¹´æœˆ</label>
                            <input type="month" id="targetMonth" onchange="autoCalculatePeriod()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                    </div>
                    
                    <!-- Closing Day Setting -->
                    <div class="closing-day-setting">
                        <h4 class="text-lg font-semibold text-green-800 mb-3 flex items-center">
                            <i class="fas fa-calendar-check mr-2"></i>ç· ã‚æ—¥è¨­å®š
                        </h4>
                        <div>
                            <label class="block text-xs font-medium text-green-700 mb-1">ç· ã‚æ—¥ï¼ˆ1ï½31æ—¥ã€æœˆæœ«ï¼‰</label>
                            <select id="closingDate" onchange="autoCalculatePeriod()" class="w-full px-3 py-2 border border-green-300 rounded focus:ring-2 focus:ring-green-500 text-sm">
                                <option value="" selected>é¸æŠã—ã¦ãã ã•ã„</option>
                                <option value="1">1æ—¥</option>
                                <option value="2">2æ—¥</option>
                                <option value="3">3æ—¥</option>
                                <option value="4">4æ—¥</option>
                                <option value="5">5æ—¥</option>
                                <option value="6">6æ—¥</option>
                                <option value="7">7æ—¥</option>
                                <option value="8">8æ—¥</option>
                                <option value="9">9æ—¥</option>
                                <option value="10">10æ—¥</option>
                                <option value="11">11æ—¥</option>
                                <option value="12">12æ—¥</option>
                                <option value="13">13æ—¥</option>
                                <option value="14">14æ—¥</option>
                                <option value="15">15æ—¥</option>
                                <option value="16">16æ—¥</option>
                                <option value="17">17æ—¥</option>
                                <option value="18">18æ—¥</option>
                                <option value="19">19æ—¥</option>
                                <option value="20">20æ—¥</option>
                                <option value="21">21æ—¥</option>
                                <option value="22">22æ—¥</option>
                                <option value="23">23æ—¥</option>
                                <option value="24">24æ—¥</option>
                                <option value="25">25æ—¥</option>
                                <option value="26">26æ—¥</option>
                                <option value="27">27æ—¥</option>
                                <option value="28">28æ—¥</option>
                                <option value="29">29æ—¥</option>
                                <option value="30">30æ—¥</option>
                                <option value="31">31æ—¥</option>
                                <option value="monthEnd">æœˆæœ«</option>
                            </select>
                        </div>
                        <p class="text-xs text-green-600 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>çµ¦ä¸è¨ˆç®—ã®åŸºæº–ã¨ãªã‚‹ç· ã‚æ—¥ã‚’è¨­å®šã—ã¾ã™
                        </p>
                    </div>
                    
                    <!-- Period Setting -->
                    <div class="period-setting">
                        <h4 class="text-lg font-semibold text-purple-800 mb-3 flex items-center">
                            <i class="fas fa-calendar-alt mr-2"></i>å¯¾è±¡æœŸé–“è¨­å®š
                        </h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-medium text-purple-700 mb-1">é–‹å§‹æ—¥</label>
                                <input type="date" id="periodStartDate" onchange="generatePeriodAndMergeData()" class="w-full px-3 py-2 border border-purple-300 rounded focus:ring-2 focus:ring-purple-500 text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-purple-700 mb-1">çµ‚äº†æ—¥</label>
                                <input type="date" id="periodEndDate" onchange="generatePeriodAndMergeData()" class="w-full px-3 py-2 border border-purple-300 rounded focus:ring-2 focus:ring-purple-500 text-sm">
                            </div>
                        </div>
                        <p class="text-xs text-purple-600 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>æœŸé–“ã‚’è¨­å®šã™ã‚‹ã¨ã€è©²å½“æœŸé–“ã®ã™ã¹ã¦ã®æ—¥ä»˜ã‚’è¡¨ç¤ºã—ã€CSVãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•å…¥åŠ›ã—ã¾ã™
                        </p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">å‹¤å‹™å½¢æ…‹</label>
                        <select id="employmentType" onchange="toggleHourlyWage()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="fulltime">å¸¸å‹¤</option>
                            <option value="parttime">ãƒ‘ãƒ¼ãƒˆ</option>
                        </select>
                    </div>
                    
                    <!-- Fulltime Wage Settings -->
                    <div id="fulltimeWageContainer" class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h4 class="text-lg font-semibold text-blue-800 mb-3 flex items-center">
                            <i class="fas fa-briefcase mr-2"></i>å¸¸å‹¤çµ¦ä¸è¨­å®š
                        </h4>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-blue-800 mb-2">åŸºæœ¬çµ¦ (å††/æœˆ)</label>
                                <input type="number" id="baseSalary" value="200000" min="0" placeholder="200000" onchange="recalculateIfNeeded()" class="w-full px-4 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            
                            <!-- Commuting Allowance -->
                            <div class="grid grid-cols-1 gap-3">
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3">
                                    <p class="text-xs text-blue-700 mb-1"><i class="fas fa-info-circle mr-1"></i><strong>é€šå‹¤æ‰‹å½“ã®è¨ˆç®—æ–¹æ³•</strong></p>
                                    <p class="text-xs text-blue-600">â€¢ 1æ—¥ã‚ãŸã‚Šã®é‡‘é¡ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹å ´åˆï¼š1æ—¥ã‚ãŸã‚Š Ã— å‹¤å‹™æ—¥æ•°ã§è¨ˆç®—</p>
                                    <p class="text-xs text-blue-600">â€¢ 1æ—¥ã‚ãŸã‚ŠãŒ0ã¾ãŸã¯æœªå…¥åŠ›ã®å ´åˆï¼šæœˆé¡ã‚’ãã®ã¾ã¾é©ç”¨</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-blue-800 mb-2">é€šå‹¤æ‰‹å½“ï¼ˆæœˆé¡ï¼‰ (å††)</label>
                                    <input type="number" id="fulltimeCommutingAllowance" value="0" min="0" placeholder="0" onchange="recalculateIfNeeded()" class="w-full px-4 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-blue-800 mb-2">é€šå‹¤æ‰‹å½“ï¼ˆ1æ—¥ã‚ãŸã‚Šï¼‰ (å††)</label>
                                    <input type="number" id="fulltimeCommutingAllowanceDaily" value="0" min="0" placeholder="0" onchange="recalculateIfNeeded()" class="w-full px-4 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                            </div>
                            
                            <!-- Multiple Adjustment Allowances Section -->
                            <div class="allowances-section">
                                <div class="flex items-center justify-between mb-3">
                                    <label class="text-sm font-medium text-blue-800">èª¿æ•´æ‰‹å½“</label>
                                    <button type="button" onclick="addFulltimeAllowance()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 transition-colors">
                                        <i class="fas fa-plus mr-1"></i>èª¿æ•´æ‰‹å½“è¿½åŠ 
                                    </button>
                                </div>
                                <div id="fulltimeAllowancesList" class="space-y-2">
                                    <!-- Initial allowance row -->
                                    <div class="allowance-row grid grid-cols-1 sm:grid-cols-3 gap-2 items-end">
                                        <div>
                                            <input type="text" placeholder="å½¹è·æ‰‹å½“" onchange="recalculateIfNeeded()" class="allowance-name w-full px-3 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                                        </div>
                                        <div>
                                            <input type="number" value="0" min="0" placeholder="0" onchange="recalculateIfNeeded()" class="allowance-amount w-full px-3 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                                        </div>
                                        <div>
                                            <button type="button" onclick="removeFulltimeAllowance(this)" class="bg-red-500 text-white px-2 py-2 rounded text-sm hover:bg-red-600 transition-colors w-full" style="display: none;">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-blue-800 mb-2">æ®‹æ¥­æ™‚çµ¦ (å††/æ™‚)</label>
                                <input type="number" id="fulltimeOvertimeHourlyWage" value="1500" min="0" placeholder="1500" onchange="recalculateIfNeeded()" class="w-full px-4 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Parttime Wage Settings -->
                    <div id="parttimeWageContainer" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4" style="display: none;">
                        <h4 class="text-lg font-semibold text-yellow-800 mb-3 flex items-center">
                            <i class="fas fa-clock mr-2"></i>ãƒ‘ãƒ¼ãƒˆçµ¦ä¸è¨­å®š
                        </h4>
                        <div class="space-y-4">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-yellow-800 mb-2">æ™‚çµ¦ (å††/æ™‚)</label>
                                    <input type="number" id="regularHourlyWage" value="1000" min="0" placeholder="1000" onchange="recalculateIfNeeded()" class="w-full px-4 py-2 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-yellow-800 mb-2">æ®‹æ¥­æ™‚çµ¦ (å††/æ™‚)</label>
                                    <input type="number" id="overtimeHourlyWage" value="1250" min="0" placeholder="1250" onchange="recalculateIfNeeded()" class="w-full px-4 py-2 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                                </div>
                            </div>
                            
                            <!-- Commuting Allowance -->
                            <div class="grid grid-cols-1 gap-3">
                                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-3">
                                    <p class="text-xs text-yellow-700 mb-1"><i class="fas fa-info-circle mr-1"></i><strong>é€šå‹¤æ‰‹å½“ã®è¨ˆç®—æ–¹æ³•</strong></p>
                                    <p class="text-xs text-yellow-600">â€¢ 1æ—¥ã‚ãŸã‚Šã®é‡‘é¡ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹å ´åˆï¼š1æ—¥ã‚ãŸã‚Š Ã— å‹¤å‹™æ—¥æ•°ã§è¨ˆç®—</p>
                                    <p class="text-xs text-yellow-600">â€¢ 1æ—¥ã‚ãŸã‚ŠãŒ0ã¾ãŸã¯æœªå…¥åŠ›ã®å ´åˆï¼šæœˆé¡ã‚’ãã®ã¾ã¾é©ç”¨</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-yellow-800 mb-2">é€šå‹¤æ‰‹å½“ï¼ˆæœˆé¡ï¼‰ (å††)</label>
                                    <input type="number" id="parttimeCommutingAllowanceMonthly" value="0" min="0" placeholder="0" onchange="recalculateIfNeeded()" class="w-full px-4 py-2 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-yellow-800 mb-2">é€šå‹¤æ‰‹å½“ï¼ˆ1æ—¥ã‚ãŸã‚Šï¼‰ (å††)</label>
                                    <input type="number" id="parttimeCommutingAllowance" value="0" min="0" placeholder="0" onchange="recalculateIfNeeded()" class="w-full px-4 py-2 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                                </div>
                            </div>
                            
                            <!-- Multiple Adjustment Allowances Section -->
                            <div class="allowances-section">
                                <div class="flex items-center justify-between mb-3">
                                    <label class="text-sm font-medium text-yellow-800">èª¿æ•´æ‰‹å½“</label>
                                    <button type="button" onclick="addParttimeAllowance()" class="bg-yellow-600 text-white px-3 py-1 rounded text-sm hover:bg-yellow-700 transition-colors">
                                        <i class="fas fa-plus mr-1"></i>èª¿æ•´æ‰‹å½“è¿½åŠ 
                                    </button>
                                </div>
                                <div id="parttimeAllowancesList" class="space-y-2">
                                    <!-- Initial allowance row -->
                                    <div class="allowance-row grid grid-cols-1 sm:grid-cols-3 gap-2 items-end">
                                        <div>
                                            <input type="text" placeholder="å½¹è·æ‰‹å½“" onchange="recalculateIfNeeded()" class="allowance-name w-full px-3 py-2 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent text-sm">
                                        </div>
                                        <div>
                                            <input type="number" value="0" min="0" placeholder="0" onchange="recalculateIfNeeded()" class="allowance-amount w-full px-3 py-2 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent text-sm">
                                        </div>
                                        <div>
                                            <button type="button" onclick="removeParttimeAllowance(this)" class="bg-red-500 text-white px-2 py-2 rounded text-sm hover:bg-red-600 transition-colors w-full" style="display: none;">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Paid Leave Settings -->
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <h4 class="text-lg font-semibold text-green-800 mb-3 flex items-center">
                            <i class="fas fa-calendar-check mr-2"></i>æœ‰çµ¦ä¼‘æš‡è¨­å®š
                        </h4>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-green-800 mb-2">æœ‰çµ¦æ—¥æ•° (æ—¥)</label>
                                <input type="number" id="totalPaidLeaveDays" value="20" min="0" placeholder="20" class="w-full px-4 py-2 border border-green-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-green-800 mb-2">ä»Šå¹´åº¦æœ‰çµ¦å–å¾—æ—¥ (æ—¥)</label>
                                <input type="number" id="usedPaidLeaveDays" value="0" min="0" placeholder="0" onchange="calculateRemainingPaidLeave()" class="w-full px-4 py-2 border border-green-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-green-800 mb-2">æ®‹ã‚Šæœ‰çµ¦æ—¥æ•° (æ—¥)</label>
                                <input type="number" id="remainingPaidLeaveDays" value="20" min="0" readonly class="w-full px-4 py-2 border border-green-300 rounded-lg bg-green-100 text-green-800 font-semibold">
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Bulk Settings -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-cogs mr-3 text-blue-600"></i>ä¸€æ‹¬è¨­å®š
                </h3>
                
                <!-- Settings Import/Export -->
                <div class="settings-import-export mb-4">
                    <h4 class="text-lg font-semibold text-amber-800 mb-3 flex items-center">
                        <i class="fas fa-download mr-2"></i>å¾“æ¥­å“¡ã®åŸºæœ¬ãƒ»æ›œæ—¥åˆ¥è¨­å®šã®ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿
                    </h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <button onclick="exportSettings()" class="bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors text-sm font-semibold shadow-lg border-2 border-blue-700">
                            <i class="fas fa-file-export mr-2"></i>è¨­å®šã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                        </button>
                        <div class="relative">
                            <input type="file" id="settingsFileInput" accept=".json" onchange="importSettings()" class="hidden">
                            <button onclick="document.getElementById('settingsFileInput').click()" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition-colors text-sm font-semibold shadow-lg border-2 border-green-700">
                                <i class="fas fa-file-import mr-2"></i>è¨­å®šã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Common Settings -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                    <h4 class="text-lg font-semibold text-blue-800 mb-4">å…¨æ›œæ—¥å…±é€šè¨­å®š</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-blue-700 mb-1">æ®‹æ¥­é–‹å§‹æ™‚é–“</label>
                            <input type="time" id="bulkOvertimeStart" value="18:00" class="w-full px-3 py-2 border border-blue-300 rounded focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-blue-700 mb-1">ä¼‘æ†©æ™‚é–“(åˆ†)</label>
                            <input type="number" id="bulkBreakTime" value="60" min="0" class="w-full px-3 py-2 border border-blue-300 rounded focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="sm:col-span-2">
                            <label class="block text-sm font-medium text-blue-700 mb-1">æ®‹æ¥­å˜ä¾¡(å††/æ™‚)</label>
                            <input type="number" id="bulkOvertimeRate" value="1500" min="0" class="w-full px-3 py-2 border border-blue-300 rounded focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <button onclick="applyBulkSettings()" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-sync mr-2"></i>å…¨æ›œæ—¥ã«é©ç”¨
                    </button>
                </div>

                <!-- Attendance Correction -->
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <h4 class="text-lg font-semibold text-green-800 mb-2 flex items-center">
                        <i class="fas fa-clock mr-2"></i>æ™‚åˆ»ä¸€æ‹¬å¤‰æ›´
                    </h4>
                    <p class="text-sm text-green-700 mb-3">åŸºæº–æ™‚åˆ»ã‚ˆã‚Šæ—©ã/é…ãã«å‡ºå‹¤/é€€å‹¤ã—ãŸå ´åˆã¯ã€ä¸€æ‹¬ã§æŒ‡å®šã—ãŸæ™‚åˆ»ã«å¤‰æ›´ã—ã¾ã™ã€‚</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="block text-xs font-medium text-green-700 mb-1">å¯¾è±¡æ™‚åˆ»</label>
                            <select id="correctionTimeType" class="w-full px-3 py-2 border border-green-300 rounded focus:ring-2 focus:ring-green-500 text-sm">
                                <option value="startTime">å‡ºå‹¤æ™‚é–“</option>
                                <option value="endTime">é€€å‹¤æ™‚é–“</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-green-700 mb-1">åŸºæº–æ™‚åˆ»</label>
                            <input type="time" id="correctionBaseTime" value="09:00" class="w-full px-3 py-2 border border-green-300 rounded focus:ring-2 focus:ring-green-500 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-green-700 mb-1">å¤‰æ›´æ¡ä»¶</label>
                            <select id="correctionCondition" class="w-full px-3 py-2 border border-green-300 rounded focus:ring-2 focus:ring-green-500 text-sm">
                                <option value="later">ã‚ˆã‚Šé…ã„å ´åˆ</option>
                                <option value="earlier">ã‚ˆã‚Šæ—©ã„å ´åˆ</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-green-700 mb-1">å¤‰æ›´å¾Œæ™‚åˆ»</label>
                            <input type="time" id="correctionNewTime" value="09:00" class="w-full px-3 py-2 border border-green-300 rounded focus:ring-2 focus:ring-green-500 text-sm">
                        </div>
                    </div>
                    <div class="bg-green-100 border border-green-200 rounded p-2 mb-3">
                        <p class="text-xs text-green-700">
                            <i class="fas fa-info-circle mr-1"></i>
                            ä¾‹: ã€Œå‡ºå‹¤æ™‚é–“ã€ã§åŸºæº–æ™‚åˆ»ã€Œ09:00ã€ã‚ˆã‚Šã€Œé…ã„å ´åˆã€ã‚’ã€Œ08:30ã€ã«å¤‰æ›´
                        </p>
                    </div>
                    <button onclick="applyCorrectionTime()" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                        <i class="fas fa-edit mr-2"></i>ä¸€æ‹¬å¤‰æ›´å®Ÿè¡Œ
                    </button>
                </div>

                <!-- Break Time Bulk Change -->
                <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
                    <h4 class="text-lg font-semibold text-amber-800 mb-2 flex items-center">
                        <i class="fas fa-coffee mr-2"></i>ä¼‘æ†©æ™‚é–“ä¸€æ‹¬å¤‰æ›´
                    </h4>
                    <p class="text-sm text-amber-700 mb-3">å‡ºå‹¤ã—ã¦ã„ã‚‹æ—¥ã®ä¼‘æ†©æ™‚é–“ã‚’ä¸€æ‹¬ã§å¤‰æ›´ã—ã¾ã™ã€‚</p>
                    <div class="space-y-3 mb-3">
                        <div>
                            <label class="block text-xs font-medium text-amber-700 mb-1">ä¼‘æ†©æ™‚é–“ã‚’é¸æŠ</label>
                            <select id="bulkBreakTimeSelect" class="w-full px-3 py-2 border border-amber-300 rounded focus:ring-2 focus:ring-amber-500 text-sm">
                                <option value="0">0åˆ†ï¼ˆä¼‘æ†©ãªã—ï¼‰</option>
                                <option value="15">15åˆ†</option>
                                <option value="30">30åˆ†</option>
                                <option value="45">45åˆ†</option>
                                <option value="60" selected>60åˆ†ï¼ˆ1æ™‚é–“ï¼‰</option>
                                <option value="75">75åˆ†</option>
                                <option value="90">90åˆ†ï¼ˆ1æ™‚é–“åŠï¼‰</option>
                                <option value="105">105åˆ†</option>
                                <option value="120">120åˆ†ï¼ˆ2æ™‚é–“ï¼‰</option>
                            </select>
                        </div>

                    </div>
                    <div class="bg-amber-100 border border-amber-200 rounded p-2 mb-1">
                        <p class="text-xs text-amber-700">
                            <i class="fas fa-info-circle mr-1"></i>
                            ä¼‘æ†©æ™‚é–“ã‚’é¸æŠã—ã¦ã€Œå¤‰æ›´ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€å…¨ã¦ã®å‡ºå‹¤æ—¥ã®ä¼‘æ†©æ™‚é–“ãŒå¤‰æ›´ã•ã‚Œã¾ã™
                        </p>
                    </div>
                    <div class="text-xs text-amber-600 bg-amber-100 rounded p-2 mb-3">
                        <i class="fas fa-calendar-check mr-1"></i>
                        å‡ºå‹¤ã—ã¦ã„ã‚‹æ—¥ã®ã¿ãŒå¯¾è±¡ã¨ãªã‚Šã¾ã™
                    </div>
                    
                    <!-- ç¢ºå®Ÿã«è¡¨ç¤ºã•ã‚Œã‚‹ãƒœã‚¿ãƒ³ -->
                    <div style="text-align: center; margin-top: 15px;">
                        <button onclick="applyBulkBreakTime()" style="background-color: #d97706; color: white; padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2);" 
                                onmouseover="this.style.backgroundColor='#b45309'" 
                                onmouseout="this.style.backgroundColor='#d97706'">
                            âš¡ ä¼‘æ†©æ™‚é–“ã‚’ä¸€æ‹¬å¤‰æ›´
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Day Settings -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h3 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-calendar-week mr-3 text-blue-600"></i>æ›œæ—¥åˆ¥è©³ç´°è¨­å®š
            </h3>
            <div id="daySettings" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-2">
                <!-- Day cards will be generated here -->
            </div>
        </div>

        <!-- Results Section -->
        <div id="results" class="hidden">
            <!-- Summary Cards -->
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-chart-line mr-3 text-green-600"></i>å‹¤å‹™å®Ÿç¸¾è¡¨
                </h2>
                <div id="summaryCards" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <!-- Summary cards will be generated here -->
                </div>
            </div>

            <!-- Calculation Formula -->
            <div id="calculationFormula" class="hidden mb-6">
                <!-- Calculation formula will be shown here -->
            </div>

            <!-- Data Table -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
                <div class="overflow-x-auto">
                    <table id="resultsTable" class="w-full">
                        <!-- Table will be generated here -->
                    </table>
                </div>
            </div>

            <!-- Export Buttons -->
            <div class="export-buttons no-print">
                <div class="text-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800 flex items-center justify-center">
                        <i class="fas fa-download mr-2"></i>ãƒ•ã‚¡ã‚¤ãƒ«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                    </h3>
                    <p class="text-gray-600 text-sm mt-1">å‹¤å‹™å®Ÿç¸¾è¡¨ã‚’ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ä¿å­˜ã§ãã¾ã™</p>
                </div>
                <div class="flex flex-wrap justify-center gap-6">
                    <button onclick="exportToExcel()" class="export-button bg-green-600 text-white hover:bg-green-700 flex items-center justify-center">
                        <i class="fas fa-file-excel mr-3 text-xl"></i>
                        <span>Excelã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</span>
                    </button>
                    <button onclick="exportToCSV()" class="export-button bg-green-600 text-white hover:bg-green-700 flex items-center justify-center">
                        <i class="fas fa-file-csv mr-3 text-xl"></i>
                        <span>CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</span>
                    </button>
                </div>
                
                <!-- Append Export Section -->
                <div class="mt-8 pt-6 border-t border-gray-200">
                    <div class="text-center mb-4">
                        <h4 class="text-lg font-semibold text-gray-700 flex items-center justify-center">
                            <i class="fas fa-plus-circle mr-2"></i>æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ®‹ã—ã¦ä¿å­˜
                        </h4>
                        <p class="text-gray-600 text-sm mt-1">ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã«æ–°ã—ã„ã‚·ãƒ¼ãƒˆï¼ˆå¯¾è±¡å¹´æœˆï¼‰ã‚’è¿½åŠ ã—ã¦ä¿å­˜</p>
                    </div>
                    <div class="flex justify-center">
                        <button id="appendExportButton" onclick="exportAppendToExisting()" 
                                class="export-button bg-blue-600 text-white hover:bg-blue-700 flex items-center justify-center disabled:bg-gray-400 disabled:cursor-not-allowed"
                                disabled>
                            <i class="fas fa-file-plus mr-3 text-xl"></i>
                            <span>æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã«è¿½åŠ ä¿å­˜</span>
                        </button>
                    </div>
                    <div id="appendExportStatus" class="text-center mt-2 text-sm text-gray-500 hidden">
                        <i class="fas fa-info-circle mr-1"></i>éå»ã®å‹¤å‹™å®Ÿç¸¾è¡¨ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã¨åˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã™
                    </div>
                </div>
            </div>
        </div>

        <!-- Messages -->
        <div id="messageContainer"></div>
    </div>

    <!-- ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚° ãƒ˜ãƒ«ãƒ—ãƒœã‚¿ãƒ³ -->
    <div class="fixed bottom-6 right-6 z-50">
        <a href="./help.html" class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg hover:shadow-xl transform hover:scale-110 transition-all duration-300 group" title="ä½¿ã„æ–¹ãƒ»æ©Ÿèƒ½èª¬æ˜">
            <i class="fas fa-question text-xl group-hover:scale-110 transition-transform duration-300"></i>
        </a>
    </div>

    <script>
        // Global variables
        let csvData = [];
        let originalCsvData = [];
        let processedData = [];
        let allPeriodData = [];
        let summaryData = {
            workDays: 0,
            holidayWorkDays: 0,
            totalOvertimeMinutes: 0,
            totalOvertimeCost: 0,
            totalWorkMinutes: 0,
            totalSalary: 0
        };

        // Variables for append export functionality
        let importedWorkbook = null;
        let importedFileName = '';
        let hasImportedWorkReport = false;
        let daySettings = {
            'æœˆ': { overtimeStart: '18:00', breakTime: 60, overtimeRate: 1500 },
            'ç«': { overtimeStart: '18:00', breakTime: 60, overtimeRate: 1500 },
            'æ°´': { overtimeStart: '18:00', breakTime: 60, overtimeRate: 1500 },
            'æœ¨': { overtimeStart: '18:00', breakTime: 60, overtimeRate: 1500 },
            'é‡‘': { overtimeStart: '18:00', breakTime: 60, overtimeRate: 1500 },
            'åœŸ': { overtimeStart: '18:00', breakTime: 60, overtimeRate: 1500 },
            'æ—¥': { overtimeStart: '18:00', breakTime: 60, overtimeRate: 1500 }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initializeDaySettings();
            setupEventListeners();
            setDefaultMonth();
            setDefaultPeriod();

            // åˆæœŸã®å¯¾è±¡æœŸé–“ã‚’è¨ˆç®—
            setTimeout(() => {
                autoCalculatePeriod();
            }, 100);
            enableAppendExport(); // Initialize append export button state
        });

        function setDefaultMonth() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            document.getElementById('targetMonth').value = `${year}-${month}`;
        }

        function setDefaultPeriod() {
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            
            // Set to current month's first and last day
            const startDate = new Date(year, month, 1);
            const endDate = new Date(year, month + 1, 0);
            
            document.getElementById('periodStartDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('periodEndDate').value = endDate.toISOString().split('T')[0];
            
            // Generate initial period data
            generatePeriodAndMergeData();
        }

        function generatePeriodAndMergeData() {
            const startDate = document.getElementById('periodStartDate').value;
            const endDate = document.getElementById('periodEndDate').value;

            if (!startDate || !endDate) {
                return;
            }

            // Generate all dates in the period
            allPeriodData = [];
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            if (start > end) {
                showMessage('é–‹å§‹æ—¥ã¯çµ‚äº†æ—¥ã‚ˆã‚Šå‰ã®æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            let currentDate = new Date(start);
            while (currentDate <= end) {
                const dateString = currentDate.toISOString().split('T')[0];
                allPeriodData.push({
                    date: dateString,
                    workClass: '',
                    workType: '',
                    startTime: '',
                    endTime: '',
                    breakTime: '',
                    breakDuration: '', // å€‹åˆ¥ã®ä¼‘æ†©æ™‚é–“
                    specialAllowance: '', // ç‰¹åˆ¥æ—¥å½“
                    overtime: '',
                    vacation: '',
                    isHolidayWork: false
                });
                currentDate.setDate(currentDate.getDate() + 1);
            }

            // Merge with CSV data if available
            if (originalCsvData.length > 0) {
                mergeCSVWithPeriodData();
            }

            // Process and display
            csvData = [...allPeriodData];
            processData();
            document.getElementById('results').classList.remove('hidden');
            
            showMessage(`æœŸé–“ ${startDate} ï½ ${endDate} ã®${allPeriodData.length}æ—¥é–“ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™`, 'success');
        }

        function mergeCSVWithPeriodData() {
            // Create a map of CSV data by date for quick lookup
            const csvDataMap = {};
            originalCsvData.forEach(row => {
                if (row.date) {
                    // Normalize date format - handle various formats
                    let normalizedDate = row.date;
                    
                    // Handle different date formats
                    if (normalizedDate.match(/^\d{4}\/\d{1,2}\/\d{1,2}$/)) {
                        // Convert YYYY/M/D to YYYY-MM-DD
                        const parts = normalizedDate.split('/');
                        normalizedDate = parts[0] + '-' + parts[1].padStart(2, '0') + '-' + parts[2].padStart(2, '0');
                    } else if (normalizedDate.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                        // Convert M/D/YYYY to YYYY-MM-DD
                        const parts = normalizedDate.split('/');
                        normalizedDate = parts[2] + '-' + parts[0].padStart(2, '0') + '-' + parts[1].padStart(2, '0');
                    } else if (normalizedDate.match(/^\d{4}-\d{1,2}-\d{1,2}$/)) {
                        // Convert YYYY-M-D to YYYY-MM-DD
                        const parts = normalizedDate.split('-');
                        normalizedDate = parts[0] + '-' + parts[1].padStart(2, '0') + '-' + parts[2].padStart(2, '0');
                    }
                    
                    csvDataMap[normalizedDate] = { ...row, date: normalizedDate };
                }
            });

            // Merge CSV data with period data
            allPeriodData.forEach(periodRow => {
                const csvRow = csvDataMap[periodRow.date];
                if (csvRow) {
                    // Merge CSV data into period data, preserving the period date format
                    Object.assign(periodRow, csvRow, { date: periodRow.date });
                }
            });
        }

        function initializeDaySettings() {
            const container = document.getElementById('daySettings');
            const days = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'];
            
            container.innerHTML = '';
            
            days.forEach(day => {
                const dayCard = document.createElement('div');
                dayCard.className = 'bg-gray-50 border border-gray-200 rounded-lg p-2';
                dayCard.innerHTML = `
                    <h4 class="font-medium text-gray-800 mb-2 text-center text-sm">${day}æ›œæ—¥</h4>
                    <div class="space-y-2">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">æ®‹æ¥­é–‹å§‹</label>
                            <input type="time" id="overtime-${day}" value="${daySettings[day].overtimeStart}" 
                                   onchange="updateDaySetting('${day}', 'overtimeStart', this.value)" 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">ä¼‘æ†©(åˆ†)</label>
                            <input type="number" id="break-${day}" value="${daySettings[day].breakTime}" min="0"
                                   onchange="updateDaySetting('${day}', 'breakTime', this.value)" 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">æ®‹æ¥­å˜ä¾¡</label>
                            <input type="number" id="rate-${day}" value="${daySettings[day].overtimeRate}" min="0"
                                   onchange="updateDaySetting('${day}', 'overtimeRate', this.value)" 
                                   class="w-full px-1 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500">
                        </div>
                    </div>
                `;
                container.appendChild(dayCard);
            });
        }

        function setupEventListeners() {
            // Timecard CSV upload area
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });

            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });

            uploadArea.addEventListener('click', (e) => {
                // Only trigger file input if clicking on upload area but not on buttons
                if (!e.target.closest('button')) {
                    fileInput.click();
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });

            // Work report upload area
            const workReportUploadArea = document.getElementById('workReportUploadArea');
            const workReportFileInput = document.getElementById('workReportFileInput');

            workReportUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                workReportUploadArea.classList.add('drag-over');
            });

            workReportUploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                workReportUploadArea.classList.remove('drag-over');
            });

            workReportUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                workReportUploadArea.classList.remove('drag-over');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleWorkReportFile(files[0]);
                }
            });

            workReportUploadArea.addEventListener('click', (e) => {
                // Only trigger file input if clicking on upload area but not on buttons
                if (!e.target.closest('button')) {
                    workReportFileInput.click();
                }
            });

            workReportFileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleWorkReportFile(e.target.files[0]);
                }
            });
        }

        function clearFileSelection() {
            // Clear file input
            const fileInput = document.getElementById('fileInput');
            fileInput.value = '';
            
            // Reset data arrays
            csvData = [];
            originalCsvData = [];
            processedData = [];
            
            // Reset summary data
            summaryData = {
                workDays: 0,
                holidayWorkDays: 0,
                totalOvertimeMinutes: 0,
                totalOvertimeCost: 0,
                totalWorkMinutes: 0,
                totalSalary: 0
            };
            
            // Hide results section
            document.getElementById('results').classList.add('hidden');
            
            // Regenerate period data if period is set
            generatePeriodAndMergeData();
            
            // Show success message
            showMessage('ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
        }

        // Settings Export/Import Functions
        function exportSettings() {
            const isPartTime = document.getElementById('employmentType').value === 'parttime';
            
            const settings = {
                bulkSettings: {
                    overtimeStart: document.getElementById('bulkOvertimeStart').value,
                    breakTime: parseInt(document.getElementById('bulkBreakTime').value) || 60,
                    overtimeRate: parseInt(document.getElementById('bulkOvertimeRate').value) || 1500
                },
                daySettings: { ...daySettings },
                periodSettings: {
                    startDate: document.getElementById('periodStartDate').value,
                    endDate: document.getElementById('periodEndDate').value
                },
                employeeSettings: {
                    name: document.getElementById('employeeName').value,
                    targetMonth: document.getElementById('targetMonth').value,
                    employmentType: document.getElementById('employmentType').value,
                    totalPaidLeaveDays: document.getElementById('totalPaidLeaveDays').value,
                    usedPaidLeaveDays: document.getElementById('usedPaidLeaveDays').value,
                    closingDate: document.getElementById('closingDate').value,
                    wageSettings: isPartTime ? {
                        regularHourlyWage: document.getElementById('regularHourlyWage').value,
                        overtimeHourlyWage: document.getElementById('overtimeHourlyWage').value,
                        commutingAllowance: document.getElementById('parttimeCommutingAllowance').value,
                        adjustmentAllowances: getAllowancesData('parttime')
                    } : {
                        baseSalary: document.getElementById('baseSalary').value,
                        overtimeHourlyWage: document.getElementById('fulltimeOvertimeHourlyWage').value,
                        commutingAllowance: document.getElementById('fulltimeCommutingAllowance').value,
                        adjustmentAllowances: getAllowancesData('fulltime')
                    }
                }
            };

            const settingsJson = JSON.stringify(settings, null, 2);
            const blob = new Blob([settingsJson], { type: 'application/json' });
            
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'å‹¤å‹™å®Ÿç¸¾è¡¨è¨­å®š.json');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('è¨­å®šã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ', 'success');
        }

        function importSettings() {
            const fileInput = document.getElementById('settingsFileInput');
            const file = fileInput.files[0];
            
            if (!file) return;

            if (!file.name.toLowerCase().endsWith('.json')) {
                showMessage('JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const settings = JSON.parse(e.target.result);
                    
                    // Validate settings structure
                    if (!settings.bulkSettings || !settings.daySettings) {
                        throw new Error('è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
                    }

                    // Apply bulk settings
                    if (settings.bulkSettings.overtimeStart) {
                        document.getElementById('bulkOvertimeStart').value = settings.bulkSettings.overtimeStart;
                    }
                    if (settings.bulkSettings.breakTime !== undefined) {
                        document.getElementById('bulkBreakTime').value = settings.bulkSettings.breakTime;
                    }
                    if (settings.bulkSettings.overtimeRate !== undefined) {
                        document.getElementById('bulkOvertimeRate').value = settings.bulkSettings.overtimeRate;
                    }

                    // Apply period settings
                    if (settings.periodSettings) {
                        if (settings.periodSettings.startDate) {
                            document.getElementById('periodStartDate').value = settings.periodSettings.startDate;
                        }
                        if (settings.periodSettings.endDate) {
                            document.getElementById('periodEndDate').value = settings.periodSettings.endDate;
                        }
                    }

                    // Apply day settings
                    const days = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'];
                    days.forEach(day => {
                        if (settings.daySettings[day]) {
                            daySettings[day] = { ...settings.daySettings[day] };
                            
                            // Update UI elements
                            const overtimeInput = document.getElementById(`overtime-${day}`);
                            const breakInput = document.getElementById(`break-${day}`);
                            const rateInput = document.getElementById(`rate-${day}`);
                            
                            if (overtimeInput) overtimeInput.value = daySettings[day].overtimeStart;
                            if (breakInput) breakInput.value = daySettings[day].breakTime;
                            if (rateInput) rateInput.value = daySettings[day].overtimeRate;
                        }
                    });

                    // Apply employee settings if available
                    if (settings.employeeSettings) {
                        const empSettings = settings.employeeSettings;
                        
                        // Apply basic employee information
                        if (empSettings.name) {
                            document.getElementById('employeeName').value = empSettings.name;
                        }
                        if (empSettings.targetMonth) {
                            document.getElementById('targetMonth').value = empSettings.targetMonth;
                        }
                        if (empSettings.employmentType) {
                            document.getElementById('employmentType').value = empSettings.employmentType;
                            // Trigger employment type change to show/hide appropriate sections
                            document.getElementById('employmentType').dispatchEvent(new Event('change'));
                        }
                        if (empSettings.totalPaidLeaveDays) {
                            document.getElementById('totalPaidLeaveDays').value = empSettings.totalPaidLeaveDays;
                        }
                        if (empSettings.usedPaidLeaveDays) {
                            document.getElementById('usedPaidLeaveDays').value = empSettings.usedPaidLeaveDays;
                        }
                        
                        // Apply closing day settings
                        if (empSettings.closingDate) {
                            document.getElementById('closingDate').value = empSettings.closingDate;
                        }
                        
                        // Apply wage settings based on employment type
                        if (empSettings.wageSettings) {
                            const isPartTime = empSettings.employmentType === 'parttime';
                            
                            if (isPartTime) {
                                // Apply part-time wage settings
                                if (empSettings.wageSettings.regularHourlyWage) {
                                    document.getElementById('regularHourlyWage').value = empSettings.wageSettings.regularHourlyWage;
                                }
                                if (empSettings.wageSettings.overtimeHourlyWage) {
                                    document.getElementById('overtimeHourlyWage').value = empSettings.wageSettings.overtimeHourlyWage;
                                }
                                if (empSettings.wageSettings.commutingAllowance) {
                                    document.getElementById('parttimeCommutingAllowance').value = empSettings.wageSettings.commutingAllowance;
                                }
                                if (empSettings.wageSettings.adjustmentAllowances) {
                                    setAllowancesData('parttime', empSettings.wageSettings.adjustmentAllowances);
                                }
                            } else {
                                // Apply full-time wage settings
                                if (empSettings.wageSettings.baseSalary) {
                                    document.getElementById('baseSalary').value = empSettings.wageSettings.baseSalary;
                                }
                                if (empSettings.wageSettings.overtimeHourlyWage) {
                                    document.getElementById('fulltimeOvertimeHourlyWage').value = empSettings.wageSettings.overtimeHourlyWage;
                                }
                                if (empSettings.wageSettings.commutingAllowance) {
                                    document.getElementById('fulltimeCommutingAllowance').value = empSettings.wageSettings.commutingAllowance;
                                }
                                if (empSettings.wageSettings.adjustmentAllowances) {
                                    setAllowancesData('fulltime', empSettings.wageSettings.adjustmentAllowances);
                                }
                            }
                        }
                        
                        // Update remaining paid leave calculation
                        calculateRemainingPaidLeave();
                    }

                    // Regenerate period and merge if needed
                    generatePeriodAndMergeData();

                    showMessage('è¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ', 'success');
                    
                } catch (error) {
                    showMessage('è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(file, 'UTF-8');
            
            // Clear file input
            fileInput.value = '';
        }

        function handleWorkReportFile(file) {
            if (!file) return;

            const fileName = file.name.toLowerCase();
            const statusDiv = document.getElementById('workReportStatus');
            
            if (!fileName.endsWith('.csv') && !fileName.endsWith('.xlsx')) {
                showMessage('CSV ã¾ãŸã¯ Excel ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }

            // Store file information for append export
            importedFileName = file.name;

            if (fileName.endsWith('.xlsx')) {
                // Handle Excel file
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[workbook.SheetNames.length - 1];
                        const worksheet = workbook.Sheets[sheetName];
                        const csvData = XLSX.utils.sheet_to_csv(worksheet);
                        
                        // Store workbook for append export
                        importedWorkbook = workbook;
                        hasImportedWorkReport = true;
                        
                        parseWorkReportData(csvData);
                        showWorkReportImportSuccess();
                        enableAppendExport();
                        
                    } catch (error) {
                        showMessage('Excelãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
                    }
                };
                reader.readAsArrayBuffer(file);
            } else {
                // Handle CSV file - create a simple workbook structure
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const csvData = e.target.result;
                        
                        // Create a workbook from CSV data for append export
                        const worksheet = XLSX.utils.aoa_to_sheet(csvData.split('\n').map(line => line.split(',')));
                        importedWorkbook = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(importedWorkbook, worksheet, 'å‹¤å‹™å®Ÿç¸¾è¡¨');
                        hasImportedWorkReport = true;
                        
                        parseWorkReportData(csvData);
                        showWorkReportImportSuccess();
                        enableAppendExport();
                    } catch (error) {
                        showMessage('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
                    }
                };
                reader.readAsText(file, 'UTF-8');
            }
        }

        function importWorkReport() {
            const fileInput = document.getElementById('workReportFileInput');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            handleWorkReportFile(file);
        }

        function parseWorkReportData(csvData) {
            const lines = csvData.split('\n').filter(line => line.trim());
            let employeeSettingsFound = false;
            let daySettingsFound = false;
            
            // Look for settings sections
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                // Parse employee basic settings
                if (line.includes('=== å¾“æ¥­å“¡åŸºæœ¬è¨­å®š ===')) {
                    employeeSettingsFound = true;
                    
                    // Parse employee settings
                    for (let j = i + 1; j < lines.length; j++) {
                        const settingLine = lines[j].trim();
                        if (!settingLine || settingLine.includes('===') || settingLine.includes('ã‚µãƒãƒªãƒ¼')) {
                            break;
                        }
                        
                        const [key, value] = settingLine.split(',').map(item => item.replace(/"/g, '').trim());
                        if (key && value) {
                            switch (key) {
                                case 'æ°å':
                                    document.getElementById('employeeName').value = value;
                                    break;
                                case 'å¯¾è±¡æœˆ':
                                    // è‡ªå‹•ã§æ¬¡ã®æœˆã«è¨­å®šï¼ˆYYYY-MMå½¢å¼ã§ï¼‰
                                    const currentTargetMonth = value;
                                    const nextMonth = getNextMonthForInput(currentTargetMonth);
                                    document.getElementById('targetMonth').value = nextMonth;
                                    // å¯¾è±¡æœˆå¤‰æ›´å¾Œã«è‡ªå‹•ã§æœŸé–“ã‚’è¨ˆç®—
                                    setTimeout(() => {
                                        autoCalculatePeriod();
                                    }, 100);
                                    break;
                                case 'å¯¾è±¡æœŸé–“':
                                    const periodMatch = value.match(/(\d{4}-\d{2}-\d{2})\s*ï½\s*(\d{4}-\d{2}-\d{2})/);
                                    if (periodMatch) {
                                        // ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®çµ‚äº†æ—¥ã®ç¿Œæ—¥ã‚’é–‹å§‹æ—¥ã«è¨­å®š
                                        const currentEndDate = new Date(periodMatch[2]);
                                        const nextStartDate = new Date(currentEndDate);
                                        nextStartDate.setDate(nextStartDate.getDate() + 1);
                                        
                                        // çµ‚äº†æ—¥ã¯ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®çµ‚äº†æ—¥ã®ä¸€ãƒ¶æœˆå¾Œã«è¨­å®š
                                        const originalEndDate = new Date(periodMatch[2]);
                                        const lastDayOfOriginalMonth = new Date(originalEndDate.getFullYear(), originalEndDate.getMonth() + 1, 0).getDate();
                                        
                                        let nextEndDate;
                                        if (originalEndDate.getDate() === lastDayOfOriginalMonth) {
                                            // å…ƒã®çµ‚äº†æ—¥ãŒæœˆæœ«ã®å ´åˆã€æ¬¡ã®æœˆã®æœˆæœ«ã«è¨­å®š
                                            nextEndDate = new Date(originalEndDate);
                                            nextEndDate.setMonth(nextEndDate.getMonth() + 1);
                                            // æ¬¡ã®æœˆã®æœ€çµ‚æ—¥ã‚’å–å¾—
                                            const nextMonthLastDay = new Date(nextEndDate.getFullYear(), nextEndDate.getMonth() + 1, 0).getDate();
                                            nextEndDate.setDate(nextMonthLastDay);
                                        } else {
                                            // é€šå¸¸ã®å ´åˆã€ä¸€ãƒ¶æœˆå¾Œã®åŒã˜æ—¥ã«è¨­å®š
                                            nextEndDate = new Date(periodMatch[2]);
                                            nextEndDate.setMonth(nextEndDate.getMonth() + 1);
                                        }
                                        
                                        document.getElementById('periodStartDate').value = nextStartDate.toISOString().split('T')[0];
                                        document.getElementById('periodEndDate').value = nextEndDate.toISOString().split('T')[0];
                                    }
                                    break;
                                case 'å‹¤å‹™å½¢æ…‹':
                                    const employmentType = value === 'ãƒ‘ãƒ¼ãƒˆ' ? 'parttime' : 'fulltime';
                                    document.getElementById('employmentType').value = employmentType;
                                    toggleHourlyWage();
                                    break;
                                case 'ç· ã‚æ—¥':
                                    if (value === 'æœˆæœ«') {
                                        document.getElementById('closingDate').value = 'monthEnd';
                                    } else {
                                        const dayMatch = value.match(/(\d+)æ—¥/);
                                        if (dayMatch) {
                                            document.getElementById('closingDate').value = dayMatch[1];
                                        }
                                    }
                                    break;
                                case 'é€šå¸¸æ™‚çµ¦':
                                case 'æ™‚çµ¦':
                                    const regularWage = value.replace(/[å††\/æ™‚]/g, '').trim();
                                    if (regularWage) {
                                        document.getElementById('regularHourlyWage').value = regularWage;
                                    }
                                    break;
                                case 'æ®‹æ¥­æ™‚çµ¦':
                                    const overtimeWage = value.replace(/[å††\/æ™‚]/g, '').trim();
                                    const currentEmploymentType = document.getElementById('employmentType').value;
                                    if (overtimeWage) {
                                        if (currentEmploymentType === 'parttime') {
                                            document.getElementById('overtimeHourlyWage').value = overtimeWage;
                                        } else {
                                            document.getElementById('fulltimeOvertimeHourlyWage').value = overtimeWage;
                                        }
                                    }
                                    break;
                                case 'åŸºæœ¬çµ¦':
                                    const baseSalary = value.replace(/[å††\/æœˆ]/g, '').trim();
                                    if (baseSalary) {
                                        document.getElementById('baseSalary').value = baseSalary;
                                    }
                                    break;
                                case 'é€šå‹¤æ‰‹å½“':
                                case 'é€šå‹¤æ‰‹å½“ï¼ˆæœˆé¡ï¼‰':
                                    const commutingAllowanceMonthly = value.replace(/å††/g, '').trim();
                                    const empTypeForCommutingMonthly = document.getElementById('employmentType').value;
                                    if (commutingAllowanceMonthly) {
                                        if (empTypeForCommutingMonthly === 'parttime') {
                                            document.getElementById('parttimeCommutingAllowanceMonthly').value = commutingAllowanceMonthly;
                                        } else {
                                            document.getElementById('fulltimeCommutingAllowance').value = commutingAllowanceMonthly;
                                        }
                                    }
                                    break;
                                case 'é€šå‹¤æ‰‹å½“ï¼ˆæ—¥é¡ï¼‰':
                                case 'é€šå‹¤æ‰‹å½“ï¼ˆ1æ—¥ã‚ãŸã‚Šï¼‰':
                                    const commutingAllowanceDaily = value.replace(/å††/g, '').trim();
                                    const empTypeForCommutingDaily = document.getElementById('employmentType').value;
                                    if (commutingAllowanceDaily) {
                                        if (empTypeForCommutingDaily === 'parttime') {
                                            document.getElementById('parttimeCommutingAllowance').value = commutingAllowanceDaily;
                                        } else {
                                            document.getElementById('fulltimeCommutingAllowanceDaily').value = commutingAllowanceDaily;
                                        }
                                    }
                                    break;
                                default:
                                    // Handle multiple adjustment allowances (èª¿æ•´æ‰‹å½“1å, èª¿æ•´æ‰‹å½“1é¡, etc.)
                                    if (key.match(/^èª¿æ•´æ‰‹å½“(\d+)å$/)) {
                                        const empTypeForAllowance = document.getElementById('employmentType').value;
                                        const allowanceIndex = parseInt(key.match(/^èª¿æ•´æ‰‹å½“(\d+)å$/)[1]) - 1;
                                        setAllowanceName(empTypeForAllowance, allowanceIndex, value);
                                    } else if (key.match(/^èª¿æ•´æ‰‹å½“(\d+)é¡$/)) {
                                        const allowanceAmount = value.replace(/å††/g, '').trim();
                                        const empTypeForAmount = document.getElementById('employmentType').value;
                                        const allowanceIndex = parseInt(key.match(/^èª¿æ•´æ‰‹å½“(\d+)é¡$/)[1]) - 1;
                                        if (allowanceAmount) {
                                            setAllowanceAmount(empTypeForAmount, allowanceIndex, allowanceAmount);
                                        }
                                    }
                                    break;
                                case 'æœ‰çµ¦æ—¥æ•°':
                                    const totalPaidLeave = value.replace(/æ—¥/g, '').trim();
                                    if (totalPaidLeave) {
                                        document.getElementById('totalPaidLeaveDays').value = totalPaidLeave;
                                    }
                                    break;
                                case 'ä»Šå¹´åº¦æœ‰çµ¦å–å¾—æ—¥':
                                    const usedPaidLeave = value.replace(/æ—¥/g, '').trim();
                                    if (usedPaidLeave) {
                                        document.getElementById('usedPaidLeaveDays').value = usedPaidLeave;
                                        calculateRemainingPaidLeave();
                                    }
                                    break;
                            }
                        }
                    }
                }
                
                // Parse day settings
                if (line.includes('=== æ›œæ—¥åˆ¥è©³ç´°è¨­å®š ===')) {
                    daySettingsFound = true;
                    
                    // Skip header line
                    let headerSkipped = false;
                    for (let j = i + 1; j < lines.length; j++) {
                        const dayLine = lines[j].trim();
                        if (!dayLine || dayLine.includes('===') || dayLine.includes('ã‚µãƒãƒªãƒ¼')) {
                            break;
                        }
                        
                        // Skip header row (æ›œæ—¥,æ®‹æ¥­é–‹å§‹æ™‚é–“,ä¼‘æ†©æ™‚é–“(åˆ†),æ®‹æ¥­å˜ä¾¡(å††/æ™‚))
                        if (!headerSkipped && dayLine.includes('æ›œæ—¥') && dayLine.includes('æ®‹æ¥­é–‹å§‹æ™‚é–“')) {
                            headerSkipped = true;
                            continue;
                        }
                        
                        const [day, overtimeStart, breakTime, overtimeRate] = dayLine.split(',').map(item => item.replace(/"/g, '').trim());
                        
                        if (day && ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'].includes(day)) {
                            daySettings[day] = {
                                overtimeStart: overtimeStart || '18:00',
                                breakTime: parseInt(breakTime) || 60,
                                overtimeRate: parseInt(overtimeRate) || 1500
                            };
                            
                            // Update UI elements
                            const overtimeInput = document.getElementById(`overtime-${day}`);
                            const breakInput = document.getElementById(`break-${day}`);
                            const rateInput = document.getElementById(`rate-${day}`);
                            
                            if (overtimeInput) overtimeInput.value = daySettings[day].overtimeStart;
                            if (breakInput) breakInput.value = daySettings[day].breakTime;
                            if (rateInput) rateInput.value = daySettings[day].overtimeRate;
                        }
                    }
                }
            }

            if (!employeeSettingsFound) {
                throw new Error('å¾“æ¥­å“¡åŸºæœ¬è¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚ŒãŸå‹¤å‹™å®Ÿç¸¾è¡¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
            }

            // Generate period data if dates were imported
            const startDate = document.getElementById('periodStartDate').value;
            const endDate = document.getElementById('periodEndDate').value;
            if (startDate && endDate) {
                generatePeriodAndMergeData();
            }
        }

        function showWorkReportImportSuccess() {
            const statusDiv = document.getElementById('workReportStatus');
            statusDiv.classList.remove('hidden');
            statusDiv.innerHTML = '<i class="fas fa-check-circle text-green-600 mr-1"></i>å‹¤å‹™å®Ÿç¸¾è¡¨ãŒæ­£å¸¸ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã€è¨­å®šæƒ…å ±ãŒå¾©å…ƒã•ã‚Œã¾ã—ãŸ';
            showMessage('å‹¤å‹™å®Ÿç¸¾è¡¨ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã€å¾“æ¥­å“¡åŸºæœ¬è¨­å®šã¨æ›œæ—¥åˆ¥è©³ç´°è¨­å®šã‚’å¾©å…ƒã—ã¾ã—ãŸ', 'success');
            
            // Clear file input
            document.getElementById('workReportFileInput').value = '';
        }

        function enableAppendExport() {
            const appendButton = document.getElementById('appendExportButton');
            const statusDiv = document.getElementById('appendExportStatus');
            
            if (hasImportedWorkReport) {
                appendButton.disabled = false;
                statusDiv.classList.add('hidden');
            } else {
                appendButton.disabled = true;
                statusDiv.classList.remove('hidden');
            }
        }

        function exportAppendToExisting() {
            if (!hasImportedWorkReport || !importedWorkbook) {
                showMessage('å…ˆã«éå»ã®å‹¤å‹™å®Ÿç¸¾è¡¨ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ãã ã•ã„', 'error');
                return;
            }

            if (processedData.length === 0) {
                showMessage('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            try {
                // Get target month for sheet name
                const targetMonth = document.getElementById('targetMonth').value;
                let sheetName = targetMonth ? targetMonth.replace('-', 'å¹´') + 'æœˆ' : 'æ–°ã—ã„ã‚·ãƒ¼ãƒˆ';
                
                // Ensure unique sheet name
                let counter = 1;
                let originalSheetName = sheetName;
                while (importedWorkbook.SheetNames.includes(sheetName)) {
                    sheetName = originalSheetName + '_' + counter;
                    counter++;
                }

                // Get employee basic settings
                const employeeName = document.getElementById('employeeName').value || 'å¾“æ¥­å“¡';
                const employmentType = document.getElementById('employmentType').value === 'parttime' ? 'ãƒ‘ãƒ¼ãƒˆ' : 'å¸¸å‹¤';
                const isPartTime = document.getElementById('employmentType').value === 'parttime';
                const regularWage = isPartTime ? document.getElementById('regularHourlyWage').value : document.getElementById('baseSalary').value;
                const overtimeWage = isPartTime ? document.getElementById('overtimeHourlyWage').value : document.getElementById('fulltimeOvertimeHourlyWage').value;
                const totalPaidLeave = document.getElementById('totalPaidLeaveDays').value;
                const usedPaidLeave = document.getElementById('usedPaidLeaveDays').value;
                const remainingPaidLeave = document.getElementById('remainingPaidLeaveDays').value;
                const startDate = document.getElementById('periodStartDate').value;
                const endDate = document.getElementById('periodEndDate').value;

                // Get wage and allowance settings based on employment type
                let wageSettings = {};
                try {
                    if (isPartTime) {
                        wageSettings = {
                            regularWage: regularWage,
                            overtimeWage: overtimeWage,
                            commutingAllowanceMonthly: document.getElementById('parttimeCommutingAllowanceMonthly').value,
                            commutingAllowanceDaily: document.getElementById('parttimeCommutingAllowance').value,
                            adjustmentAllowances: getAllowancesData('parttime') || []
                        };
                    } else {
                        wageSettings = {
                            baseSalary: regularWage,
                            overtimeWage: overtimeWage,
                            commutingAllowanceMonthly: document.getElementById('fulltimeCommutingAllowance').value,
                            commutingAllowanceDaily: document.getElementById('fulltimeCommutingAllowanceDaily').value,
                            adjustmentAllowances: getAllowancesData('fulltime') || []
                        };
                    }
                } catch (error) {
                    console.error('Error getting wage settings:', error);
                }

                // Create worksheet data with employee basic settings
                const worksheetData = [
                    ['å‹¤å‹™å®Ÿç¸¾è¡¨'],
                    [''],
                    ['=== å¾“æ¥­å“¡åŸºæœ¬è¨­å®š ==='],
                    ['æ°å', employeeName],
                    ['å¯¾è±¡æœˆ', targetMonth],
                    ['å¯¾è±¡æœŸé–“', `${startDate} ï½ ${endDate}`],
                    ['å‹¤å‹™å½¢æ…‹', employmentType],
                    ['ç· ã‚æ—¥', getClosingDayText()]
                ];
                
                // Add wage settings based on employment type
                if (isPartTime) {
                    worksheetData.push(
                        ['æ™‚çµ¦', wageSettings.regularWage + 'å††/æ™‚'],
                        ['æ®‹æ¥­æ™‚çµ¦', wageSettings.overtimeWage + 'å††/æ™‚'],
                        ['é€šå‹¤æ‰‹å½“ï¼ˆæœˆé¡ï¼‰', wageSettings.commutingAllowanceMonthly + 'å††'],
                        ['é€šå‹¤æ‰‹å½“ï¼ˆæ—¥é¡ï¼‰', wageSettings.commutingAllowanceDaily + 'å††']
                    );
                    // Add multiple adjustment allowances
                    wageSettings.adjustmentAllowances.forEach((allowance, index) => {
                        if (allowance.name || allowance.amount > 0) {
                            worksheetData.push(
                                [`èª¿æ•´æ‰‹å½“${index + 1}å`, allowance.name],
                                [`èª¿æ•´æ‰‹å½“${index + 1}é¡`, allowance.amount + 'å††']
                            );
                        }
                    });
                } else {
                    worksheetData.push(
                        ['åŸºæœ¬çµ¦', wageSettings.baseSalary + 'å††/æœˆ'],
                        ['æ®‹æ¥­æ™‚çµ¦', wageSettings.overtimeWage + 'å††/æ™‚'],
                        ['é€šå‹¤æ‰‹å½“ï¼ˆæœˆé¡ï¼‰', wageSettings.commutingAllowanceMonthly + 'å††'],
                        ['é€šå‹¤æ‰‹å½“ï¼ˆæ—¥é¡ï¼‰', wageSettings.commutingAllowanceDaily + 'å††']
                    );
                    // Add multiple adjustment allowances
                    wageSettings.adjustmentAllowances.forEach((allowance, index) => {
                        if (allowance.name || allowance.amount > 0) {
                            worksheetData.push(
                                [`èª¿æ•´æ‰‹å½“${index + 1}å`, allowance.name],
                                [`èª¿æ•´æ‰‹å½“${index + 1}é¡`, allowance.amount + 'å††']
                            );
                        }
                    });
                }
                
                // Add paid leave settings
                worksheetData.push(
                    ['æœ‰çµ¦æ—¥æ•°', totalPaidLeave + 'æ—¥'],
                    ['ä»Šå¹´åº¦æœ‰çµ¦å–å¾—æ—¥', usedPaidLeave + 'æ—¥'],
                    ['æ®‹ã‚Šæœ‰çµ¦æ—¥æ•°', remainingPaidLeave + 'æ—¥'],
                    [''],
                    ['=== æ›œæ—¥åˆ¥è©³ç´°è¨­å®š ==='],
                    ['æ›œæ—¥', 'æ®‹æ¥­é–‹å§‹æ™‚é–“', 'ä¼‘æ†©æ™‚é–“(åˆ†)', 'æ®‹æ¥­å˜ä¾¡(å††/æ™‚)']
                );

                // Add day settings data
                const days = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'];
                days.forEach(day => {
                    worksheetData.push([
                        day,
                        daySettings[day].overtimeStart,
                        daySettings[day].breakTime,
                        daySettings[day].overtimeRate
                    ]);
                });

                worksheetData.push(['']);

                worksheetData.push(
                    [''],
                    ['ã‚µãƒãƒªãƒ¼'],
                    ['å‡ºå‹¤æ—¥æ•°', summaryData.workDays + 'æ—¥'],
                    ['ä¼‘æ—¥å‡ºå‹¤æ—¥æ•°', summaryData.holidayWorkDays + 'æ—¥'],
                    ['ç·æ®‹æ¥­æ™‚é–“', minutesToTime(summaryData.totalOvertimeMinutes)],
                    ['ç·æ®‹æ¥­è²»ç”¨', 'Â¥' + summaryData.totalOvertimeCost.toLocaleString()]
                );

                if (!isPartTime) {
                    worksheetData.push(['ç·å®Ÿåƒæ™‚é–“', minutesToTime(summaryData.totalWorkMinutes)]);
                }
                
                // Add taxable/non-taxable breakdown
                worksheetData.push(
                    [''],
                    ['èª²ç¨å¯¾è±¡æ”¯çµ¦é¡', 'Â¥' + summaryData.taxableAmount.toLocaleString()],
                    ['éèª²ç¨æ”¯çµ¦é¡', 'Â¥' + summaryData.nonTaxableAmount.toLocaleString()],
                    ['ç·æ”¯çµ¦é¡', 'Â¥' + summaryData.totalSalary.toLocaleString()]
                );

                // Add detailed salary calculation formula
                worksheetData.push(
                    [''],
                    ['=== ç·æ”¯çµ¦é¡è¨ˆç®—å¼ ===']
                );
                
                // Add calculation details based on employment type
                if (isPartTime) {
                    const regularHourlyWage = parseInt(wageSettings.regularWage) || 1000;
                    const overtimeHourlyWage = parseInt(wageSettings.overtimeWage) || 1250;
                    const allowancesData = wageSettings.adjustmentAllowances;
                    const totalHours = (summaryData.totalWorkMinutes / 60).toFixed(2);
                    const overtimeHours = (summaryData.totalOvertimeMinutes / 60).toFixed(2);
                    
                    worksheetData.push(['ã€èª²ç¨å¯¾è±¡æ”¯çµ¦é¡ã€‘']);
                    worksheetData.push(['åŸºæœ¬çµ¦', `${totalHours}æ™‚é–“ Ã— ${regularHourlyWage}å†† = Â¥${summaryData.totalBasicSalary.toLocaleString()}`]);
                    worksheetData.push(['æ®‹æ¥­ä»£', `${overtimeHours}æ™‚é–“ Ã— ${overtimeHourlyWage}å†† = Â¥${summaryData.totalOvertimeCost.toLocaleString()}`]);
                    
                    if (allowancesData.length > 0) {
                        allowancesData.forEach(allowance => {
                            if (allowance.name || allowance.amount > 0) {
                                const displayName = allowance.name || 'èª¿æ•´æ‰‹å½“';
                                worksheetData.push([displayName, `Â¥${allowance.amount.toLocaleString()}`]);
                            }
                        });
                    }
                    
                    if (summaryData.totalSpecialAllowance > 0) {
                        // ç‰¹åˆ¥æ—¥å½“ã®è©³ç´°è¨ˆç®—å¼ã‚’è¡¨ç¤º
                        let specialAllowanceDetails = [];
                        allPeriodData.forEach(row => {
                            if (row.specialAllowance && parseInt(row.specialAllowance) > 0) {
                                specialAllowanceDetails.push(`${row.date}: Â¥${parseInt(row.specialAllowance).toLocaleString()}`);
                            }
                        });
                        const detailsText = specialAllowanceDetails.length > 0 ? ` (${specialAllowanceDetails.join(', ')})` : '';
                        worksheetData.push(['ç‰¹åˆ¥æ—¥å½“åˆè¨ˆ', `Â¥${summaryData.totalSpecialAllowance.toLocaleString()}${detailsText}`]);
                    }
                    
                    worksheetData.push(['èª²ç¨å¯¾è±¡æ”¯çµ¦é¡è¨ˆ', `Â¥${summaryData.taxableAmount.toLocaleString()}`]);
                    worksheetData.push(['']);
                    worksheetData.push(['ã€éèª²ç¨æ”¯çµ¦é¡ã€‘']);
                    // é€šå‹¤æ‰‹å½“ã®è¡¨ç¤ºï¼šæ—¥é¡ã‹æœˆé¡ã‹ã‚’åˆ¤å®šã—ã¦è¡¨ç¤º
                    if (summaryData.commutingAllowanceDaily > 0) {
                        worksheetData.push(['é€šå‹¤æ‰‹å½“åˆè¨ˆ', `Â¥${summaryData.commutingAllowanceDaily.toLocaleString()}/æ—¥ Ã— ${summaryData.workDays}æ—¥ = Â¥${summaryData.nonTaxableAmount.toLocaleString()}`]);
                    } else {
                        worksheetData.push(['é€šå‹¤æ‰‹å½“åˆè¨ˆ', `Â¥${summaryData.nonTaxableAmount.toLocaleString()}`]);
                    }
                    worksheetData.push(['éèª²ç¨æ”¯çµ¦é¡è¨ˆ', `Â¥${summaryData.nonTaxableAmount.toLocaleString()}`]);
                } else {
                    const monthlyBaseSalary = parseInt(wageSettings.baseSalary) || 200000;
                    const overtimeHourlyWage = parseInt(wageSettings.overtimeWage) || 1500;
                    const allowancesData = wageSettings.adjustmentAllowances;
                    const overtimeHours = (summaryData.totalOvertimeMinutes / 60).toFixed(2);
                    
                    worksheetData.push(['ã€èª²ç¨å¯¾è±¡æ”¯çµ¦é¡ã€‘']);
                    worksheetData.push(['åŸºæœ¬çµ¦', `Â¥${monthlyBaseSalary.toLocaleString()}`]);
                    worksheetData.push(['æ®‹æ¥­ä»£', `${overtimeHours}æ™‚é–“ Ã— ${overtimeHourlyWage}å†† = Â¥${summaryData.totalOvertimeCost.toLocaleString()}`]);
                    
                    if (allowancesData.length > 0) {
                        allowancesData.forEach(allowance => {
                            if (allowance.name || allowance.amount > 0) {
                                const displayName = allowance.name || 'èª¿æ•´æ‰‹å½“';
                                worksheetData.push([displayName, `Â¥${allowance.amount.toLocaleString()}`]);
                            }
                        });
                    }
                    
                    if (summaryData.totalSpecialAllowance > 0) {
                        // ç‰¹åˆ¥æ—¥å½“ã®è©³ç´°è¨ˆç®—å¼ã‚’è¡¨ç¤º
                        let specialAllowanceDetails = [];
                        allPeriodData.forEach(row => {
                            if (row.specialAllowance && parseInt(row.specialAllowance) > 0) {
                                specialAllowanceDetails.push(`${row.date}: Â¥${parseInt(row.specialAllowance).toLocaleString()}`);
                            }
                        });
                        const detailsText = specialAllowanceDetails.length > 0 ? ` (${specialAllowanceDetails.join(', ')})` : '';
                        worksheetData.push(['ç‰¹åˆ¥æ—¥å½“åˆè¨ˆ', `Â¥${summaryData.totalSpecialAllowance.toLocaleString()}${detailsText}`]);
                    }
                    
                    worksheetData.push(['èª²ç¨å¯¾è±¡æ”¯çµ¦é¡è¨ˆ', `Â¥${summaryData.taxableAmount.toLocaleString()}`]);
                    worksheetData.push(['']);
                    worksheetData.push(['ã€éèª²ç¨æ”¯çµ¦é¡ã€‘']);
                    // é€šå‹¤æ‰‹å½“ã®è¡¨ç¤ºï¼šæ—¥é¡ã‹æœˆé¡ã‹ã‚’åˆ¤å®šã—ã¦è¡¨ç¤º
                    if (summaryData.commutingAllowanceDaily > 0) {
                        worksheetData.push(['é€šå‹¤æ‰‹å½“åˆè¨ˆ', `Â¥${summaryData.commutingAllowanceDaily.toLocaleString()}/æ—¥ Ã— ${summaryData.workDays}æ—¥ = Â¥${summaryData.nonTaxableAmount.toLocaleString()}`]);
                    } else {
                        worksheetData.push(['é€šå‹¤æ‰‹å½“åˆè¨ˆ', `Â¥${summaryData.nonTaxableAmount.toLocaleString()}`]);
                    }
                    worksheetData.push(['éèª²ç¨æ”¯çµ¦é¡è¨ˆ', `Â¥${summaryData.nonTaxableAmount.toLocaleString()}`]);
                }
                
                worksheetData.push(
                    [''],
                    ['ç·æ”¯çµ¦é¡', `Â¥${summaryData.taxableAmount.toLocaleString()} + Â¥${summaryData.nonTaxableAmount.toLocaleString()} = Â¥${summaryData.totalSalary.toLocaleString()}`]
                );

                // Add headers
                const headerRow = ['æ—¥ä»˜', 'æ›œæ—¥', 'ä¼‘æ—¥å‡ºå‹¤', 'å‡ºå‹¤æ™‚é–“', 'é€€å‹¤æ™‚é–“', 'ä¼‘æ†©æ™‚é–“', 'ç‰¹åˆ¥æ—¥å½“', 'å®Ÿåƒæ™‚é–“', 'æ®‹æ¥­æ™‚é–“', 'æ®‹æ¥­è²»ç”¨'];
                if (isPartTime) {
                    headerRow.push('åŸºæœ¬çµ¦');
                }

                worksheetData.push([''], ['è©³ç´°'], headerRow);

                // Add data rows
                processedData.forEach(row => {
                    const dataRow = [
                        row.date,
                        row.dayOfWeek,
                        row.isHolidayWork ? 'â—‹' : '',
                        row.startTime,
                        row.endTime,
                        row.breakDuration || '',
                        row.specialAllowance || '',
                        row.actualWorkTime,
                        row.overtimeHours,
                        row.overtimeCost > 0 ? row.overtimeCost : ''
                    ];

                    if (isPartTime) {
                        dataRow.push(row.basicSalary > 0 ? row.basicSalary : '');
                    }

                    worksheetData.push(dataRow);
                });

                // Create new worksheet and add to existing workbook
                const newWorksheet = XLSX.utils.aoa_to_sheet(worksheetData);
                XLSX.utils.book_append_sheet(importedWorkbook, newWorksheet, sheetName);

                // Generate file name
                const baseFileName = importedFileName.replace(/\.(xlsx|csv)$/i, '');
                const newFileName = `${baseFileName}_updated.xlsx`;

                // Save the updated workbook
                XLSX.writeFile(importedWorkbook, newFileName);
                
                showMessage(`æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã«ã€Œ${sheetName}ã€ã‚·ãƒ¼ãƒˆã‚’è¿½åŠ ã—ã¦ä¿å­˜ã—ã¾ã—ãŸ`, 'success');

            } catch (error) {
                showMessage('ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
                console.error('Export error:', error);
            }
        }

        function clearWorkReportSelection() {
            const fileInput = document.getElementById('workReportFileInput');
            const statusDiv = document.getElementById('workReportStatus');
            
            fileInput.value = '';
            statusDiv.classList.add('hidden');
            
            // Clear imported workbook information
            importedWorkbook = null;
            importedFileName = '';
            hasImportedWorkReport = false;
            enableAppendExport();
            
            showMessage('é¸æŠã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'info');
        }

        function toggleHourlyWage() {
            const employmentType = document.getElementById('employmentType').value;
            const fulltimeContainer = document.getElementById('fulltimeWageContainer');
            const parttimeContainer = document.getElementById('parttimeWageContainer');
            
            if (employmentType === 'fulltime') {
                fulltimeContainer.style.display = 'block';
                parttimeContainer.style.display = 'none';
            } else {
                fulltimeContainer.style.display = 'none';
                parttimeContainer.style.display = 'block';
            }
            
            if (processedData.length > 0) {
                processData();
            }
        }

        function getClosingDayText() {
            const closingDate = document.getElementById('closingDate').value;
            if (closingDate === 'monthEnd') {
                return 'æœˆæœ«';
            }
            return closingDate ? `${closingDate}æ—¥` : 'æœªè¨­å®š';
        }

        function autoCalculatePeriod() {
            const targetMonth = document.getElementById('targetMonth').value;
            const closingDate = document.getElementById('closingDate').value;
            
            if (!targetMonth) return;
            
            const [year, month] = targetMonth.split('-').map(Number);
            
            let startDateStr, endDateStr;
            
            if (closingDate === 'monthEnd') {
                // æœˆæœ«ç· ã‚ã®å ´åˆï¼šå¯¾è±¡å¹´æœˆã®1æ—¥ï½å¯¾è±¡å¹´æœˆã®æœˆæœ«
                startDateStr = `${year}-${month.toString().padStart(2, '0')}-01`;
                const lastDay = new Date(year, month, 0).getDate();
                endDateStr = `${year}-${month.toString().padStart(2, '0')}-${lastDay.toString().padStart(2, '0')}`;
            } else if (closingDate) {
                // æ—¥ä»˜æŒ‡å®šã®å ´åˆï¼šå‰æœˆã®ç· ã‚æ—¥ç¿Œæ—¥ï½å½“æœˆã®ç· ã‚æ—¥
                const closingDay = parseInt(closingDate);
                
                // çµ‚äº†æ—¥ï¼šå½“æœˆã®ç· ã‚æ—¥
                endDateStr = `${year}-${month.toString().padStart(2, '0')}-${closingDay.toString().padStart(2, '0')}`;
                
                // é–‹å§‹æ—¥ã®è¨ˆç®—
                let startYear = year;
                let startMonth = month - 1;
                let startDay = closingDay + 1;
                
                // å‰æœˆã®èª¿æ•´
                if (startMonth === 0) {
                    startMonth = 12;
                    startYear = year - 1;
                }
                
                // å‰æœˆã®æœ€çµ‚æ—¥ã‚’å–å¾—
                const prevMonthLastDay = new Date(startYear, startMonth, 0).getDate();
                
                if (closingDay > prevMonthLastDay) {
                    // å‰æœˆã«ç· ã‚æ—¥ãŒå­˜åœ¨ã—ãªã„å ´åˆã€å½“æœˆ1æ—¥ã‚’é–‹å§‹æ—¥
                    startDateStr = `${year}-${month.toString().padStart(2, '0')}-01`;
                } else if (startDay > prevMonthLastDay) {
                    // ç¿Œæ—¥ãŒæœˆã‚’è¶…ãˆã‚‹å ´åˆã€å½“æœˆ1æ—¥ã‚’é–‹å§‹æ—¥
                    startDateStr = `${year}-${month.toString().padStart(2, '0')}-01`;
                } else {
                    // é€šå¸¸ã®å ´åˆï¼šå‰æœˆã®ç· ã‚æ—¥ç¿Œæ—¥
                    startDateStr = `${startYear}-${startMonth.toString().padStart(2, '0')}-${startDay.toString().padStart(2, '0')}`;
                }
            } else {
                return; // ç· ã‚æ—¥ãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
            }
            
            // æ—¥ä»˜ã‚’å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¨­å®š
            document.getElementById('periodStartDate').value = startDateStr;
            document.getElementById('periodEndDate').value = endDateStr;
            
            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
            console.log('Auto calculated period:', { startDateStr, endDateStr });
            
            // æœŸé–“è¨­å®šå¾Œã«ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•ç”Ÿæˆ
            generatePeriodAndMergeData();
        }

        function calculateRemainingPaidLeave() {
            const totalDays = parseInt(document.getElementById('totalPaidLeaveDays').value) || 0;
            const usedDays = parseInt(document.getElementById('usedPaidLeaveDays').value) || 0;
            const remainingDays = Math.max(0, totalDays - usedDays);
            
            document.getElementById('remainingPaidLeaveDays').value = remainingDays;
        }

        function recalculateIfNeeded() {
            if (processedData.length > 0) {
                processData();
            }
        }

        function updateDaySetting(day, setting, value) {
            daySettings[day][setting] = setting === 'breakTime' || setting === 'overtimeRate' ? 
                                      parseInt(value) || 0 : value;
            
            if (allPeriodData.length > 0) {
                processData();
            }
        }

        function applyBulkSettings() {
            const overtimeStart = document.getElementById('bulkOvertimeStart').value;
            const breakTime = parseInt(document.getElementById('bulkBreakTime').value) || 60;
            const overtimeRate = parseInt(document.getElementById('bulkOvertimeRate').value) || 1500;

            const days = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'];
            
            days.forEach(day => {
                daySettings[day].overtimeStart = overtimeStart;
                daySettings[day].breakTime = breakTime;
                daySettings[day].overtimeRate = overtimeRate;
                
                document.getElementById(`overtime-${day}`).value = overtimeStart;
                document.getElementById(`break-${day}`).value = breakTime;
                document.getElementById(`rate-${day}`).value = overtimeRate;
            });

            showMessage('å…¨æ›œæ—¥ã®è¨­å®šã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
            
            if (allPeriodData.length > 0) {
                processData();
            }
        }

        function applyCorrectionTime() {
            const timeType = document.getElementById('correctionTimeType').value;
            const baseTime = document.getElementById('correctionBaseTime').value;
            const newTime = document.getElementById('correctionNewTime').value;
            const condition = document.getElementById('correctionCondition').value;
            
            if (!baseTime) {
                showMessage('åŸºæº–æ™‚åˆ»ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            if (!newTime) {
                showMessage('å¤‰æ›´å¾Œæ™‚åˆ»ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            if (allPeriodData.length === 0) {
                showMessage('å…ˆã«å¯¾è±¡æœŸé–“ã‚’è¨­å®šã—ã¦ãã ã•ã„', 'error');
                return;
            }

            const baseMinutes = timeToMinutes(baseTime);
            const newMinutes = timeToMinutes(newTime);
            
            if (baseMinutes === null) {
                showMessage('æœ‰åŠ¹ãªåŸºæº–æ™‚åˆ»ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            if (newMinutes === null) {
                showMessage('æœ‰åŠ¹ãªå¤‰æ›´å¾Œæ™‚åˆ»ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            let changedCount = 0;
            let eligibleRows = 0;

            // Apply correction to current period data
            allPeriodData.forEach((row, index) => {
                // Check the selected time type
                const targetTime = row[timeType];
                
                if (targetTime && targetTime.trim() !== '' && targetTime !== '---') {
                    eligibleRows++;
                    
                    const targetMinutes = timeToMinutes(targetTime);
                    if (targetMinutes !== null) {
                        let shouldChange = false;
                        
                        // Check condition: later (é…ã) or earlier (æ—©ã)
                        if (condition === 'later' && targetMinutes > baseMinutes) {
                            shouldChange = true;
                        } else if (condition === 'earlier' && targetMinutes < baseMinutes) {
                            shouldChange = true;
                        }
                        
                        if (shouldChange) {
                            const oldTime = row[timeType];
                            row[timeType] = newTime;
                            changedCount++;
                            
                            console.log(`Changed row ${index} ${timeType}: ${oldTime} â†’ ${newTime}`);
                            
                            // Also update original CSV data if it exists
                            const originalIndex = originalCsvData.findIndex(orig => 
                                normalizeDate(orig.date) === normalizeDate(row.date)
                            );
                            
                            if (originalIndex !== -1) {
                                originalCsvData[originalIndex][timeType] = newTime;
                            }
                        }
                    }
                }
            });

            console.log(`Eligible rows: ${eligibleRows}, Changed: ${changedCount}`);

            if (changedCount > 0) {
                // Update csvData to maintain consistency
                csvData = [...allPeriodData];
                
                // Trigger recalculation
                processData();
                
                const timeTypeName = timeType === 'startTime' ? 'å‡ºå‹¤æ™‚é–“' : 'é€€å‹¤æ™‚é–“';
                const conditionText = condition === 'later' ? 'ã‚ˆã‚Šé…ã„' : 'ã‚ˆã‚Šæ—©ã„';
                showMessage(`${changedCount}ä»¶ã®${timeTypeName}ã‚’${newTime}ã«å¤‰æ›´ã—ã¾ã—ãŸï¼ˆåŸºæº–æ™‚åˆ»${baseTime}${conditionText}æ™‚åˆ»ï¼‰`, 'success');
            } else {
                if (eligibleRows === 0) {
                    const timeTypeName = timeType === 'startTime' ? 'å‡ºå‹¤æ™‚é–“' : 'é€€å‹¤æ™‚é–“';
                    showMessage(`${timeTypeName}ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“`, 'error');
                } else {
                    const timeTypeName = timeType === 'startTime' ? 'å‡ºå‹¤æ™‚é–“' : 'é€€å‹¤æ™‚é–“';
                    const conditionText = condition === 'later' ? 'ã‚ˆã‚Šé…ã„' : 'ã‚ˆã‚Šæ—©ã„';
                    showMessage(`åŸºæº–æ™‚åˆ»${baseTime}${conditionText}${timeTypeName}ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ`, 'error');
                }
            }
        }

        function applyBulkBreakTime() {
            const newBreakTime = document.getElementById('bulkBreakTimeSelect').value;
            
            if (!newBreakTime || newBreakTime < 0) {
                showMessage('æœ‰åŠ¹ãªä¼‘æ†©æ™‚é–“ï¼ˆåˆ†ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            if (allPeriodData.length === 0) {
                showMessage('å…ˆã«å¯¾è±¡æœŸé–“ã‚’è¨­å®šã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            let changedCount = 0;
            let attendanceRows = 0;
            
            // Date normalization function
            const normalizeDate = (dateStr) => {
                if (!dateStr) return '';
                
                if (dateStr.match(/^\d{4}\/\d{1,2}\/\d{1,2}$/)) {
                    const parts = dateStr.split('/');
                    return parts[0] + '-' + parts[1].padStart(2, '0') + '-' + parts[2].padStart(2, '0');
                } else if (dateStr.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                    const parts = dateStr.split('/');
                    return parts[2] + '-' + parts[0].padStart(2, '0') + '-' + parts[1].padStart(2, '0');
                } else if (dateStr.match(/^\d{4}-\d{1,2}-\d{1,2}$/)) {
                    const parts = dateStr.split('-');
                    return parts[0] + '-' + parts[1].padStart(2, '0') + '-' + parts[2].padStart(2, '0');
                }
                return dateStr;
            };
            
            // Apply break time change to current period data - only for attendance days
            allPeriodData.forEach((row, index) => {
                // Check if this is an attendance day (has startTime and endTime)
                const hasStartTime = row.startTime && row.startTime.trim() !== '' && row.startTime !== '---';
                const hasEndTime = row.endTime && row.endTime.trim() !== '' && row.endTime !== '---';
                
                if (hasStartTime && hasEndTime) {
                    attendanceRows++;
                    
                    const oldBreakTime = row.breakDuration || '0';
                    row.breakDuration = newBreakTime.toString();
                    changedCount++;
                    
                    console.log(`Changed row ${index} breakDuration: ${oldBreakTime} â†’ "${row.breakDuration}"`);
                    
                    // Also update original CSV data if it exists
                    if (originalCsvData && originalCsvData.length > 0) {
                        const originalIndex = originalCsvData.findIndex(orig => 
                            normalizeDate(orig.date) === normalizeDate(row.date)
                        );
                        
                        if (originalIndex !== -1) {
                            originalCsvData[originalIndex].breakDuration = newBreakTime.toString();
                        }
                    }
                }
            });
            
            console.log(`Attendance rows: ${attendanceRows}, Changed: ${changedCount}`);
            
            if (changedCount > 0) {
                // Update csvData to maintain consistency
                csvData = [...allPeriodData];
                
                // Force recalculation by clearing processedData first
                processedData = [];
                
                // Trigger recalculation
                try {
                    processData();
                    showMessage(`${changedCount}ä»¶ã®å‡ºå‹¤æ—¥ã®ä¼‘æ†©æ™‚é–“ã‚’${newBreakTime}åˆ†ã«å¤‰æ›´ã—ã¾ã—ãŸ`, 'success');
                } catch (error) {
                    console.error('Error during recalculation:', error);
                    showMessage('è¨ˆç®—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
                }
            } else {
                if (attendanceRows === 0) {
                    showMessage('å‡ºå‹¤ãƒ‡ãƒ¼ã‚¿ï¼ˆå‡ºå‹¤æ™‚é–“ãƒ»é€€å‹¤æ™‚é–“ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹æ—¥ï¼‰ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                } else {
                    showMessage('å¤‰æ›´å¯¾è±¡ã¨ãªã‚‹å‡ºå‹¤æ—¥ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ', 'error');
                }
            }
        }

        function handleFile(file) {
            const fileName = file.name.toLowerCase();
            
            if (!fileName.endsWith('.csv') && !fileName.endsWith('.xlsx')) {
                showMessage('CSV ã¾ãŸã¯ Excel ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
                return;
            }

            if (fileName.endsWith('.xlsx')) {
                // Handle Excel file
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const csvData = XLSX.utils.sheet_to_csv(worksheet);
                        
                        parseCSV(csvData);
                        
                    } catch (error) {
                        showMessage('Excelãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
                    }
                };
                reader.readAsArrayBuffer(file);
            } else {
                // Handle CSV file
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        parseCSV(e.target.result);
                    } catch (error) {
                        // If Shift_JIS fails, try UTF-8
                        if (error.message.includes('æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“')) {
                            console.log('Shift_JISã§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã€UTF-8ã§å†è©¦è¡Œã—ã¾ã™');
                            const utf8Reader = new FileReader();
                            utf8Reader.onload = function(e2) {
                                try {
                                    parseCSV(e2.target.result);
                                } catch (error2) {
                                    showMessage('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆShift_JISã¨UTF-8ã®ä¸¡æ–¹ã§è©¦è¡Œï¼‰: ' + error2.message, 'error');
                                }
                            };
                            utf8Reader.readAsText(file, 'UTF-8');
                        } else {
                            showMessage('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
                        }
                    }
                };
                reader.readAsText(file, 'Shift_JIS');
            }
        }

        function parseCSV(text) {
            console.log('Debug: parseCSVé–‹å§‹ - ãƒ†ã‚­ã‚¹ãƒˆé•·:', text.length);
            const lines = text.split('\n').filter(line => line.trim());
            console.log('Debug: å‡¦ç†å¯¾è±¡è¡Œæ•°:', lines.length);
            console.log('Debug: æœ€åˆã®5è¡Œ:', lines.slice(0, 5));
            
            if (lines.length < 1) {
                showMessage('ãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã§ã™', 'error');
                return;
            }

            originalCsvData = [];
            let isExportedFile = false;
            let employeeSettingsFound = false;
            
            // Check if this is an exported work report with employee settings
            let daySettingsFound = false;
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                // Parse employee basic settings
                if (line.includes('=== å¾“æ¥­å“¡åŸºæœ¬è¨­å®š ===')) {
                    isExportedFile = true;
                    employeeSettingsFound = true;
                    
                    // Parse employee settings from exported file
                    for (let j = i + 1; j < lines.length; j++) {
                        const settingLine = lines[j].trim();
                        if (!settingLine || settingLine.includes('===') || settingLine.includes('ã‚µãƒãƒªãƒ¼')) {
                            break;
                        }
                        
                        const [key, value] = settingLine.split(',').map(item => item.replace(/"/g, '').trim());
                        if (key && value) {
                            switch (key) {
                                case 'æ°å':
                                    document.getElementById('employeeName').value = value;
                                    break;
                                case 'å¯¾è±¡æœˆ':
                                    document.getElementById('targetMonth').value = value;
                                    break;
                                case 'å¯¾è±¡æœŸé–“':
                                    // Extract start and end dates from "YYYY-MM-DD ï½ YYYY-MM-DD" format
                                    const periodMatch = value.match(/(\d{4}-\d{2}-\d{2})\s*ï½\s*(\d{4}-\d{2}-\d{2})/);
                                    if (periodMatch) {
                                        document.getElementById('periodStartDate').value = periodMatch[1];
                                        document.getElementById('periodEndDate').value = periodMatch[2];
                                    }
                                    break;
                                case 'å‹¤å‹™å½¢æ…‹':
                                    const employmentType = value === 'ãƒ‘ãƒ¼ãƒˆ' ? 'parttime' : 'fulltime';
                                    document.getElementById('employmentType').value = employmentType;
                                    toggleHourlyWage(); // Update UI based on employment type
                                    break;
                                case 'é€šå¸¸æ™‚çµ¦':
                                    const regularWage = value.replace(/[å††\/æ™‚]/g, '').trim();
                                    if (regularWage) {
                                        document.getElementById('regularHourlyWage').value = regularWage;
                                    }
                                    break;
                                case 'æ®‹æ¥­æ™‚çµ¦':
                                    const overtimeWage = value.replace(/[å††\/æ™‚]/g, '').trim();
                                    if (overtimeWage) {
                                        document.getElementById('overtimeHourlyWage').value = overtimeWage;
                                    }
                                    break;
                                case 'æœ‰çµ¦æ—¥æ•°':
                                    const totalPaidLeave = value.replace(/æ—¥/g, '').trim();
                                    if (totalPaidLeave) {
                                        document.getElementById('totalPaidLeaveDays').value = totalPaidLeave;
                                    }
                                    break;
                                case 'ä»Šå¹´åº¦æœ‰çµ¦å–å¾—æ—¥':
                                    const usedPaidLeave = value.replace(/æ—¥/g, '').trim();
                                    if (usedPaidLeave) {
                                        document.getElementById('usedPaidLeaveDays').value = usedPaidLeave;
                                        calculateRemainingPaidLeave(); // Update remaining days
                                    }
                                    break;
                            }
                        }
                    }
                }
                
                // Parse day settings
                if (line.includes('=== æ›œæ—¥åˆ¥è©³ç´°è¨­å®š ===')) {
                    daySettingsFound = true;
                    
                    // Skip header line
                    let headerSkipped = false;
                    for (let j = i + 1; j < lines.length; j++) {
                        const dayLine = lines[j].trim();
                        if (!dayLine || dayLine.includes('===') || dayLine.includes('ã‚µãƒãƒªãƒ¼')) {
                            break;
                        }
                        
                        // Skip header row (æ›œæ—¥,æ®‹æ¥­é–‹å§‹æ™‚é–“,ä¼‘æ†©æ™‚é–“(åˆ†),æ®‹æ¥­å˜ä¾¡(å††/æ™‚))
                        if (!headerSkipped && dayLine.includes('æ›œæ—¥') && dayLine.includes('æ®‹æ¥­é–‹å§‹æ™‚é–“')) {
                            headerSkipped = true;
                            continue;
                        }
                        
                        const [day, overtimeStart, breakTime, overtimeRate] = dayLine.split(',').map(item => item.replace(/"/g, '').trim());
                        
                        if (day && ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'].includes(day)) {
                            daySettings[day] = {
                                overtimeStart: overtimeStart || '18:00',
                                breakTime: parseInt(breakTime) || 60,
                                overtimeRate: parseInt(overtimeRate) || 1500
                            };
                            
                            // Update UI elements
                            const overtimeInput = document.getElementById(`overtime-${day}`);
                            const breakInput = document.getElementById(`break-${day}`);
                            const rateInput = document.getElementById(`rate-${day}`);
                            
                            if (overtimeInput) overtimeInput.value = daySettings[day].overtimeStart;
                            if (breakInput) breakInput.value = daySettings[day].breakTime;
                            if (rateInput) rateInput.value = daySettings[day].overtimeRate;
                        }
                    }
                }
            }
            
            // Find the start of detailed data
            let dataStartIndex = 0; // Start from beginning for regular CSV
            if (isExportedFile) {
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line.includes('æ—¥ä»˜,æ›œæ—¥') || line.includes('æ—¥ä»˜,å‹¤å‹™åŒºåˆ†')) {
                        dataStartIndex = i + 1;
                        break;
                    }
                }
            } else {
                // For regular CSV, look for header row and start after it
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line.includes('æ—¥ä»˜') && (line.includes('å‹¤å‹™åŒºåˆ†') || line.includes('å‡ºå‹¤') || line.includes('æ™‚é–“'))) {
                        dataStartIndex = i + 1;
                        break;
                    }
                }
            }
            console.log('Debug: dataStartIndex:', dataStartIndex);
            
            // Parse work data
            console.log('Debug: ãƒ‡ãƒ¼ã‚¿è§£æé–‹å§‹ - é–‹å§‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:', dataStartIndex);
            for (let i = dataStartIndex; i < lines.length; i++) {
                const cells = lines[i].split(',').map(cell => cell.replace(/"/g, '').trim());
                console.log(`Debug: è¡Œ${i}: ã‚»ãƒ«æ•°=${cells.length}, å†…å®¹:`, cells.slice(0, 5));
                
                // Skip empty lines or summary lines
                if (cells.length < 3 || !cells[0] || cells[0].includes('=') || cells[0].includes('ã‚µãƒãƒªãƒ¼') || cells[0].includes('è©³ç´°')) {
                    console.log(`Debug: è¡Œ${i}ã‚’ã‚¹ã‚­ãƒƒãƒ— - æ¡ä»¶ä¸é©åˆ`);
                    continue;
                }
                
                // More flexible date format check - allow various date formats
                const dateFormats = [
                    /^\d{4}-\d{2}-\d{2}$/,     // YYYY-MM-DD
                    /^\d{4}\/\d{1,2}\/\d{1,2}$/,  // YYYY/MM/DD or YYYY/M/D
                    /^\d{1,2}\/\d{1,2}\/\d{4}$/,  // MM/DD/YYYY or M/D/YYYY
                    /^\d{4}\.\d{1,2}\.\d{1,2}$/   // YYYY.MM.DD or YYYY.M.D
                ];
                
                const isValidDate = dateFormats.some(format => format.test(cells[0]));
                if (!isValidDate && cells[0] !== 'æ—¥ä»˜') { // Skip header row but allow date data
                    continue;
                }
                
                // Skip header row
                if (cells[0] === 'æ—¥ä»˜' || cells[0].includes('æ—¥ä»˜')) {
                    continue;
                }
                
                if (isExportedFile) {
                    // Format: æ—¥ä»˜,æ›œæ—¥,ä¼‘æ—¥å‡ºå‹¤,å‡ºå‹¤æ™‚é–“,é€€å‹¤æ™‚é–“,ä¼‘æ†©æ™‚é–“,ç‰¹åˆ¥æ—¥å½“,å®Ÿåƒæ™‚é–“,æ®‹æ¥­æ™‚é–“,æ®‹æ¥­è²»ç”¨[,åŸºæœ¬çµ¦]
                    if (cells.length >= 6) {
                        originalCsvData.push({
                            date: cells[0] || '',
                            workClass: 'é€šå¸¸', // Default for exported files
                            workType: 'ãƒ•ãƒ«ã‚¿ã‚¤ãƒ ', // Default for exported files
                            startTime: cells[3] || '',
                            endTime: cells[4] || '',
                            breakTime: cells[5] || '',
                            breakDuration: cells[5] || '',
                            overtime: '',
                            vacation: '',
                            isHolidayWork: cells[2] === 'â—‹'
                        });
                    }
                } else {
                    // Regular CSV format: æ—¥ä»˜,å‹¤å‹™åŒºåˆ†,å‹¤å‹™å½¢æ…‹,å‡ºå‹¤æ™‚é–“,é€€å‹¤æ™‚é–“,ä¼‘æ†©æ™‚é–“,æ®‹æ¥­æ™‚é–“,æœ‰çµ¦
                    // More flexible - allow fewer columns for basic timecard data
                    if (cells.length >= 5) { // Reduced from 8 to 5 for basic date, start, end time data
                        originalCsvData.push({
                            date: cells[0] || '',
                            workClass: cells[1] || 'é€šå¸¸',
                            workType: cells[2] || 'ãƒ•ãƒ«ã‚¿ã‚¤ãƒ ',
                            startTime: cells[3] || '',
                            endTime: cells[4] || '',
                            breakTime: cells[5] || '',
                            breakDuration: cells[5] || '',
                            overtime: cells[6] || '',
                            vacation: cells[7] || '',
                            isHolidayWork: false
                        });
                    }
                }
            }

            if (originalCsvData.length === 0) {
                console.log('Debug: ãƒ‘ãƒ¼ã‚¹ã—ãŸãƒ©ã‚¤ãƒ³æ•°:', lines.length);
                console.log('Debug: isExportedFile:', isExportedFile);
                console.log('Debug: dataStartIndex:', dataStartIndex);
                console.log('Debug: æœ€åˆã®æ•°è¡Œ:', lines.slice(0, 5));
                
                showMessage(`æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚CSVãƒ•ã‚¡ã‚¤ãƒ«ã®å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\næœŸå¾…ã•ã‚Œã‚‹å½¢å¼: æ—¥ä»˜,å‹¤å‹™åŒºåˆ†,å‹¤å‹™å½¢æ…‹,å‡ºå‹¤æ™‚é–“,é€€å‹¤æ™‚é–“,ä¼‘æ†©æ™‚é–“,æ®‹æ¥­æ™‚é–“,æœ‰çµ¦`, 'error');
                return;
            }

            let message = `${originalCsvData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`;
            if (employeeSettingsFound && daySettingsFound) {
                message = `${originalCsvData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã€å¾“æ¥­å“¡åŸºæœ¬è¨­å®šã€æ›œæ—¥åˆ¥è©³ç´°è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`;
            } else if (employeeSettingsFound) {
                message = `${originalCsvData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã¨å¾“æ¥­å“¡åŸºæœ¬è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`;
            } else if (daySettingsFound) {
                message = `${originalCsvData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã¨æ›œæ—¥åˆ¥è©³ç´°è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`;
            }
            showMessage(message, 'success');
            
            // Merge with period data and process
            generatePeriodAndMergeData();
        }

        function processData() {
            if (!allPeriodData || allPeriodData.length === 0) {
                return;
            }

            // Update csvData from allPeriodData to ensure consistency
            csvData = [...allPeriodData];

            processedData = [];
            let workDays = 0;
            let holidayWorkDays = 0;
            let totalOvertimeMinutes = 0;
            let totalOvertimeCost = 0;
            let totalWorkMinutes = 0;
            let totalBasicSalary = 0;

            const isPartTime = document.getElementById('employmentType').value === 'parttime';
            
            // Get wage settings based on employment type
            let regularHourlyWage, overtimeHourlyWage, monthlyBaseSalary, commutingAllowanceMonthly, commutingAllowanceDaily, adjustmentAllowancesTotal;
            if (isPartTime) {
                regularHourlyWage = parseInt(document.getElementById('regularHourlyWage').value) || 1000;
                overtimeHourlyWage = parseInt(document.getElementById('overtimeHourlyWage').value) || 1250;
                commutingAllowanceMonthly = parseInt(document.getElementById('parttimeCommutingAllowanceMonthly').value) || 0;
                commutingAllowanceDaily = parseInt(document.getElementById('parttimeCommutingAllowance').value) || 0;
                adjustmentAllowancesTotal = getAllowancesTotal('parttime');
            } else {
                monthlyBaseSalary = parseInt(document.getElementById('baseSalary').value) || 200000;
                overtimeHourlyWage = parseInt(document.getElementById('fulltimeOvertimeHourlyWage').value) || 1500;
                commutingAllowanceMonthly = parseInt(document.getElementById('fulltimeCommutingAllowance').value) || 0;
                commutingAllowanceDaily = parseInt(document.getElementById('fulltimeCommutingAllowanceDaily').value) || 0;
                adjustmentAllowancesTotal = getAllowancesTotal('fulltime');
            }

            allPeriodData.forEach((row, index) => {
                if (!row.date) return;

                const date = new Date(row.date);
                const dayOfWeek = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][date.getDay()];
                
                let displayStartTime = row.startTime || '';
                let displayEndTime = row.endTime || '';
                
                let actualWorkTime = '';
                let overtimeHours = '';
                let overtimeCost = 0;
                let basicSalary = 0;

                // Only calculate if both start and end times exist
                if (displayStartTime && displayEndTime && displayStartTime !== '---' && displayEndTime !== '---' && 
                    displayStartTime !== '' && displayEndTime !== '') {
                    
                    // Fixed: Count holiday work and work days separately
                    if (row.isHolidayWork) {
                        holidayWorkDays++;
                    } else {
                        workDays++;  // Only count as regular work day if NOT holiday work
                    }

                    const startMinutes = timeToMinutes(displayStartTime);
                    const endMinutes = timeToMinutes(displayEndTime);
                    
                    if (startMinutes !== null && endMinutes !== null && endMinutes > startMinutes) {
                        // Get break time - prioritize individual row's breakDuration, fallback to day setting
                        let breakMinutes = 0;
                        if (row.breakDuration && row.breakDuration !== '' && row.breakDuration !== '---') {
                            // Convert break duration from various formats to minutes
                            breakMinutes = parseBreakDuration(row.breakDuration);
                        } else {
                            // Fallback to day setting
                            breakMinutes = parseInt(daySettings[dayOfWeek]?.breakTime) || 60;
                        }
                        
                        // Calculate actual work time (total time - break time)
                        const totalMinutes = endMinutes - startMinutes;
                        const actualWorkMinutes = Math.max(0, totalMinutes - breakMinutes);
                        
                        if (actualWorkMinutes > 0) {
                            actualWorkTime = minutesToTime(actualWorkMinutes);
                            totalWorkMinutes += actualWorkMinutes;

                            // Calculate basic salary for part-time workers
                            if (isPartTime) {
                                basicSalary = Math.round((actualWorkMinutes / 60) * regularHourlyWage);
                                totalBasicSalary += basicSalary;
                            }

                            // Calculate overtime
                            const overtimeStartMinutes = timeToMinutes(daySettings[dayOfWeek]?.overtimeStart || '18:00');
                            if (endMinutes > overtimeStartMinutes) {
                                const overtimeMinutes = Math.max(0, endMinutes - overtimeStartMinutes);
                                if (overtimeMinutes > 0) {
                                    overtimeHours = minutesToTime(overtimeMinutes);
                                    
                                    overtimeCost = Math.round((overtimeMinutes / 60) * overtimeHourlyWage);
                                    
                                    totalOvertimeMinutes += overtimeMinutes;
                                    totalOvertimeCost += overtimeCost;
                                }
                            }
                        }
                    }
                }

                processedData.push({
                    index: index,
                    date: row.date,
                    dayOfWeek: dayOfWeek,
                    startTime: displayStartTime,
                    endTime: displayEndTime,
                    breakDuration: row.breakDuration || '', // å€‹åˆ¥ä¼‘æ†©æ™‚é–“ã‚’è¿½åŠ 
                    specialAllowance: row.specialAllowance || '', // ç‰¹åˆ¥æ—¥å½“ã‚’è¿½åŠ 
                    actualWorkTime: actualWorkTime,
                    overtimeHours: overtimeHours,
                    overtimeCost: overtimeCost,
                    basicSalary: basicSalary,
                    isHolidayWork: row.isHolidayWork || false
                });
            });

            // Calculate special allowance total
            let totalSpecialAllowance = 0;
            allPeriodData.forEach(row => {
                if (row.specialAllowance) {
                    totalSpecialAllowance += parseInt(row.specialAllowance) || 0;
                }
            });

            // Calculate taxable and non-taxable amounts separately
            let nonTaxableAmount; // éèª²ç¨æ”¯çµ¦é¡ï¼ˆé€šå‹¤æ‰‹å½“ã®ã¿ï¼‰
            // é€šå‹¤æ‰‹å½“ã®è¨ˆç®—ï¼šæ—¥é¡ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯æ—¥é¡Ã—å‹¤å‹™æ—¥æ•°ã€ãã†ã§ãªã‘ã‚Œã°æœˆé¡
            if (commutingAllowanceDaily > 0) {
                nonTaxableAmount = commutingAllowanceDaily * workDays;
            } else {
                nonTaxableAmount = commutingAllowanceMonthly;
            }
            let taxableAmount; // èª²ç¨å¯¾è±¡æ”¯çµ¦é¡
            
            if (isPartTime) {
                taxableAmount = totalBasicSalary + totalOvertimeCost + adjustmentAllowancesTotal + totalSpecialAllowance;
            } else {
                taxableAmount = monthlyBaseSalary + totalOvertimeCost + adjustmentAllowancesTotal + totalSpecialAllowance;
            }
            
            const finalTotalSalary = taxableAmount + nonTaxableAmount; // ç·æ”¯çµ¦é¡

            summaryData = {
                workDays: workDays,
                holidayWorkDays: holidayWorkDays,
                totalOvertimeMinutes: totalOvertimeMinutes,
                totalOvertimeCost: totalOvertimeCost,
                totalWorkMinutes: totalWorkMinutes,
                totalBasicSalary: isPartTime ? totalBasicSalary : monthlyBaseSalary,
                commutingAllowanceMonthly: commutingAllowanceMonthly,
                commutingAllowanceDaily: commutingAllowanceDaily,
                adjustmentAllowancesTotal: adjustmentAllowancesTotal,
                totalSpecialAllowance: totalSpecialAllowance, // ç‰¹åˆ¥æ—¥å½“åˆè¨ˆ
                taxableAmount: taxableAmount,        // èª²ç¨å¯¾è±¡æ”¯çµ¦é¡
                nonTaxableAmount: nonTaxableAmount,  // éèª²ç¨æ”¯çµ¦é¡
                totalSalary: finalTotalSalary        // ç·æ”¯çµ¦é¡
            };

            updateSummary();
            updateCalculationFormula();
            updateTable();
            document.getElementById('results').classList.remove('hidden');
        }

        function timeToMinutes(timeStr) {
            if (!timeStr || timeStr === '---' || timeStr === '') return null;
            
            const parts = timeStr.split(':');
            if (parts.length !== 2) return null;
            
            const hours = parseInt(parts[0]);
            const minutes = parseInt(parts[1]);
            
            if (isNaN(hours) || isNaN(minutes)) return null;
            
            return hours * 60 + minutes;
        }

        function minutesToTime(minutes) {
            if (minutes <= 0) return '';
            
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            
            return `${hours}æ™‚é–“${mins.toString().padStart(2, '0')}åˆ†`;
        }

        // æ¬¡ã®æœˆã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function getNextMonth(targetMonth) {
            // "2024å¹´1æœˆ" ã®å½¢å¼ã‹ã‚‰æ¬¡ã®æœˆã‚’è¨ˆç®—
            const match = targetMonth.match(/(\d{4})å¹´(\d{1,2})æœˆ/);
            if (!match) return targetMonth;
            
            let year = parseInt(match[1]);
            let month = parseInt(match[2]);
            
            month++;
            if (month > 12) {
                month = 1;
                year++;
            }
            
            return `${year}å¹´${month}æœˆ`;
        }

        // å¯¾è±¡å¹´æœˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç”¨ã®æ¬¡ã®æœˆã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function getNextMonthForInput(currentMonth) {
            // "2024å¹´1æœˆ" å½¢å¼ã‹ã‚‰ "2024-02" å½¢å¼ã«å¤‰æ›
            const match = currentMonth.match(/(\d{4})å¹´(\d{1,2})æœˆ/);
            if (!match) {
                // æ—¢ã« YYYY-MM å½¢å¼ã®å ´åˆ
                const [year, month] = currentMonth.split('-').map(Number);
                let nextMonth = month + 1;
                let nextYear = year;
                
                if (nextMonth > 12) {
                    nextMonth = 1;
                    nextYear++;
                }
                
                return `${nextYear}-${nextMonth.toString().padStart(2, '0')}`;
            }
            
            let year = parseInt(match[1]);
            let month = parseInt(match[2]);
            
            month++;
            if (month > 12) {
                month = 1;
                year++;
            }
            
            return `${year}-${month.toString().padStart(2, '0')}`;
        }

        // æ¬¡ã®æœˆã®æ—¥ä»˜ã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function getNextMonthDate(currentDate) {
            const date = new Date(currentDate);
            const currentMonth = date.getMonth();
            const currentYear = date.getFullYear();
            const currentDay = date.getDate();
            
            // æ¬¡ã®æœˆã‚’è¨­å®š
            let nextMonth = currentMonth + 1;
            let nextYear = currentYear;
            
            if (nextMonth > 11) {
                nextMonth = 0;
                nextYear++;
            }
            
            // æ¬¡ã®æœˆã®åŒã˜æ—¥ã‚’è¨­å®šï¼ˆæœˆæœ«ã®å ´åˆã¯èª¿æ•´ï¼‰
            const nextDate = new Date(nextYear, nextMonth, currentDay);
            
            // æ—¥ä»˜ãŒæ­£ã—ããªã„å ´åˆï¼ˆä¾‹ï¼š1/31 â†’ 2/31ã¯2/28ã«ãªã‚‹ï¼‰ã€æœˆæœ«ã«èª¿æ•´
            if (nextDate.getMonth() !== nextMonth) {
                nextDate.setDate(0); // å‰æœˆã®æœ€çµ‚æ—¥
            }
            
            return nextDate.toISOString().split('T')[0];
        }

        function updateSummary() {
            const container = document.getElementById('summaryCards');
            const isPartTime = document.getElementById('employmentType').value === 'parttime';
            
            let summaryHTML = `
                <div class="summary-card">
                    <h4 class="text-sm opacity-80 mb-2">å‡ºå‹¤æ—¥æ•°</h4>
                    <div class="text-2xl font-bold">${summaryData.workDays}æ—¥</div>
                </div>
                <div class="summary-card">
                    <h4 class="text-sm opacity-80 mb-2">ä¼‘æ—¥å‡ºå‹¤æ—¥æ•°</h4>
                    <div class="text-2xl font-bold">${summaryData.holidayWorkDays}æ—¥</div>
                </div>
                <div class="summary-card">
                    <h4 class="text-sm opacity-80 mb-2">ç·æ®‹æ¥­æ™‚é–“</h4>
                    <div class="text-2xl font-bold">${minutesToTime(summaryData.totalOvertimeMinutes)}</div>
                </div>
                <div class="summary-card">
                    <h4 class="text-sm opacity-80 mb-2">ç·æ®‹æ¥­è²»ç”¨</h4>
                    <div class="text-2xl font-bold">Â¥${summaryData.totalOvertimeCost.toLocaleString()}</div>
                </div>
            `;

            if (!isPartTime) {
                summaryHTML += `
                    <div class="summary-card">
                        <h4 class="text-sm opacity-80 mb-2">ç·å®Ÿåƒæ™‚é–“</h4>
                        <div class="text-2xl font-bold">${minutesToTime(summaryData.totalWorkMinutes)}</div>
                    </div>
                `;
            }
            
            // Add taxable, non-taxable, and total salary cards
            summaryHTML += `
                <div class="summary-card" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);">
                    <h4 class="text-sm opacity-80 mb-2">èª²ç¨å¯¾è±¡æ”¯çµ¦é¡</h4>
                    <div class="text-2xl font-bold">Â¥${summaryData.taxableAmount.toLocaleString()}</div>
                </div>
                <div class="summary-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    <h4 class="text-sm opacity-80 mb-2">éèª²ç¨æ”¯çµ¦é¡</h4>
                    <div class="text-2xl font-bold">Â¥${summaryData.nonTaxableAmount.toLocaleString()}</div>
                </div>
                <div class="summary-card" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                    <h4 class="text-sm opacity-80 mb-2">ç·æ”¯çµ¦é¡</h4>
                    <div class="text-2xl font-bold">Â¥${summaryData.totalSalary.toLocaleString()}</div>
                </div>
            `;

            container.innerHTML = summaryHTML;
        }

        function updateCalculationFormula() {
            const container = document.getElementById('calculationFormula');
            const isPartTime = document.getElementById('employmentType').value === 'parttime';
            
            if (summaryData.totalWorkMinutes > 0 || summaryData.totalBasicSalary > 0) {
                let formulaContent = '';
                
                if (isPartTime) {
                    const regularHourlyWage = parseInt(document.getElementById('regularHourlyWage').value) || 1000;
                    const overtimeHourlyWage = parseInt(document.getElementById('overtimeHourlyWage').value) || 1250;
                    const allowancesData = getAllowancesData('parttime');
                    const totalHours = (summaryData.totalWorkMinutes / 60).toFixed(2);
                    const overtimeHours = (summaryData.totalOvertimeMinutes / 60).toFixed(2);
                    
                    let taxableDisplay = '';
                    taxableDisplay += `<div class="text-indigo-600 font-semibold">ã€èª²ç¨å¯¾è±¡æ”¯çµ¦é¡ã€‘</div>`;
                    taxableDisplay += `<div>åŸºæœ¬çµ¦ = ${totalHours}æ™‚é–“ Ã— ${regularHourlyWage}å†† = Â¥${summaryData.totalBasicSalary.toLocaleString()}</div>`;
                    taxableDisplay += `<div>æ®‹æ¥­ä»£ = ${overtimeHours}æ™‚é–“ Ã— ${overtimeHourlyWage}å†† = Â¥${summaryData.totalOvertimeCost.toLocaleString()}</div>`;
                    
                    if (allowancesData.length > 0) {
                        allowancesData.forEach(allowance => {
                            if (allowance.name || allowance.amount > 0) {
                                const displayName = allowance.name || 'èª¿æ•´æ‰‹å½“';
                                taxableDisplay += `<div>${displayName} = Â¥${allowance.amount.toLocaleString()}</div>`;
                            }
                        });
                    }
                    
                    // ç‰¹åˆ¥æ—¥å½“ã®è©³ç´°è¡¨ç¤ºã‚’è¿½åŠ 
                    if (summaryData.totalSpecialAllowance > 0) {
                        let specialAllowanceDetails = [];
                        processedData.forEach(row => {
                            if (row.specialAllowance && parseInt(row.specialAllowance) > 0) {
                                specialAllowanceDetails.push(`${row.date}: Â¥${parseInt(row.specialAllowance).toLocaleString()}`);
                            }
                        });
                        const detailsText = specialAllowanceDetails.length > 0 ? ` (${specialAllowanceDetails.join(', ')})` : '';
                        taxableDisplay += `<div>ç‰¹åˆ¥æ—¥å½“åˆè¨ˆ = Â¥${summaryData.totalSpecialAllowance.toLocaleString()}${detailsText}</div>`;
                    }
                    
                    let nonTaxableDisplay = '';
                    nonTaxableDisplay += `<div class="text-emerald-600 font-semibold mt-2">ã€éèª²ç¨æ”¯çµ¦é¡ã€‘</div>`;
                    // é€šå‹¤æ‰‹å½“ã®è¡¨ç¤ºï¼šæ—¥é¡ã‹æœˆé¡ã‹ã‚’åˆ¤å®š
                    if (summaryData.commutingAllowanceDaily > 0) {
                        nonTaxableDisplay += `<div>é€šå‹¤æ‰‹å½“åˆè¨ˆ = Â¥${summaryData.commutingAllowanceDaily.toLocaleString()}/æ—¥ Ã— ${summaryData.workDays}æ—¥ = Â¥${summaryData.nonTaxableAmount.toLocaleString()}</div>`;
                    } else {
                        nonTaxableDisplay += `<div>é€šå‹¤æ‰‹å½“åˆè¨ˆ = Â¥${summaryData.nonTaxableAmount.toLocaleString()}</div>`;
                    }
                    
                    formulaContent = `
                        <div class="space-y-2 font-mono text-sm">
                            ${taxableDisplay}
                            <div class="text-indigo-600 font-semibold">èª²ç¨å¯¾è±¡æ”¯çµ¦é¡è¨ˆ = Â¥${summaryData.taxableAmount.toLocaleString()}</div>
                            ${nonTaxableDisplay}
                            <div class="text-emerald-600 font-semibold">éèª²ç¨æ”¯çµ¦é¡è¨ˆ = Â¥${summaryData.nonTaxableAmount.toLocaleString()}</div>
                            <div class="border-t border-white/30 pt-2 font-bold text-lg text-purple-600">
                                ç·æ”¯çµ¦é¡ = Â¥${summaryData.taxableAmount.toLocaleString()} + Â¥${summaryData.nonTaxableAmount.toLocaleString()} = Â¥${summaryData.totalSalary.toLocaleString()}
                            </div>
                        </div>
                    `;
                } else {
                    const monthlyBaseSalary = parseInt(document.getElementById('baseSalary').value) || 200000;
                    const overtimeHourlyWage = parseInt(document.getElementById('fulltimeOvertimeHourlyWage').value) || 1500;
                    const allowancesData = getAllowancesData('fulltime');
                    const overtimeHours = (summaryData.totalOvertimeMinutes / 60).toFixed(2);
                    
                    let taxableDisplay = '';
                    taxableDisplay += `<div class="text-indigo-600 font-semibold">ã€èª²ç¨å¯¾è±¡æ”¯çµ¦é¡ã€‘</div>`;
                    taxableDisplay += `<div>åŸºæœ¬çµ¦ = Â¥${monthlyBaseSalary.toLocaleString()}</div>`;
                    taxableDisplay += `<div>æ®‹æ¥­ä»£ = ${overtimeHours}æ™‚é–“ Ã— ${overtimeHourlyWage}å†† = Â¥${summaryData.totalOvertimeCost.toLocaleString()}</div>`;
                    
                    if (allowancesData.length > 0) {
                        allowancesData.forEach(allowance => {
                            if (allowance.name || allowance.amount > 0) {
                                const displayName = allowance.name || 'èª¿æ•´æ‰‹å½“';
                                taxableDisplay += `<div>${displayName} = Â¥${allowance.amount.toLocaleString()}</div>`;
                            }
                        });
                    }
                    
                    // ç‰¹åˆ¥æ—¥å½“ã®è©³ç´°è¡¨ç¤ºã‚’è¿½åŠ 
                    if (summaryData.totalSpecialAllowance > 0) {
                        let specialAllowanceDetails = [];
                        processedData.forEach(row => {
                            if (row.specialAllowance && parseInt(row.specialAllowance) > 0) {
                                specialAllowanceDetails.push(`${row.date}: Â¥${parseInt(row.specialAllowance).toLocaleString()}`);
                            }
                        });
                        const detailsText = specialAllowanceDetails.length > 0 ? ` (${specialAllowanceDetails.join(', ')})` : '';
                        taxableDisplay += `<div>ç‰¹åˆ¥æ—¥å½“åˆè¨ˆ = Â¥${summaryData.totalSpecialAllowance.toLocaleString()}${detailsText}</div>`;
                    }
                    
                    let nonTaxableDisplay = '';
                    nonTaxableDisplay += `<div class="text-emerald-600 font-semibold mt-2">ã€éèª²ç¨æ”¯çµ¦é¡ã€‘</div>`;
                    nonTaxableDisplay += `<div>é€šå‹¤æ‰‹å½“åˆè¨ˆ = Â¥${summaryData.nonTaxableAmount.toLocaleString()}</div>`;
                    
                    formulaContent = `
                        <div class="space-y-2 font-mono text-sm">
                            ${taxableDisplay}
                            <div class="text-indigo-600 font-semibold">èª²ç¨å¯¾è±¡æ”¯çµ¦é¡è¨ˆ = Â¥${summaryData.taxableAmount.toLocaleString()}</div>
                            ${nonTaxableDisplay}
                            <div class="text-emerald-600 font-semibold">éèª²ç¨æ”¯çµ¦é¡è¨ˆ = Â¥${summaryData.nonTaxableAmount.toLocaleString()}</div>
                            <div class="border-t border-white/30 pt-2 font-bold text-lg text-purple-600">
                                ç·æ”¯çµ¦é¡ = Â¥${summaryData.taxableAmount.toLocaleString()} + Â¥${summaryData.nonTaxableAmount.toLocaleString()} = Â¥${summaryData.totalSalary.toLocaleString()}
                            </div>
                        </div>
                    `;
                }
                
                container.innerHTML = `
                    <div class="calculation-box">
                        <h4 class="text-xl font-bold mb-4 flex items-center">
                            <i class="fas fa-calculator mr-2"></i>ç·æ”¯çµ¦é¡è¨ˆç®—å¼
                        </h4>
                        ${formulaContent}
                    </div>
                `;
                container.classList.remove('hidden');
            } else {
                container.classList.add('hidden');
            }
        }

        function updateTable() {
            const table = document.getElementById('resultsTable');
            const isPartTime = document.getElementById('employmentType').value === 'parttime';
            
            let tableHTML = `
                <thead class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white">
                    <tr>
                        <th class="px-4 py-3 text-center">æ—¥ä»˜</th>
                        <th class="px-4 py-3 text-center">æ›œæ—¥</th>
                        <th class="px-4 py-3 text-center">ä¼‘æ—¥å‡ºå‹¤</th>
                        <th class="px-4 py-3 text-center">å‡ºå‹¤æ™‚é–“</th>
                        <th class="px-4 py-3 text-center">é€€å‹¤æ™‚é–“</th>
                        <th class="px-4 py-3 text-center">ä¼‘æ†©æ™‚é–“</th>
                        <th class="px-4 py-3 text-center">ç‰¹åˆ¥æ—¥å½“</th>
                        <th class="px-4 py-3 text-center">å®Ÿåƒæ™‚é–“</th>
                        <th class="px-4 py-3 text-center">æ®‹æ¥­æ™‚é–“</th>
                        <th class="px-4 py-3 text-center">æ®‹æ¥­è²»ç”¨</th>
            `;

            if (isPartTime) {
                tableHTML += '<th class="px-4 py-3 text-center">åŸºæœ¬çµ¦</th>';
            }

            tableHTML += `
                    </tr>
                </thead>
                <tbody>
            `;

            processedData.forEach((row, index) => {
                const bgClass = index % 2 === 0 ? 'bg-gray-50' : 'bg-white';
                const startTimeDisplay = row.startTime || '';
                const endTimeDisplay = row.endTime || '';
                
                // Determine CSS class based on whether time is set or not
                const startTimeClass = startTimeDisplay ? 'editable-time' : 'editable-time-unset';
                const endTimeClass = endTimeDisplay ? 'editable-time' : 'editable-time-unset';
                const startTimeText = startTimeDisplay || 'æœªè¨­å®š';
                const endTimeText = endTimeDisplay || 'æœªè¨­å®š';
                
                tableHTML += `
                    <tr class="${bgClass} hover:bg-blue-50 transition-colors">
                        <td class="px-4 py-3 text-center">${row.date}</td>
                        <td class="px-4 py-3 text-center">${row.dayOfWeek}</td>
                        <td class="px-4 py-3 text-center">
                            <input type="checkbox" class="holiday-checkbox" data-row="${row.index}" onchange="updateHolidayWork(this)" ${row.isHolidayWork ? 'checked' : ''}>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <span class="${startTimeClass}" data-row="${row.index}" data-field="startTime" onclick="editTime(this)" title="ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ™‚é–“ã‚’ç·¨é›†">${startTimeText}</span>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <span class="${endTimeClass}" data-row="${row.index}" data-field="endTime" onclick="editTime(this)" title="ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ™‚é–“ã‚’ç·¨é›†">${endTimeText}</span>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <span class="${row.breakDuration ? 'editable-time' : 'editable-time-unset'}" data-row="${row.index}" data-field="breakDuration" onclick="editBreakDuration(this)" title="ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä¼‘æ†©æ™‚é–“ã‚’ç·¨é›†">${row.breakDuration || 'æœªè¨­å®š'}</span>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <span class="${row.specialAllowance ? 'editable-amount' : 'editable-amount-unset'}" data-row="${row.index}" data-field="specialAllowance" onclick="editSpecialAllowance(this)" title="ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç‰¹åˆ¥æ—¥å½“ã‚’ç·¨é›†">${row.specialAllowance || 'æœªè¨­å®š'}</span>
                        </td>
                        <td class="px-4 py-3 text-center">${row.actualWorkTime}</td>
                        <td class="px-4 py-3 text-center">${row.overtimeHours}</td>
                        <td class="px-4 py-3 text-center">${row.overtimeCost > 0 ? 'Â¥' + row.overtimeCost.toLocaleString() : ''}</td>
                `;

                if (isPartTime) {
                    tableHTML += `<td class="px-4 py-3 text-center">${row.basicSalary > 0 ? 'Â¥' + row.basicSalary.toLocaleString() : ''}</td>`;
                }

                tableHTML += '</tr>';
            });

            tableHTML += '</tbody>';
            table.innerHTML = tableHTML;
        }

        function updateHolidayWork(checkbox) {
            const rowIndex = parseInt(checkbox.dataset.row);
            
            if (rowIndex >= 0 && rowIndex < allPeriodData.length) {
                allPeriodData[rowIndex].isHolidayWork = checkbox.checked;
                
                // Update csvData to maintain consistency
                csvData = [...allPeriodData];
                
                // Trigger recalculation
                processData();
                
                const dateStr = allPeriodData[rowIndex].date;
                const status = checkbox.checked ? 'ON' : 'OFF';
                showMessage(`${dateStr} ã®ä¼‘æ—¥å‡ºå‹¤ã‚’${status}ã«è¨­å®šã—ã¾ã—ãŸ`, 'success');
            }
        }

        // Enhanced manual editing functionality with proper calculation linking
        function editTime(element) {
            const currentValue = element.textContent.trim();
            const displayValue = currentValue === 'æœªè¨­å®š' ? '' : currentValue;
            
            // Create simple time input
            const input = document.createElement('input');
            input.type = 'time';
            input.value = displayValue;
            input.className = 'time-input';
            
            // Add event listeners for simple interaction
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveTimeEdit(element, this.value);
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelTimeEdit(element, currentValue);
                }
            });
            
            input.addEventListener('blur', function(e) {
                // Small delay to prevent conflicts
                setTimeout(() => {
                    if (document.contains(this)) {
                        saveTimeEdit(element, this.value);
                    }
                }, 100);
            });
            
            // Replace element content with input
            element.innerHTML = '';
            element.appendChild(input);
            
            // Focus and select
            input.focus();
            input.select();
        }

        function saveTimeEdit(element, newValue) {
            const rowIndex = parseInt(element.dataset.row);
            const field = element.dataset.field;
            
            // Validate row index
            if (rowIndex < 0 || rowIndex >= allPeriodData.length) {
                showMessage('ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ç„¡åŠ¹ãªè¡Œã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹', 'error');
                cancelTimeEdit(element, element.textContent || 'æœªè¨­å®š');
                return;
            }
            
            // Update data in allPeriodData (primary data source)
            if (allPeriodData[rowIndex] !== undefined) {
                const oldValue = allPeriodData[rowIndex][field];
                allPeriodData[rowIndex][field] = newValue;
                
                // Also update original CSV data if it exists
                const normalizeDate = (dateStr) => {
                    if (!dateStr) return '';
                    
                    if (dateStr.match(/^\d{4}\/\d{1,2}\/\d{1,2}$/)) {
                        const parts = dateStr.split('/');
                        return parts[0] + '-' + parts[1].padStart(2, '0') + '-' + parts[2].padStart(2, '0');
                    } else if (dateStr.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                        const parts = dateStr.split('/');
                        return parts[2] + '-' + parts[0].padStart(2, '0') + '-' + parts[1].padStart(2, '0');
                    } else if (dateStr.match(/^\d{4}-\d{1,2}-\d{1,2}$/)) {
                        const parts = dateStr.split('-');
                        return parts[0] + '-' + parts[1].padStart(2, '0') + '-' + parts[2].padStart(2, '0');
                    }
                    return dateStr;
                };
                
                const originalRow = originalCsvData.find(row => {
                    return normalizeDate(row.date) === normalizeDate(allPeriodData[rowIndex].date);
                });
                
                if (originalRow) {
                    originalRow[field] = newValue;
                }
                
                // Update csvData to maintain consistency
                csvData = [...allPeriodData];
                
                try {
                    // Trigger full recalculation
                    processData();
                    
                    // Show confirmation message
                    const fieldName = field === 'startTime' ? 'å‡ºå‹¤æ™‚é–“' : 'é€€å‹¤æ™‚é–“';
                    const timeDisplay = newValue || 'æœªè¨­å®š';
                    showMessage(`âœ… ${allPeriodData[rowIndex].date} ã®${fieldName}ã‚’ã€Œ${timeDisplay}ã€ã«æ›´æ–°ã—ã¾ã—ãŸ`, 'success');
                    
                } catch (error) {
                    // Rollback on error
                    allPeriodData[rowIndex][field] = oldValue;
                    if (originalRow) {
                        originalRow[field] = oldValue;
                    }
                    csvData = [...allPeriodData];
                    processData();
                    
                    showMessage('è¨ˆç®—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
                }
                
            } else {
                showMessage('ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                cancelTimeEdit(element, element.textContent || 'æœªè¨­å®š');
            }
        }

        function cancelTimeEdit(element, originalValue) {
            element.innerHTML = originalValue;
        }

        function exportToExcel() {
            if (processedData.length === 0) {
                showMessage('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            // Get employee basic settings
            const employeeName = document.getElementById('employeeName').value || 'å¾“æ¥­å“¡';
            const targetMonth = document.getElementById('targetMonth').value;
            const isPartTime = document.getElementById('employmentType').value === 'parttime';
            const employmentType = isPartTime ? 'ãƒ‘ãƒ¼ãƒˆ' : 'å¸¸å‹¤';
            
            // Get wage and allowance settings based on employment type
            let wageSettings = {};
            try {
                if (isPartTime) {
                    wageSettings = {
                        regularWage: document.getElementById('regularHourlyWage').value,
                        overtimeWage: document.getElementById('overtimeHourlyWage').value,
                        commutingAllowanceMonthly: document.getElementById('parttimeCommutingAllowanceMonthly').value,
                        commutingAllowanceDaily: document.getElementById('parttimeCommutingAllowance').value,
                        adjustmentAllowances: getAllowancesData('parttime') || []
                    };
                } else {
                    wageSettings = {
                        baseSalary: document.getElementById('baseSalary').value,
                        overtimeWage: document.getElementById('fulltimeOvertimeHourlyWage').value,
                        commutingAllowanceMonthly: document.getElementById('fulltimeCommutingAllowance').value,
                        commutingAllowanceDaily: document.getElementById('fulltimeCommutingAllowanceDaily').value,
                        adjustmentAllowances: getAllowancesData('fulltime') || []
                    };
                }
            } catch (error) {
                console.error('Error getting wage settings for Excel:', error);
                showMessage('Excelã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
                return;
            }
            
            const totalPaidLeave = document.getElementById('totalPaidLeaveDays').value;
            const usedPaidLeave = document.getElementById('usedPaidLeaveDays').value;
            const remainingPaidLeave = document.getElementById('remainingPaidLeaveDays').value;
            const startDate = document.getElementById('periodStartDate').value;
            const endDate = document.getElementById('periodEndDate').value;
            const fileName = `${employeeName}_${targetMonth.replace('-', '')}_å‹¤å‹™å®Ÿç¸¾è¡¨.xlsx`;

            const workbook = XLSX.utils.book_new();
            
            // Create worksheet data with employee basic settings
            const worksheetData = [
                ['å‹¤å‹™å®Ÿç¸¾è¡¨'],
                [''],
                ['=== å¾“æ¥­å“¡åŸºæœ¬è¨­å®š ==='],
                ['æ°å', employeeName],
                ['å¯¾è±¡æœˆ', targetMonth],
                ['å¯¾è±¡æœŸé–“', `${startDate} ï½ ${endDate}`],
                ['å‹¤å‹™å½¢æ…‹', employmentType],
                ['ç· ã‚æ—¥', getClosingDayText()]
            ];
            
            // Add wage settings based on employment type
            if (isPartTime) {
                worksheetData.push(
                    ['æ™‚çµ¦', wageSettings.regularWage + 'å††/æ™‚'],
                    ['æ®‹æ¥­æ™‚çµ¦', wageSettings.overtimeWage + 'å††/æ™‚'],
                    ['é€šå‹¤æ‰‹å½“ï¼ˆæœˆé¡ï¼‰', wageSettings.commutingAllowanceMonthly + 'å††'],
                    ['é€šå‹¤æ‰‹å½“ï¼ˆæ—¥é¡ï¼‰', wageSettings.commutingAllowanceDaily + 'å††']
                );
                // Add multiple adjustment allowances
                wageSettings.adjustmentAllowances.forEach((allowance, index) => {
                    if (allowance.name || allowance.amount > 0) {
                        worksheetData.push(
                            [`èª¿æ•´æ‰‹å½“${index + 1}å`, allowance.name],
                            [`èª¿æ•´æ‰‹å½“${index + 1}é¡`, allowance.amount + 'å††']
                        );
                    }
                });
            } else {
                worksheetData.push(
                    ['åŸºæœ¬çµ¦', wageSettings.baseSalary + 'å††/æœˆ'],
                    ['æ®‹æ¥­æ™‚çµ¦', wageSettings.overtimeWage + 'å††/æ™‚'],
                    ['é€šå‹¤æ‰‹å½“ï¼ˆæœˆé¡ï¼‰', wageSettings.commutingAllowanceMonthly + 'å††'],
                    ['é€šå‹¤æ‰‹å½“ï¼ˆæ—¥é¡ï¼‰', wageSettings.commutingAllowanceDaily + 'å††']
                );
                // Add multiple adjustment allowances
                wageSettings.adjustmentAllowances.forEach((allowance, index) => {
                    if (allowance.name || allowance.amount > 0) {
                        worksheetData.push(
                            [`èª¿æ•´æ‰‹å½“${index + 1}å`, allowance.name],
                            [`èª¿æ•´æ‰‹å½“${index + 1}é¡`, allowance.amount + 'å††']
                        );
                    }
                });
            }
            
            // Add paid leave settings
            worksheetData.push(
                ['æœ‰çµ¦æ—¥æ•°', totalPaidLeave + 'æ—¥'],
                ['ä»Šå¹´åº¦æœ‰çµ¦å–å¾—æ—¥', usedPaidLeave + 'æ—¥'],
                ['æ®‹ã‚Šæœ‰çµ¦æ—¥æ•°', remainingPaidLeave + 'æ—¥'],
                [''],
                ['=== æ›œæ—¥åˆ¥è©³ç´°è¨­å®š ==='],
                ['æ›œæ—¥', 'æ®‹æ¥­é–‹å§‹æ™‚é–“', 'ä¼‘æ†©æ™‚é–“(åˆ†)', 'æ®‹æ¥­å˜ä¾¡(å††/æ™‚)']
            );

            // Add day settings data
            const days = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'];
            days.forEach(day => {
                worksheetData.push([
                    day,
                    daySettings[day].overtimeStart,
                    daySettings[day].breakTime,
                    daySettings[day].overtimeRate
                ]);
            });

            worksheetData.push(['']);

            worksheetData.push(
                [''],
                ['ã‚µãƒãƒªãƒ¼'],
                ['å‡ºå‹¤æ—¥æ•°', summaryData.workDays + 'æ—¥'],
                ['ä¼‘æ—¥å‡ºå‹¤æ—¥æ•°', summaryData.holidayWorkDays + 'æ—¥'],
                ['ç·æ®‹æ¥­æ™‚é–“', minutesToTime(summaryData.totalOvertimeMinutes)],
                ['ç·æ®‹æ¥­è²»ç”¨', 'Â¥' + summaryData.totalOvertimeCost.toLocaleString()]
            );

            if (!isPartTime) {
                worksheetData.push(['ç·å®Ÿåƒæ™‚é–“', minutesToTime(summaryData.totalWorkMinutes)]);
            }
            
            // Add taxable/non-taxable breakdown
            worksheetData.push(
                [''],
                ['èª²ç¨å¯¾è±¡æ”¯çµ¦é¡', 'Â¥' + summaryData.taxableAmount.toLocaleString()],
                ['éèª²ç¨æ”¯çµ¦é¡', 'Â¥' + summaryData.nonTaxableAmount.toLocaleString()],
                ['ç·æ”¯çµ¦é¡', 'Â¥' + summaryData.totalSalary.toLocaleString()]
            );

            // Add detailed salary calculation formula
            worksheetData.push(
                [''],
                ['=== ç·æ”¯çµ¦é¡è¨ˆç®—å¼ ===']
            );
            
            // Add calculation details based on employment type
            if (isPartTime) {
                const regularHourlyWage = parseInt(document.getElementById('regularHourlyWage').value) || 1000;
                const overtimeHourlyWage = parseInt(document.getElementById('overtimeHourlyWage').value) || 1250;
                const allowancesData = getAllowancesData('parttime');
                const totalHours = (summaryData.totalWorkMinutes / 60).toFixed(2);
                const overtimeHours = (summaryData.totalOvertimeMinutes / 60).toFixed(2);
                
                worksheetData.push(['ã€èª²ç¨å¯¾è±¡æ”¯çµ¦é¡ã€‘']);
                worksheetData.push(['åŸºæœ¬çµ¦', `${totalHours}æ™‚é–“ Ã— ${regularHourlyWage}å†† = Â¥${summaryData.totalBasicSalary.toLocaleString()}`]);
                worksheetData.push(['æ®‹æ¥­ä»£', `${overtimeHours}æ™‚é–“ Ã— ${overtimeHourlyWage}å†† = Â¥${summaryData.totalOvertimeCost.toLocaleString()}`]);
                
                if (allowancesData.length > 0) {
                    allowancesData.forEach(allowance => {
                        if (allowance.name || allowance.amount > 0) {
                            const displayName = allowance.name || 'èª¿æ•´æ‰‹å½“';
                            worksheetData.push([displayName, `Â¥${allowance.amount.toLocaleString()}`]);
                        }
                    });
                }
                
                // ç‰¹åˆ¥æ—¥å½“ã®åˆè¨ˆã‚’è¿½åŠ 
                if (summaryData.totalSpecialAllowance > 0) {
                    // ç‰¹åˆ¥æ—¥å½“ã®è©³ç´°è¨ˆç®—å¼ã‚’è¡¨ç¤º
                    let specialAllowanceDetails = [];
                    processedData.forEach(row => {
                        if (row.specialAllowance && parseInt(row.specialAllowance) > 0) {
                            specialAllowanceDetails.push(`${row.date}: Â¥${parseInt(row.specialAllowance).toLocaleString()}`);
                        }
                    });
                    const detailsText = specialAllowanceDetails.length > 0 ? ` (${specialAllowanceDetails.join(', ')})` : '';
                    worksheetData.push(['ç‰¹åˆ¥æ—¥å½“åˆè¨ˆ', `Â¥${summaryData.totalSpecialAllowance.toLocaleString()}${detailsText}`]);
                }
                
                worksheetData.push(['èª²ç¨å¯¾è±¡æ”¯çµ¦é¡è¨ˆ', `Â¥${summaryData.taxableAmount.toLocaleString()}`]);
                worksheetData.push(['']);
                worksheetData.push(['ã€éèª²ç¨æ”¯çµ¦é¡ã€‘']);
                // é€šå‹¤æ‰‹å½“ã®è¡¨ç¤ºï¼šæ—¥é¡ã‹æœˆé¡ã‹ã‚’åˆ¤å®šã—ã¦è¡¨ç¤º
                if (summaryData.commutingAllowanceDaily > 0) {
                    worksheetData.push(['é€šå‹¤æ‰‹å½“åˆè¨ˆ', `Â¥${summaryData.commutingAllowanceDaily.toLocaleString()}/æ—¥ Ã— ${summaryData.workDays}æ—¥ = Â¥${summaryData.nonTaxableAmount.toLocaleString()}`]);
                } else {
                    worksheetData.push(['é€šå‹¤æ‰‹å½“åˆè¨ˆ', `Â¥${summaryData.nonTaxableAmount.toLocaleString()}`]);
                }
                worksheetData.push(['éèª²ç¨æ”¯çµ¦é¡è¨ˆ', `Â¥${summaryData.nonTaxableAmount.toLocaleString()}`]);
            } else {
                const monthlyBaseSalary = parseInt(document.getElementById('baseSalary').value) || 200000;
                const overtimeHourlyWage = parseInt(document.getElementById('fulltimeOvertimeHourlyWage').value) || 1500;
                const allowancesData = getAllowancesData('fulltime');
                const overtimeHours = (summaryData.totalOvertimeMinutes / 60).toFixed(2);
                
                worksheetData.push(['ã€èª²ç¨å¯¾è±¡æ”¯çµ¦é¡ã€‘']);
                worksheetData.push(['åŸºæœ¬çµ¦', `Â¥${monthlyBaseSalary.toLocaleString()}`]);
                worksheetData.push(['æ®‹æ¥­ä»£', `${overtimeHours}æ™‚é–“ Ã— ${overtimeHourlyWage}å†† = Â¥${summaryData.totalOvertimeCost.toLocaleString()}`]);
                
                if (allowancesData.length > 0) {
                    allowancesData.forEach(allowance => {
                        if (allowance.name || allowance.amount > 0) {
                            const displayName = allowance.name || 'èª¿æ•´æ‰‹å½“';
                            worksheetData.push([displayName, `Â¥${allowance.amount.toLocaleString()}`]);
                        }
                    });
                }
                
                // ç‰¹åˆ¥æ—¥å½“ã®åˆè¨ˆã‚’è¿½åŠ 
                if (summaryData.totalSpecialAllowance > 0) {
                    // ç‰¹åˆ¥æ—¥å½“ã®è©³ç´°è¨ˆç®—å¼ã‚’è¡¨ç¤º
                    let specialAllowanceDetails = [];
                    processedData.forEach(row => {
                        if (row.specialAllowance && parseInt(row.specialAllowance) > 0) {
                            specialAllowanceDetails.push(`${row.date}: Â¥${parseInt(row.specialAllowance).toLocaleString()}`);
                        }
                    });
                    const detailsText = specialAllowanceDetails.length > 0 ? ` (${specialAllowanceDetails.join(', ')})` : '';
                    worksheetData.push(['ç‰¹åˆ¥æ—¥å½“åˆè¨ˆ', `Â¥${summaryData.totalSpecialAllowance.toLocaleString()}${detailsText}`]);
                }
                
                worksheetData.push(['èª²ç¨å¯¾è±¡æ”¯çµ¦é¡è¨ˆ', `Â¥${summaryData.taxableAmount.toLocaleString()}`]);
                worksheetData.push(['']);
                worksheetData.push(['ã€éèª²ç¨æ”¯çµ¦é¡ã€‘']);
                // é€šå‹¤æ‰‹å½“ã®è¡¨ç¤ºï¼šæ—¥é¡ã‹æœˆé¡ã‹ã‚’åˆ¤å®šã—ã¦è¡¨ç¤º
                if (summaryData.commutingAllowanceDaily > 0) {
                    worksheetData.push(['é€šå‹¤æ‰‹å½“åˆè¨ˆ', `Â¥${summaryData.commutingAllowanceDaily.toLocaleString()}/æ—¥ Ã— ${summaryData.workDays}æ—¥ = Â¥${summaryData.nonTaxableAmount.toLocaleString()}`]);
                } else {
                    worksheetData.push(['é€šå‹¤æ‰‹å½“åˆè¨ˆ', `Â¥${summaryData.nonTaxableAmount.toLocaleString()}`]);
                }
                worksheetData.push(['éèª²ç¨æ”¯çµ¦é¡è¨ˆ', `Â¥${summaryData.nonTaxableAmount.toLocaleString()}`]);
            }
            
            worksheetData.push(
                [''],
                ['ç·æ”¯çµ¦é¡', `Â¥${summaryData.taxableAmount.toLocaleString()} + Â¥${summaryData.nonTaxableAmount.toLocaleString()} = Â¥${summaryData.totalSalary.toLocaleString()}`]
            );

            // Add headers
            const headerRow = ['æ—¥ä»˜', 'æ›œæ—¥', 'ä¼‘æ—¥å‡ºå‹¤', 'å‡ºå‹¤æ™‚é–“', 'é€€å‹¤æ™‚é–“', 'ä¼‘æ†©æ™‚é–“', 'ç‰¹åˆ¥æ—¥å½“', 'å®Ÿåƒæ™‚é–“', 'æ®‹æ¥­æ™‚é–“', 'æ®‹æ¥­è²»ç”¨'];
            if (isPartTime) {
                headerRow.push('åŸºæœ¬çµ¦');
            }

            worksheetData.push([''], ['è©³ç´°'], headerRow);

            // Add data rows
            processedData.forEach(row => {
                const dataRow = [
                    row.date,
                    row.dayOfWeek,
                    row.isHolidayWork ? 'â—‹' : '',
                    row.startTime,
                    row.endTime,
                    row.breakDuration || '',
                    row.specialAllowance || '',
                    row.actualWorkTime,
                    row.overtimeHours,
                    row.overtimeCost > 0 ? row.overtimeCost : ''
                ];

                if (isPartTime) {
                    dataRow.push(row.basicSalary > 0 ? row.basicSalary : '');
                }

                worksheetData.push(dataRow);
            });

            const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
            XLSX.utils.book_append_sheet(workbook, worksheet, 'å‹¤å‹™å®Ÿç¸¾è¡¨');
            XLSX.writeFile(workbook, fileName);
            
            showMessage('Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ', 'success');
        }

        function exportToCSV() {
            if (processedData.length === 0) {
                showMessage('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
                return;
            }

            // Get employee basic settings
            const employeeName = document.getElementById('employeeName').value || 'å¾“æ¥­å“¡';
            const targetMonth = document.getElementById('targetMonth').value;
            const isPartTime = document.getElementById('employmentType').value === 'parttime';
            const employmentType = isPartTime ? 'ãƒ‘ãƒ¼ãƒˆ' : 'å¸¸å‹¤';
            
            // Get wage and allowance settings based on employment type
            let wageSettings = {};
            try {
                if (isPartTime) {
                    wageSettings = {
                        regularWage: document.getElementById('regularHourlyWage').value,
                        overtimeWage: document.getElementById('overtimeHourlyWage').value,
                        commutingAllowance: document.getElementById('parttimeCommutingAllowance').value,
                        adjustmentAllowances: getAllowancesData('parttime') || []
                    };
                } else {
                    wageSettings = {
                        baseSalary: document.getElementById('baseSalary').value,
                        overtimeWage: document.getElementById('fulltimeOvertimeHourlyWage').value,
                        commutingAllowance: document.getElementById('fulltimeCommutingAllowance').value,
                        adjustmentAllowances: getAllowancesData('fulltime') || []
                    };
                }
            } catch (error) {
                console.error('Error getting wage settings for CSV:', error);
                showMessage('CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
                return;
            }
            
            const totalPaidLeave = document.getElementById('totalPaidLeaveDays').value;
            const usedPaidLeave = document.getElementById('usedPaidLeaveDays').value;
            const remainingPaidLeave = document.getElementById('remainingPaidLeaveDays').value;
            const startDate = document.getElementById('periodStartDate').value;
            const endDate = document.getElementById('periodEndDate').value;
            const fileName = `${employeeName}_${targetMonth.replace('-', '')}_å‹¤å‹™å®Ÿç¸¾è¡¨.csv`;

            let csvContent = '\ufeff'; // BOM for UTF-8
            
            // Add employee basic settings
            csvContent += 'å‹¤å‹™å®Ÿç¸¾è¡¨\n';
            csvContent += '\n';
            csvContent += '=== å¾“æ¥­å“¡åŸºæœ¬è¨­å®š ===\n';
            csvContent += `æ°å,${employeeName}\n`;
            csvContent += `å¯¾è±¡æœˆ,${targetMonth}\n`;
            csvContent += `å¯¾è±¡æœŸé–“,${startDate} ï½ ${endDate}\n`;
            csvContent += `å‹¤å‹™å½¢æ…‹,${employmentType}\n`;
            csvContent += `ç· ã‚æ—¥,${getClosingDayText()}\n`;
            
            // Add wage settings based on employment type
            if (isPartTime) {
                csvContent += `æ™‚çµ¦,${wageSettings.regularWage}å††/æ™‚\n`;
                csvContent += `æ®‹æ¥­æ™‚çµ¦,${wageSettings.overtimeWage}å††/æ™‚\n`;
                csvContent += `é€šå‹¤æ‰‹å½“ï¼ˆæœˆé¡ï¼‰,${wageSettings.commutingAllowanceMonthly}å††\n`;
                csvContent += `é€šå‹¤æ‰‹å½“ï¼ˆæ—¥é¡ï¼‰,${wageSettings.commutingAllowanceDaily}å††\n`;
                // Add multiple adjustment allowances
                wageSettings.adjustmentAllowances.forEach((allowance, index) => {
                    if (allowance.name || allowance.amount > 0) {
                        csvContent += `èª¿æ•´æ‰‹å½“${index + 1}å,${allowance.name}\n`;
                        csvContent += `èª¿æ•´æ‰‹å½“${index + 1}é¡,${allowance.amount}å††\n`;
                    }
                });
            } else {
                csvContent += `åŸºæœ¬çµ¦,${wageSettings.baseSalary}å††/æœˆ\n`;
                csvContent += `æ®‹æ¥­æ™‚çµ¦,${wageSettings.overtimeWage}å††/æ™‚\n`;
                csvContent += `é€šå‹¤æ‰‹å½“ï¼ˆæœˆé¡ï¼‰,${wageSettings.commutingAllowanceMonthly}å††\n`;
                csvContent += `é€šå‹¤æ‰‹å½“ï¼ˆæ—¥é¡ï¼‰,${wageSettings.commutingAllowanceDaily}å††\n`;
                // Add multiple adjustment allowances
                wageSettings.adjustmentAllowances.forEach((allowance, index) => {
                    if (allowance.name || allowance.amount > 0) {
                        csvContent += `èª¿æ•´æ‰‹å½“${index + 1}å,${allowance.name}\n`;
                        csvContent += `èª¿æ•´æ‰‹å½“${index + 1}é¡,${allowance.amount}å††\n`;
                    }
                });
            }
            
            csvContent += `æœ‰çµ¦æ—¥æ•°,${totalPaidLeave}æ—¥\n`;
            csvContent += `ä»Šå¹´åº¦æœ‰çµ¦å–å¾—æ—¥,${usedPaidLeave}æ—¥\n`;
            csvContent += `æ®‹ã‚Šæœ‰çµ¦æ—¥æ•°,${remainingPaidLeave}æ—¥\n`;
            
            // Add day settings
            csvContent += '\n';
            csvContent += '=== æ›œæ—¥åˆ¥è©³ç´°è¨­å®š ===\n';
            csvContent += 'æ›œæ—¥,æ®‹æ¥­é–‹å§‹æ™‚é–“,ä¼‘æ†©æ™‚é–“(åˆ†),æ®‹æ¥­å˜ä¾¡(å††/æ™‚)\n';
            
            const days = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'];
            days.forEach(day => {
                csvContent += `${day},${daySettings[day].overtimeStart},${daySettings[day].breakTime},${daySettings[day].overtimeRate}\n`;
            });
            
            csvContent += '\n';
            csvContent += 'ã‚µãƒãƒªãƒ¼\n';
            csvContent += `å‡ºå‹¤æ—¥æ•°,${summaryData.workDays}æ—¥\n`;
            csvContent += `ä¼‘æ—¥å‡ºå‹¤æ—¥æ•°,${summaryData.holidayWorkDays}æ—¥\n`;
            csvContent += `ç·æ®‹æ¥­æ™‚é–“,${minutesToTime(summaryData.totalOvertimeMinutes)}\n`;
            csvContent += `ç·æ®‹æ¥­è²»ç”¨,Â¥${summaryData.totalOvertimeCost.toLocaleString()}\n`;
            
            if (!isPartTime) {
                csvContent += `ç·å®Ÿåƒæ™‚é–“,${minutesToTime(summaryData.totalWorkMinutes)}\n`;
            }
            
            // Add taxable/non-taxable breakdown
            csvContent += '\n';
            csvContent += `èª²ç¨å¯¾è±¡æ”¯çµ¦é¡,Â¥${summaryData.taxableAmount.toLocaleString()}\n`;
            csvContent += `éèª²ç¨æ”¯çµ¦é¡,Â¥${summaryData.nonTaxableAmount.toLocaleString()}\n`;
            csvContent += `ç·æ”¯çµ¦é¡,Â¥${summaryData.totalSalary.toLocaleString()}\n`;

            // Add detailed salary calculation formula
            csvContent += '\n';
            csvContent += '=== ç·æ”¯çµ¦é¡è¨ˆç®—å¼ ===\n';
            
            // Add calculation details based on employment type
            if (isPartTime) {
                const regularHourlyWage = parseInt(document.getElementById('regularHourlyWage').value) || 1000;
                const overtimeHourlyWage = parseInt(document.getElementById('overtimeHourlyWage').value) || 1250;
                const allowancesData = getAllowancesData('parttime');
                const totalHours = (summaryData.totalWorkMinutes / 60).toFixed(2);
                const overtimeHours = (summaryData.totalOvertimeMinutes / 60).toFixed(2);
                
                csvContent += 'ã€èª²ç¨å¯¾è±¡æ”¯çµ¦é¡ã€‘\n';
                csvContent += `åŸºæœ¬çµ¦,${totalHours}æ™‚é–“ Ã— ${regularHourlyWage}å†† = Â¥${summaryData.totalBasicSalary.toLocaleString()}\n`;
                csvContent += `æ®‹æ¥­ä»£,${overtimeHours}æ™‚é–“ Ã— ${overtimeHourlyWage}å†† = Â¥${summaryData.totalOvertimeCost.toLocaleString()}\n`;
                
                if (allowancesData.length > 0) {
                    allowancesData.forEach(allowance => {
                        if (allowance.name || allowance.amount > 0) {
                            const displayName = allowance.name || 'èª¿æ•´æ‰‹å½“';
                            csvContent += `${displayName},Â¥${allowance.amount.toLocaleString()}\n`;
                        }
                    });
                }
                
                // ç‰¹åˆ¥æ—¥å½“ã®è©³ç´°ã‚’è¿½åŠ 
                if (summaryData.totalSpecialAllowance > 0) {
                    let specialAllowanceDetails = [];
                    processedData.forEach(row => {
                        if (row.specialAllowance && parseInt(row.specialAllowance) > 0) {
                            specialAllowanceDetails.push(`${row.date}: Â¥${parseInt(row.specialAllowance).toLocaleString()}`);
                        }
                    });
                    const detailsText = specialAllowanceDetails.length > 0 ? ` (${specialAllowanceDetails.join(', ')})` : '';
                    csvContent += `ç‰¹åˆ¥æ—¥å½“åˆè¨ˆ,Â¥${summaryData.totalSpecialAllowance.toLocaleString()}${detailsText}\n`;
                }
                
                csvContent += `èª²ç¨å¯¾è±¡æ”¯çµ¦é¡è¨ˆ,Â¥${summaryData.taxableAmount.toLocaleString()}\n`;
                csvContent += '\n';
                csvContent += 'ã€éèª²ç¨æ”¯çµ¦é¡ã€‘\n';
                // é€šå‹¤æ‰‹å½“ã®è¡¨ç¤ºï¼šæ—¥é¡ã‹æœˆé¡ã‹ã‚’åˆ¤å®šã—ã¦è¡¨ç¤º
                if (summaryData.commutingAllowanceDaily > 0) {
                    csvContent += `é€šå‹¤æ‰‹å½“åˆè¨ˆ,Â¥${summaryData.commutingAllowanceDaily.toLocaleString()}/æ—¥ Ã— ${summaryData.workDays}æ—¥ = Â¥${summaryData.nonTaxableAmount.toLocaleString()}\n`;
                } else {
                    csvContent += `é€šå‹¤æ‰‹å½“åˆè¨ˆ,Â¥${summaryData.nonTaxableAmount.toLocaleString()}\n`;
                }
                csvContent += `éèª²ç¨æ”¯çµ¦é¡è¨ˆ,Â¥${summaryData.nonTaxableAmount.toLocaleString()}\n`;
            } else {
                const monthlyBaseSalary = parseInt(document.getElementById('baseSalary').value) || 200000;
                const overtimeHourlyWage = parseInt(document.getElementById('fulltimeOvertimeHourlyWage').value) || 1500;
                const allowancesData = getAllowancesData('fulltime');
                const overtimeHours = (summaryData.totalOvertimeMinutes / 60).toFixed(2);
                
                csvContent += 'ã€èª²ç¨å¯¾è±¡æ”¯çµ¦é¡ã€‘\n';
                csvContent += `åŸºæœ¬çµ¦,Â¥${monthlyBaseSalary.toLocaleString()}\n`;
                csvContent += `æ®‹æ¥­ä»£,${overtimeHours}æ™‚é–“ Ã— ${overtimeHourlyWage}å†† = Â¥${summaryData.totalOvertimeCost.toLocaleString()}\n`;
                
                if (allowancesData.length > 0) {
                    allowancesData.forEach(allowance => {
                        if (allowance.name || allowance.amount > 0) {
                            const displayName = allowance.name || 'èª¿æ•´æ‰‹å½“';
                            csvContent += `${displayName},Â¥${allowance.amount.toLocaleString()}\n`;
                        }
                    });
                }
                
                // ç‰¹åˆ¥æ—¥å½“ã®è©³ç´°ã‚’è¿½åŠ 
                if (summaryData.totalSpecialAllowance > 0) {
                    let specialAllowanceDetails = [];
                    processedData.forEach(row => {
                        if (row.specialAllowance && parseInt(row.specialAllowance) > 0) {
                            specialAllowanceDetails.push(`${row.date}: Â¥${parseInt(row.specialAllowance).toLocaleString()}`);
                        }
                    });
                    const detailsText = specialAllowanceDetails.length > 0 ? ` (${specialAllowanceDetails.join(', ')})` : '';
                    csvContent += `ç‰¹åˆ¥æ—¥å½“åˆè¨ˆ,Â¥${summaryData.totalSpecialAllowance.toLocaleString()}${detailsText}\n`;
                }
                
                csvContent += `èª²ç¨å¯¾è±¡æ”¯çµ¦é¡è¨ˆ,Â¥${summaryData.taxableAmount.toLocaleString()}\n`;
                csvContent += '\n';
                csvContent += 'ã€éèª²ç¨æ”¯çµ¦é¡ã€‘\n';
                // é€šå‹¤æ‰‹å½“ã®è¡¨ç¤ºï¼šæ—¥é¡ã‹æœˆé¡ã‹ã‚’åˆ¤å®šã—ã¦è¡¨ç¤º
                if (summaryData.commutingAllowanceDaily > 0) {
                    csvContent += `é€šå‹¤æ‰‹å½“åˆè¨ˆ,Â¥${summaryData.commutingAllowanceDaily.toLocaleString()}/æ—¥ Ã— ${summaryData.workDays}æ—¥ = Â¥${summaryData.nonTaxableAmount.toLocaleString()}\n`;
                } else {
                    csvContent += `é€šå‹¤æ‰‹å½“åˆè¨ˆ,Â¥${summaryData.nonTaxableAmount.toLocaleString()}\n`;
                }
                csvContent += `éèª²ç¨æ”¯çµ¦é¡è¨ˆ,Â¥${summaryData.nonTaxableAmount.toLocaleString()}\n`;
            }
            
            csvContent += '\n';
            csvContent += `ç·æ”¯çµ¦é¡,Â¥${summaryData.taxableAmount.toLocaleString()} + Â¥${summaryData.nonTaxableAmount.toLocaleString()} = Â¥${summaryData.totalSalary.toLocaleString()}\n`;
            
            csvContent += '\n';
            csvContent += 'è©³ç´°\n';
            
            // Add headers
            let headerLine = 'æ—¥ä»˜,æ›œæ—¥,ä¼‘æ—¥å‡ºå‹¤,å‡ºå‹¤æ™‚é–“,é€€å‹¤æ™‚é–“,ä¼‘æ†©æ™‚é–“,ç‰¹åˆ¥æ—¥å½“,å®Ÿåƒæ™‚é–“,æ®‹æ¥­æ™‚é–“,æ®‹æ¥­è²»ç”¨';
            if (isPartTime) {
                headerLine += ',åŸºæœ¬çµ¦';
            }
            csvContent += headerLine + '\n';

            // Add data
            processedData.forEach(row => {
                let dataLine = [
                    row.date,
                    row.dayOfWeek,
                    row.isHolidayWork ? 'â—‹' : '',
                    row.startTime,
                    row.endTime,
                    row.breakDuration || '',
                    row.specialAllowance || '',
                    row.actualWorkTime,
                    row.overtimeHours,
                    row.overtimeCost > 0 ? row.overtimeCost : ''
                ];

                if (isPartTime) {
                    dataLine.push(row.basicSalary > 0 ? row.basicSalary : '');
                }

                csvContent += dataLine.join(',') + '\n';
            });

            // Download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', fileName);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ', 'success');
        }

        // ä¼‘æ†©æ™‚é–“ã®ç·¨é›†æ©Ÿèƒ½
        function editBreakDuration(element) {
            const currentValue = element.textContent.trim();
            const displayValue = currentValue === 'æœªè¨­å®š' ? '' : currentValue;
            
            // Create input for break duration
            const input = document.createElement('input');
            input.type = 'text';
            input.value = displayValue;
            input.className = 'time-input';
            input.placeholder = 'ä¾‹: 60åˆ†, 1æ™‚é–“30åˆ†';
            
            // Add event listeners
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveBreakDurationEdit(element, this.value);
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelBreakDurationEdit(element, currentValue);
                }
            });
            
            input.addEventListener('blur', function(e) {
                setTimeout(() => {
                    if (document.contains(this)) {
                        saveBreakDurationEdit(element, this.value);
                    }
                }, 100);
            });
            
            // Replace element content with input
            element.innerHTML = '';
            element.appendChild(input);
            
            // Focus and select
            input.focus();
            input.select();
        }

        function saveBreakDurationEdit(element, newValue) {
            const rowIndex = parseInt(element.dataset.row);
            const field = element.dataset.field;
            
            // Validate row index
            if (rowIndex < 0 || rowIndex >= allPeriodData.length) {
                showMessage('ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ç„¡åŠ¹ãªè¡Œã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹', 'error');
                cancelBreakDurationEdit(element, element.textContent || 'æœªè¨­å®š');
                return;
            }
            
            // Update data
            if (allPeriodData[rowIndex] !== undefined) {
                const oldValue = allPeriodData[rowIndex][field];
                allPeriodData[rowIndex][field] = newValue;
                
                // Also update original CSV data if it exists
                const originalRow = originalCsvData.find(row => 
                    normalizeDate(row.date) === normalizeDate(allPeriodData[rowIndex].date)
                );
                
                if (originalRow) {
                    originalRow.breakDuration = newValue;
                    originalRow.breakTime = newValue; // Keep both for compatibility
                }
                
                // Update csvData to maintain consistency
                csvData = [...allPeriodData];
                
                try {
                    // Trigger full recalculation
                    processData();
                    
                    // Show confirmation message
                    const timeDisplay = newValue || 'æœªè¨­å®š';
                    showMessage(`âœ… ${allPeriodData[rowIndex].date} ã®ä¼‘æ†©æ™‚é–“ã‚’ã€Œ${timeDisplay}ã€ã«æ›´æ–°ã—ã¾ã—ãŸ`, 'success');
                    
                } catch (error) {
                    // Rollback on error
                    allPeriodData[rowIndex][field] = oldValue;
                    if (originalRow) {
                        originalRow.breakDuration = oldValue;
                        originalRow.breakTime = oldValue;
                    }
                    csvData = [...allPeriodData];
                    processData();
                    
                    showMessage('è¨ˆç®—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
                }
                
            } else {
                showMessage('ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                cancelBreakDurationEdit(element, element.textContent || 'æœªè¨­å®š');
            }
        }

        function cancelBreakDurationEdit(element, originalValue) {
            element.innerHTML = originalValue;
        }

        function editSpecialAllowance(element) {
            const currentValue = element.textContent.trim();
            const displayValue = currentValue === 'æœªè¨­å®š' ? '' : currentValue;
            
            // Create input for special allowance
            const input = document.createElement('input');
            input.type = 'number';
            input.value = displayValue;
            input.className = 'time-input';
            input.placeholder = 'ä¾‹: 1000';
            input.min = '0';
            input.step = '100';
            
            // Add event listeners
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveSpecialAllowanceEdit(element, this.value);
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelSpecialAllowanceEdit(element, currentValue);
                }
            });
            
            input.addEventListener('blur', function(e) {
                setTimeout(() => {
                    if (document.contains(this)) {
                        saveSpecialAllowanceEdit(element, this.value);
                    }
                }, 100);
            });
            
            // Replace element content with input
            element.innerHTML = '';
            element.appendChild(input);
            
            // Focus and select
            input.focus();
            input.select();
        }

        function saveSpecialAllowanceEdit(element, newValue) {
            const rowIndex = parseInt(element.dataset.row);
            const field = element.dataset.field;
            
            // Validate row index
            if (rowIndex < 0 || rowIndex >= allPeriodData.length) {
                showMessage('ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ç„¡åŠ¹ãªè¡Œã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹', 'error');
                cancelSpecialAllowanceEdit(element, element.textContent || 'æœªè¨­å®š');
                return;
            }
            
            // Validate amount
            const amount = parseInt(newValue) || 0;
            const displayValue = amount > 0 ? amount.toString() : '';
            
            // Update data
            if (allPeriodData[rowIndex] !== undefined) {
                const oldValue = allPeriodData[rowIndex][field];
                allPeriodData[rowIndex][field] = displayValue;
                
                try {
                    // Update display
                    element.innerHTML = displayValue || 'æœªè¨­å®š';
                    element.className = displayValue ? 'editable-amount' : 'editable-amount-unset';
                    
                    // Recalculate data
                    csvData = [...allPeriodData];
                    processData();
                    
                    // Show confirmation message
                    const amountDisplay = displayValue ? `Â¥${parseInt(displayValue).toLocaleString()}` : 'æœªè¨­å®š';
                    showMessage(`âœ… ${allPeriodData[rowIndex].date} ã®ç‰¹åˆ¥æ—¥å½“ã‚’ã€Œ${amountDisplay}ã€ã«æ›´æ–°ã—ã¾ã—ãŸ`, 'success');
                    
                } catch (error) {
                    // Rollback on error
                    allPeriodData[rowIndex][field] = oldValue;
                    csvData = [...allPeriodData];
                    processData();
                    
                    showMessage('è¨ˆç®—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
                }
                
            } else {
                showMessage('ãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                cancelSpecialAllowanceEdit(element, element.textContent || 'æœªè¨­å®š');
            }
        }

        function cancelSpecialAllowanceEdit(element, originalValue) {
            element.innerHTML = originalValue;
        }

        // æ—¥ä»˜æ­£è¦åŒ–ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function normalizeDate(dateStr) {
            if (!dateStr) return '';
            
            if (dateStr.match(/^\d{4}\/\d{1,2}\/\d{1,2}$/)) {
                const parts = dateStr.split('/');
                return parts[0] + '-' + parts[1].padStart(2, '0') + '-' + parts[2].padStart(2, '0');
            } else if (dateStr.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                const parts = dateStr.split('/');
                return parts[2] + '-' + parts[0].padStart(2, '0') + '-' + parts[1].padStart(2, '0');
            } else if (dateStr.match(/^\d{4}-\d{1,2}-\d{1,2}$/)) {
                const parts = dateStr.split('-');
                return parts[0] + '-' + parts[1].padStart(2, '0') + '-' + parts[2].padStart(2, '0');
            }
            return dateStr;
        }

        // ä¼‘æ†©æ™‚é–“ã‚’åˆ†ã«å¤‰æ›ã™ã‚‹é–¢æ•°
        function parseBreakDuration(breakStr) {
            if (!breakStr || breakStr === '' || breakStr === '---') return 0;
            
            breakStr = breakStr.toString().toLowerCase();
            let totalMinutes = 0;
            
            // Handle various formats
            // ä¾‹: "60åˆ†", "1æ™‚é–“30åˆ†", "90", "1.5æ™‚é–“"
            
            // æ™‚é–“ã¨åˆ†ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆ (ä¾‹: "1æ™‚é–“30åˆ†")
            const hoursAndMinutesMatch = breakStr.match(/(\d+(?:\.\d+)?)\s*æ™‚é–“\s*(\d+)\s*åˆ†/);
            if (hoursAndMinutesMatch) {
                const hours = parseFloat(hoursAndMinutesMatch[1]);
                const minutes = parseInt(hoursAndMinutesMatch[2]);
                return Math.round(hours * 60 + minutes);
            }
            
            // æ™‚é–“ã®ã¿ (ä¾‹: "1æ™‚é–“", "1.5æ™‚é–“")
            const hoursOnlyMatch = breakStr.match(/(\d+(?:\.\d+)?)\s*æ™‚é–“/);
            if (hoursOnlyMatch) {
                const hours = parseFloat(hoursOnlyMatch[1]);
                return Math.round(hours * 60);
            }
            
            // åˆ†ã®ã¿ (ä¾‹: "60åˆ†")
            const minutesOnlyMatch = breakStr.match(/(\d+)\s*åˆ†/);
            if (minutesOnlyMatch) {
                return parseInt(minutesOnlyMatch[1]);
            }
            
            // æ•°å­—ã®ã¿ï¼ˆåˆ†ã¨ã—ã¦æ‰±ã†ï¼‰
            const numberMatch = breakStr.match(/^(\d+(?:\.\d+)?)$/);
            if (numberMatch) {
                return Math.round(parseFloat(numberMatch[1]));
            }
            
            return 0;
        }

        function showMessage(message, type) {
            const container = document.getElementById('messageContainer');
            
            // Remove existing messages
            const existingMessage = container.querySelector('.message');
            if (existingMessage) {
                existingMessage.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 transition-all duration-300 ${
                type === 'error' ? 'bg-red-100 border border-red-400 text-red-700' : 'bg-green-100 border border-green-400 text-green-700'
            }`;
            
            messageDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle'} mr-2"></i>
                    <span>${message}</span>
                </div>
            `;

            container.appendChild(messageDiv);

            // Auto remove after 5 seconds
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.remove();
                }
            }, 5000);
        }

        // Multiple Allowances Functions
        function addFulltimeAllowance() {
            const container = document.getElementById('fulltimeAllowancesList');
            const newRow = document.createElement('div');
            newRow.className = 'allowance-row grid grid-cols-1 sm:grid-cols-3 gap-2 items-end';
            newRow.innerHTML = `
                <div>
                    <input type="text" placeholder="æ‰‹å½“å" onchange="recalculateIfNeeded()" class="allowance-name w-full px-3 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                </div>
                <div>
                    <input type="number" value="0" min="0" placeholder="0" onchange="recalculateIfNeeded()" class="allowance-amount w-full px-3 py-2 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                </div>
                <div>
                    <button type="button" onclick="removeFulltimeAllowance(this)" class="bg-red-500 text-white px-2 py-2 rounded text-sm hover:bg-red-600 transition-colors w-full">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            container.appendChild(newRow);
            updateAllowanceDeleteButtons('fulltime');
        }

        function removeFulltimeAllowance(button) {
            button.closest('.allowance-row').remove();
            updateAllowanceDeleteButtons('fulltime');
            recalculateIfNeeded();
        }

        function addParttimeAllowance() {
            const container = document.getElementById('parttimeAllowancesList');
            const newRow = document.createElement('div');
            newRow.className = 'allowance-row grid grid-cols-1 sm:grid-cols-3 gap-2 items-end';
            newRow.innerHTML = `
                <div>
                    <input type="text" placeholder="æ‰‹å½“å" onchange="recalculateIfNeeded()" class="allowance-name w-full px-3 py-2 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent text-sm">
                </div>
                <div>
                    <input type="number" value="0" min="0" placeholder="0" onchange="recalculateIfNeeded()" class="allowance-amount w-full px-3 py-2 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent text-sm">
                </div>
                <div>
                    <button type="button" onclick="removeParttimeAllowance(this)" class="bg-red-500 text-white px-2 py-2 rounded text-sm hover:bg-red-600 transition-colors w-full">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            container.appendChild(newRow);
            updateAllowanceDeleteButtons('parttime');
        }

        function removeParttimeAllowance(button) {
            button.closest('.allowance-row').remove();
            updateAllowanceDeleteButtons('parttime');
            recalculateIfNeeded();
        }

        function updateAllowanceDeleteButtons(type) {
            const container = document.getElementById(type === 'fulltime' ? 'fulltimeAllowancesList' : 'parttimeAllowancesList');
            const rows = container.querySelectorAll('.allowance-row');
            
            rows.forEach((row, index) => {
                const deleteButton = row.querySelector('button');
                if (rows.length === 1) {
                    deleteButton.style.display = 'none';
                } else {
                    deleteButton.style.display = 'block';
                }
            });
        }

        function getAllowancesTotal(type) {
            const container = document.getElementById(type === 'fulltime' ? 'fulltimeAllowancesList' : 'parttimeAllowancesList');
            const rows = container.querySelectorAll('.allowance-row');
            let total = 0;
            
            rows.forEach(row => {
                const amountInput = row.querySelector('.allowance-amount');
                const amount = parseInt(amountInput.value) || 0;
                total += amount;
            });
            
            return total;
        }

        function getAllowancesData(type) {
            const container = document.getElementById(type === 'fulltime' ? 'fulltimeAllowancesList' : 'parttimeAllowancesList');
            const rows = container.querySelectorAll('.allowance-row');
            const allowances = [];
            
            rows.forEach(row => {
                const nameInput = row.querySelector('.allowance-name');
                const amountInput = row.querySelector('.allowance-amount');
                const name = nameInput.value.trim();
                const amount = parseInt(amountInput.value) || 0;
                
                if (name || amount > 0) {
                    allowances.push({ name: name, amount: amount });
                }
            });
            
            return allowances;
        }

        function setAllowanceName(empType, index, name) {
            const containerType = empType === 'parttime' ? 'parttime' : 'fulltime';
            const container = document.getElementById(containerType + 'AllowancesList');
            const rows = container.querySelectorAll('.allowance-row');
            
            // Add rows if necessary
            while (rows.length <= index) {
                if (containerType === 'parttime') {
                    addParttimeAllowance();
                } else {
                    addFulltimeAllowance();
                }
            }
            
            // Update the name
            const targetRow = container.querySelectorAll('.allowance-row')[index];
            if (targetRow) {
                const nameInput = targetRow.querySelector('.allowance-name');
                nameInput.value = name;
            }
        }

        function setAllowanceAmount(empType, index, amount) {
            const containerType = empType === 'parttime' ? 'parttime' : 'fulltime';
            const container = document.getElementById(containerType + 'AllowancesList');
            const rows = container.querySelectorAll('.allowance-row');
            
            // Add rows if necessary
            while (rows.length <= index) {
                if (containerType === 'parttime') {
                    addParttimeAllowance();
                } else {
                    addFulltimeAllowance();
                }
            }
            
            // Update the amount
            const targetRow = container.querySelectorAll('.allowance-row')[index];
            if (targetRow) {
                const amountInput = targetRow.querySelector('.allowance-amount');
                amountInput.value = amount;
            }
        }

        function setAllowancesData(type, allowancesArray) {
            if (!allowancesArray || !Array.isArray(allowancesArray)) return;
            
            const containerType = type === 'parttime' ? 'parttime' : 'fulltime';
            const container = document.getElementById(containerType + 'AllowancesList');
            
            // Clear existing rows first
            const existingRows = container.querySelectorAll('.allowance-row');
            existingRows.forEach(row => row.remove());
            
            // Add allowances from the data
            allowancesArray.forEach((allowance, index) => {
                if (containerType === 'parttime') {
                    addParttimeAllowance();
                } else {
                    addFulltimeAllowance();
                }
                
                if (allowance.name) {
                    setAllowanceName(type, index, allowance.name);
                }
                if (allowance.amount !== undefined) {
                    setAllowanceAmount(type, index, allowance.amount);
                }
            });
            
            // Update delete button visibility
            updateAllowanceDeleteButtons(containerType);
        }

        // Initialize delete button visibility on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateAllowanceDeleteButtons('fulltime');
            updateAllowanceDeleteButtons('parttime');
        });
    </script>
</body>
</html>
